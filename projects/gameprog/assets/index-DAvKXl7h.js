(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const a of n)if(a.type==="childList")for(const i of a.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&s(i)}).observe(document,{childList:!0,subtree:!0});function t(n){const a={};return n.integrity&&(a.integrity=n.integrity),n.referrerPolicy&&(a.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?a.credentials="include":n.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(n){if(n.ep)return;n.ep=!0;const a=t(n);fetch(n.href,a)}})();const k=2*Math.PI,C=5e3,D=5e3,M=new Map;function Q(e){const t=M.get(e);if(t)return t;throw new Error("invalid costume name: "+e)}let U=1;function X(e){const t=`costume_${U++}`;return M.set(t,F(e)),t}function Y(){M.set("bear",B("bear")),M.set("penguin",B("penguin")),M.set("blosh",B("blosh")),M.set("ball",B("ball"))}function B(e){return F(document.getElementById(e))}function F(e){const t=e.width,s=e.height,n=document.createElement("canvas");n.width=t,n.height=s;const a=n.getContext("2d",{willReadFrequently:!0});return a.drawImage(e,0,0),{element:e,bounds:{x:-t/2,y:-s/2,w:t,h:s},canvas:n,ctx:a}}const[f,y]=L(C,D),[,S]=L(C,D),[,W]=L(C,D),I=class I{constructor(t){this.pos={x:0,y:0},this.headingInRadians=0,this.headingOffset=Math.PI/2,this.scale=1,this.masks=new Map,this.changeCostume(t),I.all.add(this)}static get(t){for(const s of this.all)if(s.containsPoint(t))return s;return null}changeCostume(t){this.costume=Q(t)}moveTo(t){this.pos.x=t.x,this.pos.y=t.y}moveBy(t){const s=this.headingInRadians-this.headingOffset;this.pos.x+=t*Math.cos(s),this.pos.y+=t*Math.sin(s)}turnBy(t){this.headingInRadians+=t*Math.PI/180}get heading(){return this.headingInRadians*180/Math.PI}destroy(){I.all.delete(this)}drawOn(t,s=!1){if(t.save(),t.translate(this.pos.x,this.pos.y),t.rotate(this.headingInRadians),t.scale(this.scale,this.scale),t.drawImage(this.costume.canvas,-this.costume.bounds.w/2,-this.costume.bounds.h/2),t.restore(),s){const n=Math.sqrt(this.costume.bounds.w**2+this.costume.bounds.h**2)/2;t.beginPath(),t.fillStyle="blue",t.arc(this.pos.x,this.pos.y,15/2,0,k),t.fill(),t.lineCap="round",t.strokeStyle="blue",t.lineWidth=4;const a=this.headingInRadians-this.headingOffset,i=this.pos.x+this.scale*n*Math.cos(a),h=this.pos.y+this.scale*n*Math.sin(a);t.beginPath(),t.moveTo(this.pos.x,this.pos.y),t.lineTo(i,h),t.stroke();const o=3*Math.PI/4;t.beginPath(),t.moveTo(i,h),t.lineTo(i+15*Math.cos(a+o),h+15*Math.sin(a+o)),t.stroke(),t.beginPath(),t.moveTo(i,h),t.lineTo(i+15*Math.cos(a-o),h+15*Math.sin(a-o)),t.stroke()}}containsPoint(t){return y.clearRect(0,0,f.width,f.height),this.drawOn(y),y.getImageData(t.x,t.y,1,1).data[3]>0}colorAt(t){y.clearRect(0,0,f.width,f.height),this.drawOn(y);const[s,n,a]=y.getImageData(t.x,t.y,1,1).data;return{r:s,g:n,b:a}}colorSees(t,s,n=20){const a=this.fastBoundingBox(),i=Math.max(0,a.x),h=Math.max(0,a.y),o=Math.min(f.width,a.w),r=Math.min(f.height,a.h);if(o<=0||r<=0)return!1;S.clearRect(i,h,o,r),W.clearRect(i,h,o,r),this.drawMaskOn(S,t,n);for(const u of I.all)u!==this&&u.drawMaskOn(W,s,n);const d=S.getImageData(i,h,o,r).data,l=W.getImageData(i,h,o,r).data;for(let u=0;u<d.length;u+=4)if(d[u+3]>0&&l[u+3]>0)return!0;return!1}drawMaskOn(t,s,n){t.save(),t.translate(this.pos.x,this.pos.y),t.rotate(this.headingInRadians),t.scale(this.scale,this.scale),t.globalCompositeOperation="lighter",t.imageSmoothingEnabled=!1,t.drawImage(this.getMask(s,n),-this.costume.bounds.w/2,-this.costume.bounds.h/2),t.restore()}getMask(t,s){const n=this.getMasksByKey(),a=`${t.r}:${t.g}:${t.b}:${s}`;let i=n.get(a);if(i)return i;i=document.createElement("canvas"),i.width=this.costume.bounds.w,i.height=this.costume.bounds.h,n.set(a,i);const h=i.getContext("2d"),o=this.costume.ctx.getImageData(0,0,this.costume.bounds.w,this.costume.bounds.h).data,r=h.createImageData(this.costume.bounds.w,this.costume.bounds.h),d=r.data;for(let l=0;l<o.length;l+=4){const u=o[l],v=o[l+1],x=o[l+2];o[l+3]>0&&Math.abs(u-t.r)<=s&&Math.abs(v-t.g)<=s&&Math.abs(x-t.b)<=s&&(d[l]=255,d[l+1]=255,d[l+2]=255,d[l+3]=255)}return h.putImageData(r,0,0),i}getMasksByKey(){let t=this.masks.get(this.costume.element);return t||(t=new Map,this.masks.set(this.costume.element,t)),t}boundingBox(){y.clearRect(0,0,f.width,f.height),this.drawOn(y);const t=this.fastBoundingBox(),s=Math.max(0,t.x),n=s+t.w,a=Math.max(0,t.y),i=a+t.h,h=y.getImageData(s,a,t.w,t.h).data;let o=1/0,r=1/0,d=-1/0,l=-1/0;for(let x=a;x<i;x++)for(let P=s;P<n;P++){const J=((x-a)*t.w+P-s)*4;h[J+3]>0&&(o=Math.min(o,P),r=Math.min(r,x),d=Math.max(d,P),l=Math.max(l,x))}const u=d-o,v=l-r;return{x:o,y:r,w:u,h:v}}fastBoundingBox(){const{x:t,y:s,w:n,h:a}=this.localBoundingBox(),i=this.localToWorld({x:t,y:s}),h=this.localToWorld({x:t,y:s+a}),o=this.localToWorld({x:t+n,y:s}),r=this.localToWorld({x:t+n,y:s+a}),d=Math.min(i.x,h.x,o.x,r.x),l=Math.min(i.y,h.y,o.y,r.y),u=Math.max(i.x,h.x,o.x,r.x),v=Math.max(i.y,h.y,o.y,r.y);return{x:Math.floor(d),y:Math.floor(l),w:Math.ceil(u-d),h:Math.ceil(v-l)}}localBoundingBox(){return this.costume.bounds}localToWorld(t){let s=t.x*this.scale,n=t.y*this.scale;const a=Math.cos(this.headingInRadians),i=Math.sin(this.headingInRadians),h=s*a-n*i,o=s*i+n*a;return{x:h+this.pos.x,y:o+this.pos.y}}};I.all=new Set;let m=I;function L(e,t){const s=document.createElement("canvas");return s.width=e,s.height=t,[s,s.getContext("2d",{willReadFrequently:!0})]}const V=document.getElementById("ui"),p=document.createElement("canvas");V.appendChild(p);const g=p.getContext("2d");function N(){p.style.width=innerWidth+"px",p.style.height=innerHeight+"px",p.width=innerWidth*devicePixelRatio,p.height=innerHeight*devicePixelRatio,g.scale(devicePixelRatio,devicePixelRatio)}window.addEventListener("resize",N),N();let w=null,$=!1,K=null,E=null,q=null,b=null,A=null,O="",z=0;function Z(e){O=e,z=Date.now()}function j(){if(g.clearRect(0,0,innerWidth,innerHeight),m.all.forEach(e=>e.drawOn(g,c===e)),w&&$&&w.moveBy(2),O.length>0&&Date.now()-z<2e3){g.save(),g.font="20pt sans-serif";const{width:e}=g.measureText(O);g.beginPath(),g.fillStyle="#00ff",g.fillText(O,innerWidth-e-20,innerHeight-20),g.fill(),g.restore()}document.body.style.backgroundColor=b!=null&&b.colorSees({r:255,g:255,b:0},{r:255,g:0,b:0})?"pink":"#eee",requestAnimationFrame(j)}j(),document.addEventListener("DOMContentLoaded",()=>{Y(),b=new m(G(100,100,e=>{e.fillStyle="yellow",e.beginPath(),e.fillRect(0,0,100,100),e.fill()})),b.pos.x=400,b.pos.y=600,A=new m(G(100,100,e=>{e.fillStyle="red",e.beginPath(),e.fillRect(0,0,100,100),e.fill()})),A.pos.x=600,A.pos.y=600,w=new m("bear"),w.pos.x=300,w.pos.y=200,K=new m("penguin"),K.pos.x=430,K.pos.y=300,E=new m("blosh"),E.pos.x=500,E.pos.y=200,E.scale=.2,q=new m("ball"),q.pos.x=800,q.pos.y=400});function G(e,t,s){const n=document.createElement("canvas");n.width=e,n.height=t;const a=n.getContext("2d");return s(a),X(n)}let c=null,R=-1,T=-1,H=0;p.addEventListener("pointermove",e=>{if((R<0||T<0)&&(R=e.x,T=e.y),e.ctrlKey){if(c){const t=Math.atan2(e.y-c.pos.y,e.x-c.pos.x),s=((t-H+Math.PI)%k+k)%k-Math.PI;e.shiftKey?c.headingOffset-=s:c.turnBy(s*180/Math.PI),H=t}}else if(e.shiftKey)c&&(c.pos.x+=e.x-R,c.pos.y+=e.y-T);else if(e.altKey)c&&(c.scale=Math.max(.05,c.scale+(e.x-R)/100));else if(c=m.get(e),c){H=Math.atan2(e.y-c.pos.y,e.x-c.pos.x);const{r:t,g:s,b:n}=c.colorAt(e);Z(`{ r: ${t}, g: ${s}, b: ${n} }`)}R=e.x,T=e.y}),window.addEventListener("keydown",e=>{e.code==="Space"&&c===w&&w!==null&&($=!$)});
