(function(){"use strict";class v{constructor(e,t=0,n,s,i){this.nextSample=e,this.value=t,this.noteOn=n,this.noteOff=s,this.writeSharedState=i,v.newInstanceCollector?.push(this)}static newInstanceCollector=null;static doCollectingNewInstances(e,t){const n=v.newInstanceCollector;v.newInstanceCollector=t;try{return e()}finally{v.newInstanceCollector=n}}static new(e){return typeof e=="function"?new v(e):new v(e.nextSample,e.initialValue,e.noteOn,e.noteOff)}static scalar(e){return v.new({nextSample:()=>e,initialValue:e})}lastFrameIdx=-1;computeSample(e,t){return e!==this.lastFrameIdx&&(this.value=this.nextSample(t)),this.value}}const m=v.scalar;function D(r){const e=r||"";return function(){throw new Error("this method "+e+" is abstract! (it has no implementation in class "+this.constructor.name+")")}}function se(r,e){if(!r)throw new Error(e||"Assertion failed")}function Fe(r,e,t){let n;Object.defineProperty(r,e,{get(){return n||(n=t.call(this)),n}})}function Xt(r){return r&&Object.assign({},r)}function it(r,e){const t=[];for(;e-- >0;)t.push(r());return t}function ot(r,e){return new Array(e+1).join(r)}function Ae(r,e){return it(()=>r,e)}function Ce(r){const e=[];for(let t=0;t<r.length;t++){const n=r[t];r.lastIndexOf(n)!==t&&e.indexOf(n)<0&&e.push(n)}return e}function at(r){const e=[];return r.forEach(t=>{e.indexOf(t)<0&&e.push(t)}),e}function ae(r){const e=r[0];return e===e.toUpperCase()}function ct(r){return!ae(r)}function lt(r,e,t){const n=t||" ";return r.length<e?ot(n,e-r.length)+r:r}function ce(){this.strings=[]}ce.prototype.append=function(r){this.strings.push(r)},ce.prototype.contents=function(){return this.strings.join("")};const ke=r=>String.fromCodePoint(parseInt(r,16));function ut(r){if(r.charAt(0)==="\\")switch(r.charAt(1)){case"b":return"\b";case"f":return"\f";case"n":return`
`;case"r":return"\r";case"t":return"	";case"v":return"\v";case"x":return ke(r.slice(2,4));case"u":return r.charAt(2)==="{"?ke(r.slice(3,-1)):ke(r.slice(2,6));default:return r.charAt(1)}else return r}function Me(r){if(r==null)return String(r);const e=Object.prototype.toString.call(r);try{let t;return r.constructor&&r.constructor.name?t=r.constructor.name:e.indexOf("[object ")===0?t=e.slice(8,-1):t=typeof r,t+": "+JSON.stringify(String(r))}catch{return e}}function pt(r,e="unexpected null value"){if(r==null)throw new Error(e);return r}var er=Object.freeze({__proto__:null,StringBuffer:ce,abstract:D,assert:se,checkNotNull:pt,clone:Xt,copyWithoutDuplicates:at,defineLazyProperty:Fe,getDuplicates:Ce,isLexical:ct,isSyntactic:ae,padLeft:lt,repeat:Ae,repeatFn:it,repeatStr:ot,unescapeCodePoint:ut,unexpectedObjToString:Me});const tr={Lu:/\p{Lu}/u,Ll:/\p{Ll}/u,Lt:/\p{Lt}/u,Lm:/\p{Lm}/u,Lo:/\p{Lo}/u,Nl:/\p{Nl}/u,Nd:/\p{Nd}/u,Mn:/\p{Mn}/u,Mc:/\p{Mc}/u,Pc:/\p{Pc}/u,Zs:/\p{Zs}/u,L:/\p{Letter}/u,Ltmo:/\p{Lt}|\p{Lm}|\p{Lo}/u};class d{constructor(){if(this.constructor===d)throw new Error("PExpr cannot be instantiated -- it's abstract")}withSource(e){return e&&(this.source=e.trimmed()),this}}const P=Object.create(d.prototype),F=Object.create(d.prototype);class N extends d{constructor(e){super(),this.obj=e}}class C extends d{constructor(e,t){super(),this.from=e,this.to=t,this.matchCodePoint=e.length>1||t.length>1}}class k extends d{constructor(e){super(),this.index=e}}class O extends d{constructor(e){super(),this.terms=e}}class we extends O{constructor(e,t,n){const s=e.rules[t].body;super([n,s]),this.superGrammar=e,this.name=t,this.body=n}}class be extends O{constructor(e,t,n,s){const i=e.rules[t].body;super([...n,i,...s]),this.superGrammar=e,this.ruleName=t,this.expansionPos=n.length}}class E extends d{constructor(e){super(),this.factors=e}}class $ extends d{constructor(e){super(),this.expr=e}}class le extends ${}class pe extends ${}class Z extends ${}le.prototype.operator="*",pe.prototype.operator="+",Z.prototype.operator="?",le.prototype.minNumMatches=0,pe.prototype.minNumMatches=1,Z.prototype.minNumMatches=0,le.prototype.maxNumMatches=Number.POSITIVE_INFINITY,pe.prototype.maxNumMatches=Number.POSITIVE_INFINITY,Z.prototype.maxNumMatches=1;class q extends d{constructor(e){super(),this.expr=e}}class B extends d{constructor(e){super(),this.expr=e}}class U extends d{constructor(e){super(),this.expr=e}}class I extends d{constructor(e,t=[]){super(),this.ruleName=e,this.args=t}isSyntactic(){return ae(this.ruleName)}toMemoKey(){return this._memoKey||Object.defineProperty(this,"_memoKey",{value:this.toString()}),this._memoKey}}class L extends d{constructor(e){super(),this.category=e,this.pattern=tr[e]}}function A(r,e){let t;return e?(t=new Error(e.getLineAndColumnMessage()+r),t.shortMessage=r,t.interval=e):t=new Error(r),t}function Te(){return A("Interval sources don't match")}function rr(r){const e=new Error;return Object.defineProperty(e,"message",{enumerable:!0,get(){return r.message}}),Object.defineProperty(e,"shortMessage",{enumerable:!0,get(){return"Expected "+r.getExpectedText()}}),e.interval=r.getInterval(),e}function nr(r,e,t){const n=e?`Grammar ${r} is not declared in namespace '${e}'`:"Undeclared grammar "+r;return A(n,t)}function sr(r,e){return A("Grammar "+r.name+" is already declared in this namespace")}function ir(r){return A(`Grammar '${r.name}' does not support incremental parsing`)}function ht(r,e,t){return A("Rule "+r+" is not declared in grammar "+e,t)}function or(r,e,t){return A("Cannot override rule "+r+" because it is not declared in "+e,t)}function ar(r,e,t){return A("Cannot extend rule "+r+" because it is not declared in "+e,t)}function mt(r,e,t,n){let s="Duplicate declaration for rule '"+r+"' in grammar '"+e+"'";return e!==t&&(s+=" (originally declared in '"+t+"')"),A(s,n)}function ft(r,e,t,n){return A("Wrong number of parameters for rule "+r+" (expected "+e+", got "+t+")",n)}function cr(r,e,t,n){return A("Wrong number of arguments for rule "+r+" (expected "+e+", got "+t+")",n)}function dt(r,e,t){return A("Duplicate parameter names in rule "+r+": "+e.join(", "),t)}function lr(r,e){return A("Invalid parameter to rule "+r+": "+e+" has arity "+e.getArity()+", but parameter expressions must have arity 1",e.source)}const ur="NOTE: A _syntactic rule_ is a rule whose name begins with a capital letter. See https://ohmjs.org/d/svl for more details.";function pr(r,e){return A("Cannot apply syntactic rule "+r+" from here (inside a lexical context)",e.source)}function hr(r){const{ruleName:e}=r;return A(`applySyntactic is for syntactic rules, but '${e}' is a lexical rule. `+ur,r.source)}function mr(r){return A("applySyntactic is not required here (in a syntactic context)",r.source)}function gt(r,e){return A("Incorrect argument type: expected "+r,e.source)}function fr(r){return A("'...' can appear at most once in a rule body",r.source)}function dr(r){const e=r._node;se(e&&e.isNonterminal()&&e.ctorName==="escapeChar_unicodeCodePoint");const t=r.children.slice(1,-1).map(s=>s.source),n=t[0].coverageWith(...t.slice(1));return A(`U+${n.contents} is not a valid Unicode code point`,n)}function vt(r,e){const t=e.length>0?e[e.length-1].args:[];let s="Nullable expression "+r.expr.substituteParams(t)+" is not allowed inside '"+r.operator+"' (possible infinite loop)";if(e.length>0){const i=e.map(o=>new I(o.ruleName,o.args)).join(`
`);s+=`
Application stack (most recent application last):
`+i}return A(s,r.expr.source)}function It(r,e,t,n){return A("Rule "+r+" involves an alternation which has inconsistent arity (expected "+e+", got "+t+")",n.source)}function gr(r){const e=r.map(t=>t.message);return A(["Errors:"].concat(e).join(`
- `),r[0].interval)}function vr(r,e,t,n){let s=n.slice(0,-1).map(u=>{const h="  "+u[0].name+" > "+u[1];return u.length===3?h+" for '"+u[2]+"'":h}).join(`
`);s+=`
  `+e+" > "+r;let i="";r==="_iter"&&(i=[`
NOTE: as of Ohm v16, there is no default action for iteration nodes — see `,"  https://ohmjs.org/d/dsa for details."].join(`
`));const o=[`Missing semantic action for '${r}' in ${t} '${e}'.${i}`,"Action stack (most recent call last):",s].join(`
`),a=A(o);return a.name="missingSemanticAction",a}function Ir(r){if(r.length===1)throw r[0];if(r.length>1)throw gr(r)}function yr(r){let e=0;return r.map(n=>{const s=n.toString();return e=Math.max(e,s.length),s}).map(n=>lt(n,e))}function yt(r,e,t){const n=r.length,s=r.slice(0,t),i=r.slice(t+e.length);return(s+e+i).substr(0,n)}function xr(...r){const e=this,{offset:t}=e,{repeatStr:n}=er,s=new ce;s.append("Line "+e.lineNum+", col "+e.colNum+`:
`);const i=yr([e.prevLine==null?0:e.lineNum-1,e.lineNum,e.nextLine==null?0:e.lineNum+1]),o=(c,l,p)=>{s.append(p+i[c]+" | "+l+`
`)};e.prevLine!=null&&o(0,e.prevLine,"  "),o(1,e.line,"> ");const a=e.line.length;let u=n(" ",a+1);for(let c=0;c<r.length;++c){let l=r[c][0],p=r[c][1];se(l>=0&&l<=p,"range start must be >= 0 and <= end");const f=t-e.colNum+1;l=Math.max(0,l-f),p=Math.min(p-f,a),u=yt(u,n("~",p-l),l)}const h=2+i[1].length+3;return s.append(n(" ",h)),u=yt(u,"^",e.colNum-1),s.append(u.replace(/ +$/,"")+`
`),e.nextLine!=null&&o(2,e.nextLine,"  "),s.contents()}let De=[];function xt(r){De.push(r)}function Sr(r){De.forEach(e=>{e(r)}),De=null}function $e(r,e){let t=1,n=1,s=0,i=0,o=null,a=null,u=-1;for(;s<e;){const l=r.charAt(s++);l===`
`?(t++,n=1,u=i,i=s):l!=="\r"&&n++}let h=r.indexOf(`
`,i);if(h===-1)h=r.length;else{const l=r.indexOf(`
`,h+1);o=l===-1?r.slice(h):r.slice(h,l),o=o.replace(/^\r?\n/,"").replace(/\r$/,"")}u>=0&&(a=r.slice(u,i).replace(/\r?\n$/,""));const c=r.slice(i,h).replace(/\r$/,"");return{offset:e,lineNum:t,colNum:n,line:c,prevLine:a,nextLine:o,toString:xr}}function qe(r,e,...t){return $e(r,e).toString(...t)}const St=(()=>{let r=0;return e=>""+e+r++})();class M{constructor(e,t,n){this.sourceString=e,this.startIdx=t,this.endIdx=n}get contents(){return this._contents===void 0&&(this._contents=this.sourceString.slice(this.startIdx,this.endIdx)),this._contents}get length(){return this.endIdx-this.startIdx}coverageWith(...e){return M.coverage(...e,this)}collapsedLeft(){return new M(this.sourceString,this.startIdx,this.startIdx)}collapsedRight(){return new M(this.sourceString,this.endIdx,this.endIdx)}getLineAndColumn(){return $e(this.sourceString,this.startIdx)}getLineAndColumnMessage(){const e=[this.startIdx,this.endIdx];return qe(this.sourceString,this.startIdx,e)}minus(e){if(this.sourceString!==e.sourceString)throw Te();return this.startIdx===e.startIdx&&this.endIdx===e.endIdx?[]:this.startIdx<e.startIdx&&e.endIdx<this.endIdx?[new M(this.sourceString,this.startIdx,e.startIdx),new M(this.sourceString,e.endIdx,this.endIdx)]:this.startIdx<e.endIdx&&e.endIdx<this.endIdx?[new M(this.sourceString,e.endIdx,this.endIdx)]:this.startIdx<e.startIdx&&e.startIdx<this.endIdx?[new M(this.sourceString,this.startIdx,e.startIdx)]:[this]}relativeTo(e){if(this.sourceString!==e.sourceString)throw Te();return se(this.startIdx>=e.startIdx&&this.endIdx<=e.endIdx,"other interval does not cover this one"),new M(this.sourceString,this.startIdx-e.startIdx,this.endIdx-e.startIdx)}trimmed(){const{contents:e}=this,t=this.startIdx+e.match(/^\s*/)[0].length,n=this.endIdx-e.match(/\s*$/)[0].length;return new M(this.sourceString,t,n)}subInterval(e,t){const n=this.startIdx+e;return new M(this.sourceString,n,n+t)}}M.coverage=function(r,...e){let{startIdx:t,endIdx:n}=r;for(const s of e){if(s.sourceString!==r.sourceString)throw Te();t=Math.min(t,s.startIdx),n=Math.max(n,s.endIdx)}return new M(r.sourceString,t,n)};const _r=65535;class Oe{constructor(e){this.source=e,this.pos=0,this.examinedLength=0}atEnd(){const e=this.pos>=this.source.length;return this.examinedLength=Math.max(this.examinedLength,this.pos+1),e}next(){const e=this.source[this.pos++];return this.examinedLength=Math.max(this.examinedLength,this.pos),e}nextCharCode(){const e=this.next();return e&&e.charCodeAt(0)}nextCodePoint(){const e=this.source.slice(this.pos++).codePointAt(0);return e>_r&&(this.pos+=1),this.examinedLength=Math.max(this.examinedLength,this.pos),e}matchString(e,t){let n;if(t){for(n=0;n<e.length;n++){const s=this.next(),i=e[n];if(s==null||s.toUpperCase()!==i.toUpperCase())return!1}return!0}for(n=0;n<e.length;n++)if(this.next()!==e[n])return!1;return!0}sourceSlice(e,t){return this.source.slice(e,t)}interval(e,t){return new M(this.source,e,t||this.pos)}}class _t{constructor(e,t,n,s,i,o,a){this.matcher=e,this.input=t,this.startExpr=n,this._cst=s,this._cstOffset=i,this._rightmostFailurePosition=o,this._rightmostFailures=a,this.failed()&&(Fe(this,"message",function(){const u="Expected "+this.getExpectedText();return qe(this.input,this.getRightmostFailurePosition())+u}),Fe(this,"shortMessage",function(){const u="expected "+this.getExpectedText(),h=$e(this.input,this.getRightmostFailurePosition());return"Line "+h.lineNum+", col "+h.colNum+": "+u}))}succeeded(){return!!this._cst}failed(){return!this.succeeded()}getRightmostFailurePosition(){return this._rightmostFailurePosition}getRightmostFailures(){if(!this._rightmostFailures){this.matcher.setInput(this.input);const e=this.matcher._match(this.startExpr,{tracing:!1,positionToRecordFailures:this.getRightmostFailurePosition()});this._rightmostFailures=e.getRightmostFailures()}return this._rightmostFailures}toString(){return this.succeeded()?"[match succeeded]":"[match failed at position "+this.getRightmostFailurePosition()+"]"}getExpectedText(){if(this.succeeded())throw new Error("cannot get expected text of a successful MatchResult");const e=new ce;let t=this.getRightmostFailures();t=t.filter(n=>!n.isFluffy());for(let n=0;n<t.length;n++)n>0&&(n===t.length-1?e.append(t.length>2?", or ":" or "):e.append(", ")),e.append(t[n].toString());return e.contents()}getInterval(){const e=this.getRightmostFailurePosition();return new M(this.input,e,e)}}class Ar{constructor(){this.applicationMemoKeyStack=[],this.memo={},this.maxExaminedLength=0,this.maxRightmostFailureOffset=-1,this.currentLeftRecursion=void 0}isActive(e){return this.applicationMemoKeyStack.indexOf(e.toMemoKey())>=0}enter(e){this.applicationMemoKeyStack.push(e.toMemoKey())}exit(){this.applicationMemoKeyStack.pop()}startLeftRecursion(e,t){t.isLeftRecursion=!0,t.headApplication=e,t.nextLeftRecursion=this.currentLeftRecursion,this.currentLeftRecursion=t;const{applicationMemoKeyStack:n}=this,s=n.indexOf(e.toMemoKey())+1,i=n.slice(s);t.isInvolved=function(o){return i.indexOf(o)>=0},t.updateInvolvedApplicationMemoKeys=function(){for(let o=s;o<n.length;o++){const a=n[o];this.isInvolved(a)||i.push(a)}}}endLeftRecursion(){this.currentLeftRecursion=this.currentLeftRecursion.nextLeftRecursion}shouldUseMemoizedResult(e){if(!e.isLeftRecursion)return!0;const{applicationMemoKeyStack:t}=this;for(let n=0;n<t.length;n++){const s=t[n];if(e.isInvolved(s))return!1}return!0}memoize(e,t){return this.memo[e]=t,this.maxExaminedLength=Math.max(this.maxExaminedLength,t.examinedLength),this.maxRightmostFailureOffset=Math.max(this.maxRightmostFailureOffset,t.rightmostFailureOffset),t}clearObsoleteEntries(e,t){if(e+this.maxExaminedLength<=t)return;const{memo:n}=this;this.maxExaminedLength=0,this.maxRightmostFailureOffset=-1,Object.keys(n).forEach(s=>{const i=n[s];e+i.examinedLength>t?delete n[s]:(this.maxExaminedLength=Math.max(this.maxExaminedLength,i.examinedLength),this.maxRightmostFailureOffset=Math.max(this.maxRightmostFailureOffset,i.rightmostFailureOffset))})}}const wr="✗",br="✓",Or="⋅",Er="⇒",Nr="␉",Lr="␊",Rr="␍",Be={succeeded:1,isRootNode:2,isImplicitSpaces:4,isMemoized:8,isHeadOfLeftRecursion:16,terminatesLR:32};function Pr(r){return Ae(" ",r).join("")}function Fr(r,e,t){const n=At(r.slice(e,e+t));return n.length<t?n+Ae(" ",t-n.length).join(""):n}function At(r){return typeof r=="string"?r.replace(/ /g,Or).replace(/\t/g,Nr).replace(/\n/g,Lr).replace(/\r/g,Rr):String(r)}class ie{constructor(e,t,n,s,i,o,a){this.input=e,this.pos=this.pos1=t,this.pos2=n,this.source=new M(e,t,n),this.expr=s,this.bindings=o,this.children=a||[],this.terminatingLREntry=null,this._flags=i?Be.succeeded:0}get displayString(){return this.expr.toDisplayString()}clone(){return this.cloneWithExpr(this.expr)}cloneWithExpr(e){const t=new ie(this.input,this.pos,this.pos2,e,this.succeeded,this.bindings,this.children);return t.isHeadOfLeftRecursion=this.isHeadOfLeftRecursion,t.isImplicitSpaces=this.isImplicitSpaces,t.isMemoized=this.isMemoized,t.isRootNode=this.isRootNode,t.terminatesLR=this.terminatesLR,t.terminatingLREntry=this.terminatingLREntry,t}recordLRTermination(e,t){this.terminatingLREntry=new ie(this.input,this.pos,this.pos2,this.expr,!1,[t],[e]),this.terminatingLREntry.terminatesLR=!0}walk(e,t){let n=e;typeof n=="function"&&(n={enter:n});function s(i,o,a){let u=!0;n.enter&&n.enter.call(t,i,o,a)===ie.prototype.SKIP&&(u=!1),u&&(i.children.forEach(h=>{s(h,i,a+1)}),n.exit&&n.exit.call(t,i,o,a))}this.isRootNode?this.children.forEach(i=>{s(i,null,0)}):s(this,null,0)}toString(){const e=new ce;return this.walk((t,n,s)=>{if(!t)return this.SKIP;if(t.expr.constructor.name!=="Alt"){if(e.append(Fr(t.input,t.pos,10)+Pr(s*2+1)),e.append((t.succeeded?br:wr)+" "+t.displayString),t.isHeadOfLeftRecursion&&e.append(" (LR)"),t.succeeded){const o=At(t.source.contents);e.append(" "+Er+"  "),e.append(typeof o=="string"?'"'+o+'"':o)}e.append(`
`)}}),e.contents()}}ie.prototype.SKIP={},Object.keys(Be).forEach(r=>{const e=Be[r];Object.defineProperty(ie.prototype,r,{get(){return(this._flags&e)!==0},set(t){t?this._flags|=e:this._flags&=~e}})}),d.prototype.allowsSkippingPrecedingSpace=D("allowsSkippingPrecedingSpace"),P.allowsSkippingPrecedingSpace=F.allowsSkippingPrecedingSpace=I.prototype.allowsSkippingPrecedingSpace=N.prototype.allowsSkippingPrecedingSpace=C.prototype.allowsSkippingPrecedingSpace=L.prototype.allowsSkippingPrecedingSpace=function(){return!0},O.prototype.allowsSkippingPrecedingSpace=$.prototype.allowsSkippingPrecedingSpace=U.prototype.allowsSkippingPrecedingSpace=B.prototype.allowsSkippingPrecedingSpace=q.prototype.allowsSkippingPrecedingSpace=k.prototype.allowsSkippingPrecedingSpace=E.prototype.allowsSkippingPrecedingSpace=function(){return!1};let fe;xt(r=>{fe=r});let Ee;d.prototype.assertAllApplicationsAreValid=function(r,e){Ee=0,this._assertAllApplicationsAreValid(r,e)},d.prototype._assertAllApplicationsAreValid=D("_assertAllApplicationsAreValid"),P._assertAllApplicationsAreValid=F._assertAllApplicationsAreValid=N.prototype._assertAllApplicationsAreValid=C.prototype._assertAllApplicationsAreValid=k.prototype._assertAllApplicationsAreValid=L.prototype._assertAllApplicationsAreValid=function(r,e){},U.prototype._assertAllApplicationsAreValid=function(r,e){Ee++,this.expr._assertAllApplicationsAreValid(r,e),Ee--},O.prototype._assertAllApplicationsAreValid=function(r,e){for(let t=0;t<this.terms.length;t++)this.terms[t]._assertAllApplicationsAreValid(r,e)},E.prototype._assertAllApplicationsAreValid=function(r,e){for(let t=0;t<this.factors.length;t++)this.factors[t]._assertAllApplicationsAreValid(r,e)},$.prototype._assertAllApplicationsAreValid=q.prototype._assertAllApplicationsAreValid=B.prototype._assertAllApplicationsAreValid=function(r,e){this.expr._assertAllApplicationsAreValid(r,e)},I.prototype._assertAllApplicationsAreValid=function(r,e,t=!1){const n=e.rules[this.ruleName],s=ae(r)&&Ee===0;if(!n)throw ht(this.ruleName,e.name,this.source);if(!t&&ae(this.ruleName)&&!s)throw pr(this.ruleName,this);const i=this.args.length,o=n.formals.length;if(i!==o)throw cr(this.ruleName,o,i,this.source);const a=fe&&n===fe.rules.applySyntactic;if(fe&&n===fe.rules.caseInsensitive&&!(this.args[0]instanceof N))throw gt('a Terminal (e.g. "abc")',this.args[0]);if(a){const h=this.args[0];if(!(h instanceof I))throw gt("a syntactic rule application",h);if(!ae(h.ruleName))throw hr(h);if(s)throw mr(this)}this.args.forEach(h=>{if(h._assertAllApplicationsAreValid(r,e,a),h.getArity()!==1)throw lr(this.ruleName,h)})},d.prototype.assertChoicesHaveUniformArity=D("assertChoicesHaveUniformArity"),P.assertChoicesHaveUniformArity=F.assertChoicesHaveUniformArity=N.prototype.assertChoicesHaveUniformArity=C.prototype.assertChoicesHaveUniformArity=k.prototype.assertChoicesHaveUniformArity=U.prototype.assertChoicesHaveUniformArity=L.prototype.assertChoicesHaveUniformArity=function(r){},O.prototype.assertChoicesHaveUniformArity=function(r){if(this.terms.length===0)return;const e=this.terms[0].getArity();for(let t=0;t<this.terms.length;t++){const n=this.terms[t];n.assertChoicesHaveUniformArity();const s=n.getArity();if(e!==s)throw It(r,e,s,n)}},we.prototype.assertChoicesHaveUniformArity=function(r){const e=this.terms[0].getArity(),t=this.terms[1].getArity();if(e!==t)throw It(r,t,e,this.terms[0])},E.prototype.assertChoicesHaveUniformArity=function(r){for(let e=0;e<this.factors.length;e++)this.factors[e].assertChoicesHaveUniformArity(r)},$.prototype.assertChoicesHaveUniformArity=function(r){this.expr.assertChoicesHaveUniformArity(r)},q.prototype.assertChoicesHaveUniformArity=function(r){},B.prototype.assertChoicesHaveUniformArity=function(r){this.expr.assertChoicesHaveUniformArity(r)},I.prototype.assertChoicesHaveUniformArity=function(r){},d.prototype.assertIteratedExprsAreNotNullable=D("assertIteratedExprsAreNotNullable"),P.assertIteratedExprsAreNotNullable=F.assertIteratedExprsAreNotNullable=N.prototype.assertIteratedExprsAreNotNullable=C.prototype.assertIteratedExprsAreNotNullable=k.prototype.assertIteratedExprsAreNotNullable=L.prototype.assertIteratedExprsAreNotNullable=function(r){},O.prototype.assertIteratedExprsAreNotNullable=function(r){for(let e=0;e<this.terms.length;e++)this.terms[e].assertIteratedExprsAreNotNullable(r)},E.prototype.assertIteratedExprsAreNotNullable=function(r){for(let e=0;e<this.factors.length;e++)this.factors[e].assertIteratedExprsAreNotNullable(r)},$.prototype.assertIteratedExprsAreNotNullable=function(r){if(this.expr.assertIteratedExprsAreNotNullable(r),this.expr.isNullable(r))throw vt(this,[])},Z.prototype.assertIteratedExprsAreNotNullable=q.prototype.assertIteratedExprsAreNotNullable=B.prototype.assertIteratedExprsAreNotNullable=U.prototype.assertIteratedExprsAreNotNullable=function(r){this.expr.assertIteratedExprsAreNotNullable(r)},I.prototype.assertIteratedExprsAreNotNullable=function(r){this.args.forEach(e=>{e.assertIteratedExprsAreNotNullable(r)})};class je{constructor(e){this.matchLength=e}get ctorName(){throw new Error("subclass responsibility")}numChildren(){return this.children?this.children.length:0}childAt(e){if(this.children)return this.children[e]}indexOfChild(e){return this.children.indexOf(e)}hasChildren(){return this.numChildren()>0}hasNoChildren(){return!this.hasChildren()}onlyChild(){if(this.numChildren()!==1)throw new Error("cannot get only child of a node of type "+this.ctorName+" (it has "+this.numChildren()+" children)");return this.firstChild()}firstChild(){if(this.hasNoChildren())throw new Error("cannot get first child of a "+this.ctorName+" node, which has no children");return this.childAt(0)}lastChild(){if(this.hasNoChildren())throw new Error("cannot get last child of a "+this.ctorName+" node, which has no children");return this.childAt(this.numChildren()-1)}childBefore(e){const t=this.indexOfChild(e);if(t<0)throw new Error("Node.childBefore() called w/ an argument that is not a child");if(t===0)throw new Error("cannot get child before first child");return this.childAt(t-1)}childAfter(e){const t=this.indexOfChild(e);if(t<0)throw new Error("Node.childAfter() called w/ an argument that is not a child");if(t===this.numChildren()-1)throw new Error("cannot get child after last child");return this.childAt(t+1)}isTerminal(){return!1}isNonterminal(){return!1}isIteration(){return!1}isOptional(){return!1}}class ue extends je{get ctorName(){return"_terminal"}isTerminal(){return!0}get primitiveValue(){throw new Error("The `primitiveValue` property was removed in Ohm v17.")}}class Cr extends je{constructor(e,t,n,s){super(s),this.ruleName=e,this.children=t,this.childOffsets=n}get ctorName(){return this.ruleName}isNonterminal(){return!0}isLexical(){return ct(this.ctorName)}isSyntactic(){return ae(this.ctorName)}}class wt extends je{constructor(e,t,n,s){super(n),this.children=e,this.childOffsets=t,this.optional=s}get ctorName(){return"_iter"}isIteration(){return!0}isOptional(){return this.optional}}d.prototype.eval=D("eval"),P.eval=function(r){const{inputStream:e}=r,t=e.pos,n=e.nextCodePoint();return n!==void 0?(r.pushBinding(new ue(String.fromCodePoint(n).length),t),!0):(r.processFailure(t,this),!1)},F.eval=function(r){const{inputStream:e}=r,t=e.pos;return e.atEnd()?(r.pushBinding(new ue(0),t),!0):(r.processFailure(t,this),!1)},N.prototype.eval=function(r){const{inputStream:e}=r,t=e.pos;return e.matchString(this.obj)?(r.pushBinding(new ue(this.obj.length),t),!0):(r.processFailure(t,this),!1)},C.prototype.eval=function(r){const{inputStream:e}=r,t=e.pos,n=this.matchCodePoint?e.nextCodePoint():e.nextCharCode();return n!==void 0&&this.from.codePointAt(0)<=n&&n<=this.to.codePointAt(0)?(r.pushBinding(new ue(String.fromCodePoint(n).length),t),!0):(r.processFailure(t,this),!1)},k.prototype.eval=function(r){return r.eval(r.currentApplication().args[this.index])},U.prototype.eval=function(r){r.enterLexifiedContext();const e=r.eval(this.expr);return r.exitLexifiedContext(),e},O.prototype.eval=function(r){for(let e=0;e<this.terms.length;e++)if(r.eval(this.terms[e]))return!0;return!1},E.prototype.eval=function(r){for(let e=0;e<this.factors.length;e++){const t=this.factors[e];if(!r.eval(t))return!1}return!0},$.prototype.eval=function(r){const{inputStream:e}=r,t=e.pos,n=this.getArity(),s=[],i=[];for(;s.length<n;)s.push([]),i.push([]);let o=0,a=t,u;for(;o<this.maxNumMatches&&r.eval(this.expr);){if(e.pos===a)throw vt(this,r._applicationStack);a=e.pos,o++;const p=r._bindings.splice(r._bindings.length-n,n),f=r._bindingOffsets.splice(r._bindingOffsets.length-n,n);for(u=0;u<p.length;u++)s[u].push(p[u]),i[u].push(f[u])}if(o<this.minNumMatches)return!1;let h=r.posToOffset(t),c=0;if(o>0){const p=s[n-1],f=i[n-1],g=f[f.length-1]+p[p.length-1].matchLength;h=i[0][0],c=g-h}const l=this instanceof Z;for(u=0;u<s.length;u++)r._bindings.push(new wt(s[u],i[u],c,l)),r._bindingOffsets.push(h);return!0},q.prototype.eval=function(r){const{inputStream:e}=r,t=e.pos;r.pushFailuresInfo();const n=r.eval(this.expr);return r.popFailuresInfo(),n?(r.processFailure(t,this),!1):(e.pos=t,!0)},B.prototype.eval=function(r){const{inputStream:e}=r,t=e.pos;return r.eval(this.expr)?(e.pos=t,!0):!1},I.prototype.eval=function(r){const e=r.currentApplication(),t=e?e.args:[],n=this.substituteParams(t),s=r.getCurrentPosInfo();if(s.isActive(n))return n.handleCycle(r);const i=n.toMemoKey(),o=s.memo[i];if(o&&s.shouldUseMemoizedResult(o)){if(r.hasNecessaryInfo(o))return r.useMemoizedResult(r.inputStream.pos,o);delete s.memo[i]}return n.reallyEval(r)},I.prototype.handleCycle=function(r){const e=r.getCurrentPosInfo(),{currentLeftRecursion:t}=e,n=this.toMemoKey();let s=e.memo[n];return t&&t.headApplication.toMemoKey()===n?s.updateInvolvedApplicationMemoKeys():s||(s=e.memoize(n,{matchLength:0,examinedLength:0,value:!1,rightmostFailureOffset:-1}),e.startLeftRecursion(this,s)),r.useMemoizedResult(r.inputStream.pos,s)},I.prototype.reallyEval=function(r){const{inputStream:e}=r,t=e.pos,n=r.getCurrentPosInfo(),s=r.grammar.rules[this.ruleName],{body:i}=s,{description:o}=s;r.enterApplication(n,this),o&&r.pushFailuresInfo();const a=e.examinedLength;e.examinedLength=0;let u=this.evalOnce(i,r);const h=n.currentLeftRecursion,c=this.toMemoKey(),l=h&&h.headApplication.toMemoKey()===c;let p;r.doNotMemoize?r.doNotMemoize=!1:l?(u=this.growSeedResult(i,r,t,h,u),n.endLeftRecursion(),p=h,p.examinedLength=e.examinedLength-t,p.rightmostFailureOffset=r._getRightmostFailureOffset(),n.memoize(c,p)):(!h||!h.isInvolved(c))&&(p=n.memoize(c,{matchLength:e.pos-t,examinedLength:e.examinedLength-t,value:u,failuresAtRightmostPosition:r.cloneRecordedFailures(),rightmostFailureOffset:r._getRightmostFailureOffset()}));const f=!!u;if(o&&(r.popFailuresInfo(),f||r.processFailure(t,this),p&&(p.failuresAtRightmostPosition=r.cloneRecordedFailures())),r.isTracing()&&p){const g=r.getTraceEntry(t,this,f,f?[u]:[]);l&&(se(g.terminatingLREntry!=null||!f),g.isHeadOfLeftRecursion=!0),p.traceEntry=g}return e.examinedLength=Math.max(e.examinedLength,a),r.exitApplication(n,u),f},I.prototype.evalOnce=function(r,e){const{inputStream:t}=e,n=t.pos;if(e.eval(r)){const s=r.getArity(),i=e._bindings.splice(e._bindings.length-s,s),o=e._bindingOffsets.splice(e._bindingOffsets.length-s,s),a=t.pos-n;return new Cr(this.ruleName,i,o,a)}else return!1},I.prototype.growSeedResult=function(r,e,t,n,s){if(!s)return!1;const{inputStream:i}=e;for(;;){if(n.matchLength=i.pos-t,n.value=s,n.failuresAtRightmostPosition=e.cloneRecordedFailures(),e.isTracing()){const o=e.trace[e.trace.length-1];n.traceEntry=new ie(e.input,t,i.pos,this,!0,[s],[o.clone()])}if(i.pos=t,s=this.evalOnce(r,e),i.pos-t<=n.matchLength)break;e.isTracing()&&e.trace.splice(-2,1)}return e.isTracing()&&n.traceEntry.recordLRTermination(e.trace.pop(),s),i.pos=t+n.matchLength,n.value},L.prototype.eval=function(r){const{inputStream:e}=r,t=e.pos,n=e.next();return n&&this.pattern.test(n)?(r.pushBinding(new ue(n.length),t),!0):(r.processFailure(t,this),!1)},d.prototype.getArity=D("getArity"),P.getArity=F.getArity=N.prototype.getArity=C.prototype.getArity=k.prototype.getArity=I.prototype.getArity=L.prototype.getArity=function(){return 1},O.prototype.getArity=function(){return this.terms.length===0?0:this.terms[0].getArity()},E.prototype.getArity=function(){let r=0;for(let e=0;e<this.factors.length;e++)r+=this.factors[e].getArity();return r},$.prototype.getArity=function(){return this.expr.getArity()},q.prototype.getArity=function(){return 0},B.prototype.getArity=U.prototype.getArity=function(){return this.expr.getArity()};function Y(r,e){const t={};if(r.source&&e){const n=r.source.relativeTo(e);t.sourceInterval=[n.startIdx,n.endIdx]}return t}d.prototype.outputRecipe=D("outputRecipe"),P.outputRecipe=function(r,e){return["any",Y(this,e)]},F.outputRecipe=function(r,e){return["end",Y(this,e)]},N.prototype.outputRecipe=function(r,e){return["terminal",Y(this,e),this.obj]},C.prototype.outputRecipe=function(r,e){return["range",Y(this,e),this.from,this.to]},k.prototype.outputRecipe=function(r,e){return["param",Y(this,e),this.index]},O.prototype.outputRecipe=function(r,e){return["alt",Y(this,e)].concat(this.terms.map(t=>t.outputRecipe(r,e)))},we.prototype.outputRecipe=function(r,e){return this.terms[0].outputRecipe(r,e)},be.prototype.outputRecipe=function(r,e){const t=this.terms.slice(0,this.expansionPos),n=this.terms.slice(this.expansionPos+1);return["splice",Y(this,e),t.map(s=>s.outputRecipe(r,e)),n.map(s=>s.outputRecipe(r,e))]},E.prototype.outputRecipe=function(r,e){return["seq",Y(this,e)].concat(this.factors.map(t=>t.outputRecipe(r,e)))},le.prototype.outputRecipe=pe.prototype.outputRecipe=Z.prototype.outputRecipe=q.prototype.outputRecipe=B.prototype.outputRecipe=U.prototype.outputRecipe=function(r,e){return[this.constructor.name.toLowerCase(),Y(this,e),this.expr.outputRecipe(r,e)]},I.prototype.outputRecipe=function(r,e){return["app",Y(this,e),this.ruleName,this.args.map(t=>t.outputRecipe(r,e))]},L.prototype.outputRecipe=function(r,e){return["unicodeChar",Y(this,e),this.category]},d.prototype.introduceParams=D("introduceParams"),P.introduceParams=F.introduceParams=N.prototype.introduceParams=C.prototype.introduceParams=k.prototype.introduceParams=L.prototype.introduceParams=function(r){return this},O.prototype.introduceParams=function(r){return this.terms.forEach((e,t,n)=>{n[t]=e.introduceParams(r)}),this},E.prototype.introduceParams=function(r){return this.factors.forEach((e,t,n)=>{n[t]=e.introduceParams(r)}),this},$.prototype.introduceParams=q.prototype.introduceParams=B.prototype.introduceParams=U.prototype.introduceParams=function(r){return this.expr=this.expr.introduceParams(r),this},I.prototype.introduceParams=function(r){const e=r.indexOf(this.ruleName);if(e>=0){if(this.args.length>0)throw new Error("Parameterized rules cannot be passed as arguments to another rule.");return new k(e).withSource(this.source)}else return this.args.forEach((t,n,s)=>{s[n]=t.introduceParams(r)}),this},d.prototype.isNullable=function(r){return this._isNullable(r,Object.create(null))},d.prototype._isNullable=D("_isNullable"),P._isNullable=C.prototype._isNullable=k.prototype._isNullable=pe.prototype._isNullable=L.prototype._isNullable=function(r,e){return!1},F._isNullable=function(r,e){return!0},N.prototype._isNullable=function(r,e){return typeof this.obj=="string"?this.obj==="":!1},O.prototype._isNullable=function(r,e){return this.terms.length===0||this.terms.some(t=>t._isNullable(r,e))},E.prototype._isNullable=function(r,e){return this.factors.every(t=>t._isNullable(r,e))},le.prototype._isNullable=Z.prototype._isNullable=q.prototype._isNullable=B.prototype._isNullable=function(r,e){return!0},U.prototype._isNullable=function(r,e){return this.expr._isNullable(r,e)},I.prototype._isNullable=function(r,e){const t=this.toMemoKey();if(!Object.prototype.hasOwnProperty.call(e,t)){const{body:n}=r.rules[this.ruleName],s=n.substituteParams(this.args);e[t]=!1,e[t]=s._isNullable(r,e)}return e[t]},d.prototype.substituteParams=D("substituteParams"),P.substituteParams=F.substituteParams=N.prototype.substituteParams=C.prototype.substituteParams=L.prototype.substituteParams=function(r){return this},k.prototype.substituteParams=function(r){return pt(r[this.index])},O.prototype.substituteParams=function(r){return new O(this.terms.map(e=>e.substituteParams(r)))},E.prototype.substituteParams=function(r){return new E(this.factors.map(e=>e.substituteParams(r)))},$.prototype.substituteParams=q.prototype.substituteParams=B.prototype.substituteParams=U.prototype.substituteParams=function(r){return new this.constructor(this.expr.substituteParams(r))},I.prototype.substituteParams=function(r){if(this.args.length===0)return this;{const e=this.args.map(t=>t.substituteParams(r));return new I(this.ruleName,e)}};function bt(r){return/^[a-zA-Z_$][0-9a-zA-Z_$]*$/.test(r)}function Ge(r){const e=Object.create(null);r.forEach(t=>{e[t]=(e[t]||0)+1}),Object.keys(e).forEach(t=>{if(e[t]<=1)return;let n=1;r.forEach((s,i)=>{s===t&&(r[i]=s+"_"+n++)})})}d.prototype.toArgumentNameList=D("toArgumentNameList"),P.toArgumentNameList=function(r,e){return["any"]},F.toArgumentNameList=function(r,e){return["end"]},N.prototype.toArgumentNameList=function(r,e){return typeof this.obj=="string"&&/^[_a-zA-Z0-9]+$/.test(this.obj)?["_"+this.obj]:["$"+r]},C.prototype.toArgumentNameList=function(r,e){let t=this.from+"_to_"+this.to;return bt(t)||(t="_"+t),bt(t)||(t="$"+r),[t]},O.prototype.toArgumentNameList=function(r,e){const t=this.terms.map(i=>i.toArgumentNameList(r,!0)),n=[],s=t[0].length;for(let i=0;i<s;i++){const o=[];for(let u=0;u<this.terms.length;u++)o.push(t[u][i]);const a=at(o);n.push(a.join("_or_"))}return e||Ge(n),n},E.prototype.toArgumentNameList=function(r,e){let t=[];return this.factors.forEach(n=>{const s=n.toArgumentNameList(r,!0);t=t.concat(s),r+=s.length}),e||Ge(t),t},$.prototype.toArgumentNameList=function(r,e){const t=this.expr.toArgumentNameList(r,e).map(n=>n[n.length-1]==="s"?n+"es":n+"s");return e||Ge(t),t},Z.prototype.toArgumentNameList=function(r,e){return this.expr.toArgumentNameList(r,e).map(t=>"opt"+t[0].toUpperCase()+t.slice(1))},q.prototype.toArgumentNameList=function(r,e){return[]},B.prototype.toArgumentNameList=U.prototype.toArgumentNameList=function(r,e){return this.expr.toArgumentNameList(r,e)},I.prototype.toArgumentNameList=function(r,e){return[this.ruleName]},L.prototype.toArgumentNameList=function(r,e){return["$"+r]},k.prototype.toArgumentNameList=function(r,e){return["param"+this.index]},d.prototype.toDisplayString=D("toDisplayString"),O.prototype.toDisplayString=E.prototype.toDisplayString=function(){return this.source?this.source.trimmed().contents:"["+this.constructor.name+"]"},P.toDisplayString=F.toDisplayString=$.prototype.toDisplayString=q.prototype.toDisplayString=B.prototype.toDisplayString=U.prototype.toDisplayString=N.prototype.toDisplayString=C.prototype.toDisplayString=k.prototype.toDisplayString=function(){return this.toString()},I.prototype.toDisplayString=function(){if(this.args.length>0){const r=this.args.map(e=>e.toDisplayString());return this.ruleName+"<"+r.join(",")+">"}else return this.ruleName},L.prototype.toDisplayString=function(){return"Unicode ["+this.category+"] character"};function kr(r){return r==="description"||r==="string"||r==="code"}class V{constructor(e,t,n){if(!kr(n))throw new Error("invalid Failure type: "+n);this.pexpr=e,this.text=t,this.type=n,this.fluffy=!1}getPExpr(){return this.pexpr}getText(){return this.text}getType(){return this.type}isDescription(){return this.type==="description"}isStringTerminal(){return this.type==="string"}isCode(){return this.type==="code"}isFluffy(){return this.fluffy}makeFluffy(){this.fluffy=!0}clearFluffy(){this.fluffy=!1}subsumes(e){return this.getText()===e.getText()&&this.type===e.type&&(!this.isFluffy()||this.isFluffy()&&e.isFluffy())}toString(){return this.type==="string"?JSON.stringify(this.getText()):this.getText()}clone(){const e=new V(this.pexpr,this.text,this.type);return this.isFluffy()&&e.makeFluffy(),e}toKey(){return this.toString()+"#"+this.type}}d.prototype.toFailure=D("toFailure"),P.toFailure=function(r){return new V(this,"any object","description")},F.toFailure=function(r){return new V(this,"end of input","description")},N.prototype.toFailure=function(r){return new V(this,this.obj,"string")},C.prototype.toFailure=function(r){return new V(this,JSON.stringify(this.from)+".."+JSON.stringify(this.to),"code")},q.prototype.toFailure=function(r){const e=this.expr===P?"nothing":"not "+this.expr.toFailure(r);return new V(this,e,"description")},B.prototype.toFailure=function(r){return this.expr.toFailure(r)},I.prototype.toFailure=function(r){let{description:e}=r.rules[this.ruleName];return e||(e=(/^[aeiouAEIOU]/.test(this.ruleName)?"an":"a")+" "+this.ruleName),new V(this,e,"description")},L.prototype.toFailure=function(r){return new V(this,"a Unicode ["+this.category+"] character","description")},O.prototype.toFailure=function(r){const t="("+this.terms.map(n=>n.toFailure(r)).join(" or ")+")";return new V(this,t,"description")},E.prototype.toFailure=function(r){const t="("+this.factors.map(n=>n.toFailure(r)).join(" ")+")";return new V(this,t,"description")},$.prototype.toFailure=function(r){const e="("+this.expr.toFailure(r)+this.operator+")";return new V(this,e,"description")},d.prototype.toString=D("toString"),P.toString=function(){return"any"},F.toString=function(){return"end"},N.prototype.toString=function(){return JSON.stringify(this.obj)},C.prototype.toString=function(){return JSON.stringify(this.from)+".."+JSON.stringify(this.to)},k.prototype.toString=function(){return"$"+this.index},U.prototype.toString=function(){return"#("+this.expr.toString()+")"},O.prototype.toString=function(){return this.terms.length===1?this.terms[0].toString():"("+this.terms.map(r=>r.toString()).join(" | ")+")"},E.prototype.toString=function(){return this.factors.length===1?this.factors[0].toString():"("+this.factors.map(r=>r.toString()).join(" ")+")"},$.prototype.toString=function(){return this.expr+this.operator},q.prototype.toString=function(){return"~"+this.expr},B.prototype.toString=function(){return"&"+this.expr},I.prototype.toString=function(){if(this.args.length>0){const r=this.args.map(e=>e.toString());return this.ruleName+"<"+r.join(",")+">"}else return this.ruleName},L.prototype.toString=function(){return"\\p{"+this.category+"}"};class Ue extends d{constructor(e){super(),this.obj=e}_getString(e){const t=e.currentApplication().args[this.obj.index];return se(t instanceof N,"expected a Terminal expression"),t.obj}allowsSkippingPrecedingSpace(){return!0}eval(e){const{inputStream:t}=e,n=t.pos,s=this._getString(e);return t.matchString(s,!0)?(e.pushBinding(new ue(s.length),n),!0):(e.processFailure(n,this),!1)}getArity(){return 1}substituteParams(e){return new Ue(this.obj.substituteParams(e))}toDisplayString(){return this.obj.toDisplayString()+" (case-insensitive)"}toFailure(e){return new V(this,this.obj.toFailure(e)+" (case-insensitive)","description")}_isNullable(e,t){return this.obj._isNullable(e,t)}}let Ot;xt(r=>{Ot=r.rules.applySyntactic.body});const Ve=new I("spaces");class Mr{constructor(e,t,n){this.matcher=e,this.startExpr=t,this.grammar=e.grammar,this.input=e.getInput(),this.inputStream=new Oe(this.input),this.memoTable=e._memoTable,this.userData=void 0,this.doNotMemoize=!1,this._bindings=[],this._bindingOffsets=[],this._applicationStack=[],this._posStack=[0],this.inLexifiedContextStack=[!1],this.rightmostFailurePosition=-1,this._rightmostFailurePositionStack=[],this._recordedFailuresStack=[],n!==void 0&&(this.positionToRecordFailures=n,this.recordedFailures=Object.create(null))}posToOffset(e){return e-this._posStack[this._posStack.length-1]}enterApplication(e,t){this._posStack.push(this.inputStream.pos),this._applicationStack.push(t),this.inLexifiedContextStack.push(!1),e.enter(t),this._rightmostFailurePositionStack.push(this.rightmostFailurePosition),this.rightmostFailurePosition=-1}exitApplication(e,t){const n=this._posStack.pop();this._applicationStack.pop(),this.inLexifiedContextStack.pop(),e.exit(),this.rightmostFailurePosition=Math.max(this.rightmostFailurePosition,this._rightmostFailurePositionStack.pop()),t&&this.pushBinding(t,n)}enterLexifiedContext(){this.inLexifiedContextStack.push(!0)}exitLexifiedContext(){this.inLexifiedContextStack.pop()}currentApplication(){return this._applicationStack[this._applicationStack.length-1]}inSyntacticContext(){const e=this.currentApplication();return e?e.isSyntactic()&&!this.inLexifiedContext():this.startExpr.factors[0].isSyntactic()}inLexifiedContext(){return this.inLexifiedContextStack[this.inLexifiedContextStack.length-1]}skipSpaces(){return this.pushFailuresInfo(),this.eval(Ve),this.popBinding(),this.popFailuresInfo(),this.inputStream.pos}skipSpacesIfInSyntacticContext(){return this.inSyntacticContext()?this.skipSpaces():this.inputStream.pos}maybeSkipSpacesBefore(e){return e.allowsSkippingPrecedingSpace()&&e!==Ve?this.skipSpacesIfInSyntacticContext():this.inputStream.pos}pushBinding(e,t){this._bindings.push(e),this._bindingOffsets.push(this.posToOffset(t))}popBinding(){this._bindings.pop(),this._bindingOffsets.pop()}numBindings(){return this._bindings.length}truncateBindings(e){for(;this._bindings.length>e;)this.popBinding()}getCurrentPosInfo(){return this.getPosInfo(this.inputStream.pos)}getPosInfo(e){let t=this.memoTable[e];return t||(t=this.memoTable[e]=new Ar),t}processFailure(e,t){if(this.rightmostFailurePosition=Math.max(this.rightmostFailurePosition,e),this.recordedFailures&&e===this.positionToRecordFailures){const n=this.currentApplication();n&&(t=t.substituteParams(n.args)),this.recordFailure(t.toFailure(this.grammar),!1)}}recordFailure(e,t){const n=e.toKey();this.recordedFailures[n]?this.recordedFailures[n].isFluffy()&&!e.isFluffy()&&this.recordedFailures[n].clearFluffy():this.recordedFailures[n]=t?e.clone():e}recordFailures(e,t){Object.keys(e).forEach(n=>{this.recordFailure(e[n],t)})}cloneRecordedFailures(){if(!this.recordedFailures)return;const e=Object.create(null);return Object.keys(this.recordedFailures).forEach(t=>{e[t]=this.recordedFailures[t].clone()}),e}getRightmostFailurePosition(){return this.rightmostFailurePosition}_getRightmostFailureOffset(){return this.rightmostFailurePosition>=0?this.posToOffset(this.rightmostFailurePosition):-1}getMemoizedTraceEntry(e,t){const n=this.memoTable[e];if(n&&t instanceof I){const s=n.memo[t.toMemoKey()];if(s&&s.traceEntry){const i=s.traceEntry.cloneWithExpr(t);return i.isMemoized=!0,i}}return null}getTraceEntry(e,t,n,s){if(t instanceof I){const i=this.currentApplication(),o=i?i.args:[];t=t.substituteParams(o)}return this.getMemoizedTraceEntry(e,t)||new ie(this.input,e,this.inputStream.pos,t,n,s,this.trace)}isTracing(){return!!this.trace}hasNecessaryInfo(e){return this.trace&&!e.traceEntry?!1:this.recordedFailures&&this.inputStream.pos+e.rightmostFailureOffset===this.positionToRecordFailures?!!e.failuresAtRightmostPosition:!0}useMemoizedResult(e,t){this.trace&&this.trace.push(t.traceEntry);const n=this.inputStream.pos+t.rightmostFailureOffset;return this.rightmostFailurePosition=Math.max(this.rightmostFailurePosition,n),this.recordedFailures&&this.positionToRecordFailures===n&&t.failuresAtRightmostPosition&&this.recordFailures(t.failuresAtRightmostPosition,!0),this.inputStream.examinedLength=Math.max(this.inputStream.examinedLength,t.examinedLength+e),t.value?(this.inputStream.pos+=t.matchLength,this.pushBinding(t.value,e),!0):!1}eval(e){const{inputStream:t}=this,n=this._bindings.length,s=this.userData;let i;this.recordedFailures&&(i=this.recordedFailures,this.recordedFailures=Object.create(null));const o=t.pos,a=this.maybeSkipSpacesBefore(e);let u;this.trace&&(u=this.trace,this.trace=[]);const h=e.eval(this);if(this.trace){const c=this._bindings.slice(n),l=this.getTraceEntry(a,e,h,c);l.isImplicitSpaces=e===Ve,l.isRootNode=e===this.startExpr,u.push(l),this.trace=u}return h?this.recordedFailures&&t.pos===this.positionToRecordFailures&&Object.keys(this.recordedFailures).forEach(c=>{this.recordedFailures[c].makeFluffy()}):(t.pos=o,this.truncateBindings(n),this.userData=s),this.recordedFailures&&this.recordFailures(i,!1),e===Ot&&this.skipSpaces(),h}getMatchResult(){this.grammar._setUpMatchState(this),this.eval(this.startExpr);let e;this.recordedFailures&&(e=Object.keys(this.recordedFailures).map(n=>this.recordedFailures[n]));const t=this._bindings[0];return t&&(t.grammar=this.grammar),new _t(this.matcher,this.input,this.startExpr,t,this._bindingOffsets[0],this.rightmostFailurePosition,e)}getTrace(){this.trace=[];const e=this.getMatchResult(),t=this.trace[this.trace.length-1];return t.result=e,t}pushFailuresInfo(){this._rightmostFailurePositionStack.push(this.rightmostFailurePosition),this._recordedFailuresStack.push(this.recordedFailures)}popFailuresInfo(){this.rightmostFailurePosition=this._rightmostFailurePositionStack.pop(),this.recordedFailures=this._recordedFailuresStack.pop()}}class Tr{constructor(e){this.grammar=e,this._memoTable=[],this._input="",this._isMemoTableStale=!1}_resetMemoTable(){this._memoTable=[],this._isMemoTableStale=!1}getInput(){return this._input}setInput(e){return this._input!==e&&this.replaceInputRange(0,this._input.length,e),this}replaceInputRange(e,t,n){const s=this._input,i=this._memoTable;if(e<0||e>s.length||t<0||t>s.length||e>t)throw new Error("Invalid indices: "+e+" and "+t);this._input=s.slice(0,e)+n+s.slice(t),this._input!==s&&i.length>0&&(this._isMemoTableStale=!0);const o=i.slice(t);i.length=e;for(let a=0;a<n.length;a++)i.push(void 0);for(const a of o)i.push(a);for(let a=0;a<e;a++){const u=i[a];u&&u.clearObsoleteEntries(a,e)}return this}match(e,t={incremental:!0}){return this._match(this._getStartExpr(e),{incremental:t.incremental,tracing:!1})}trace(e,t={incremental:!0}){return this._match(this._getStartExpr(e),{incremental:t.incremental,tracing:!0})}_match(e,t={}){const n={tracing:!1,incremental:!0,positionToRecordFailures:void 0,...t};if(!n.incremental)this._resetMemoTable();else if(this._isMemoTableStale&&!this.grammar.supportsIncrementalParsing)throw ir(this.grammar);const s=new Mr(this,e,n.positionToRecordFailures);return n.tracing?s.getTrace():s.getMatchResult()}_getStartExpr(e){const t=e||this.grammar.defaultStartRule;if(!t)throw new Error("Missing start rule argument -- the grammar has no default start rule.");const n=this.grammar.parseApplication(t);return new E([n,F])}}const de=[],He=(r,e)=>Object.prototype.hasOwnProperty.call(r,e);class Et{constructor(e,t,n){this._node=e,this.source=t,this._baseInterval=n,e.isNonterminal()&&se(t===n),this._childWrappers=[]}_forgetMemoizedResultFor(e){delete this._node[this._semantics.attributeKeys[e]],this.children.forEach(t=>{t._forgetMemoizedResultFor(e)})}child(e){if(!(0<=e&&e<this._node.numChildren()))return;let t=this._childWrappers[e];if(!t){const n=this._node.childAt(e),s=this._node.childOffsets[e],i=this._baseInterval.subInterval(s,n.matchLength),o=n.isNonterminal()?i:this._baseInterval;t=this._childWrappers[e]=this._semantics.wrap(n,i,o)}return t}_children(){for(let e=0;e<this._node.numChildren();e++)this.child(e);return this._childWrappers}isIteration(){return this._node.isIteration()}isTerminal(){return this._node.isTerminal()}isNonterminal(){return this._node.isNonterminal()}isSyntactic(){return this.isNonterminal()&&this._node.isSyntactic()}isLexical(){return this.isNonterminal()&&this._node.isLexical()}isOptional(){return this._node.isOptional()}iteration(e){const t=e||[],n=t.map(o=>o._node),s=new wt(n,[],-1,!1),i=this._semantics.wrap(s,null,null);return i._childWrappers=t,i}get children(){return this._children()}get ctorName(){return this._node.ctorName}get numChildren(){return this._node.numChildren()}get sourceString(){return this.source.contents}}class H{constructor(e,t){const n=this;if(this.grammar=e,this.checkedActionDicts=!1,this.Wrapper=class extends(t?t.Wrapper:Et){constructor(s,i,o){super(s,i,o),n.checkActionDictsIfHaventAlready(),this._semantics=n}toString(){return"[semantics wrapper for "+n.grammar.name+"]"}},this.super=t,t){if(!(e.equals(this.super.grammar)||e._inheritsFrom(this.super.grammar)))throw new Error("Cannot extend a semantics for grammar '"+this.super.grammar.name+"' for use with grammar '"+e.name+"' (not a sub-grammar)");this.operations=Object.create(this.super.operations),this.attributes=Object.create(this.super.attributes),this.attributeKeys=Object.create(null);for(const s in this.attributes)Object.defineProperty(this.attributeKeys,s,{value:St(s)})}else this.operations=Object.create(null),this.attributes=Object.create(null),this.attributeKeys=Object.create(null)}toString(){return"[semantics for "+this.grammar.name+"]"}checkActionDictsIfHaventAlready(){this.checkedActionDicts||(this.checkActionDicts(),this.checkedActionDicts=!0)}checkActionDicts(){let e;for(e in this.operations)this.operations[e].checkActionDict(this.grammar);for(e in this.attributes)this.attributes[e].checkActionDict(this.grammar)}toRecipe(e){function t(s){return s.super!==H.BuiltInSemantics._getSemantics()}let n=`(function(g) {
`;if(t(this)){n+="  var semantics = "+this.super.toRecipe(!0)+"(g";const s=this.super.grammar;let i=this.grammar;for(;i!==s;)n+=".superGrammar",i=i.superGrammar;n+=`);
`,n+="  return g.extendSemantics(semantics)"}else n+="  return g.createSemantics()";return["Operation","Attribute"].forEach(s=>{const i=this[s.toLowerCase()+"s"];Object.keys(i).forEach(o=>{const{actionDict:a,formals:u,builtInDefault:h}=i[o];let c=o;u.length>0&&(c+="("+u.join(", ")+")");let l;t(this)&&this.super[s.toLowerCase()+"s"][o]?l="extend"+s:l="add"+s,n+=`
    .`+l+"("+JSON.stringify(c)+", {";const p=[];Object.keys(a).forEach(f=>{if(a[f]!==h){let g=a[f].toString().trim();g=g.replace(/^.*\(/,"function("),p.push(`
      `+JSON.stringify(f)+": "+g)}}),n+=p.join(",")+`
    })`})}),n+=`;
  })`,e||(n=`(function() {
  var grammar = this.fromRecipe(`+this.grammar.toRecipe()+`);
  var semantics = `+n+`(grammar);
  return semantics;
});
`),n}addOperationOrAttribute(e,t,n){const s=e+"s",i=Nt(t,e),{name:o}=i,{formals:a}=i;this.assertNewName(o,e);const u=Dr(e,o,l),h={_default:u};Object.keys(n).forEach(p=>{h[p]=n[p]});const c=e==="operation"?new ge(o,a,h,u):new ze(o,h,u);c.checkActionDict(this.grammar),this[s][o]=c;function l(...p){const f=this._semantics[s][o];if(arguments.length!==f.formals.length)throw new Error("Invalid number of arguments passed to "+o+" "+e+" (expected "+f.formals.length+", got "+arguments.length+")");const g=Object.create(null);for(const[z,X]of Object.entries(p)){const x=f.formals[z];g[x]=X}const S=this.args;this.args=g;const b=f.execute(this._semantics,this);return this.args=S,b}e==="operation"?(this.Wrapper.prototype[o]=l,this.Wrapper.prototype[o].toString=function(){return"["+o+" operation]"}):(Object.defineProperty(this.Wrapper.prototype,o,{get:l,configurable:!0}),Object.defineProperty(this.attributeKeys,o,{value:St(o)}))}extendOperationOrAttribute(e,t,n){const s=e+"s";if(Nt(t,"attribute"),!(this.super&&t in this.super[s]))throw new Error("Cannot extend "+e+" '"+t+"': did not inherit an "+e+" with that name");if(He(this[s],t))throw new Error("Cannot extend "+e+" '"+t+"' again");const i=this[s][t].formals,o=this[s][t].actionDict,a=Object.create(o);Object.keys(n).forEach(u=>{a[u]=n[u]}),this[s][t]=e==="operation"?new ge(t,i,a):new ze(t,a),this[s][t].checkActionDict(this.grammar)}assertNewName(e,t){if(He(Et.prototype,e))throw new Error("Cannot add "+t+" '"+e+"': that's a reserved name");if(e in this.operations)throw new Error("Cannot add "+t+" '"+e+"': an operation with that name already exists");if(e in this.attributes)throw new Error("Cannot add "+t+" '"+e+"': an attribute with that name already exists")}wrap(e,t,n){const s=n||t;return e instanceof this.Wrapper?e:new this.Wrapper(e,t,s)}}function Nt(r,e){if(!H.prototypeGrammar)return se(r.indexOf("(")===-1),{name:r,formals:[]};const t=H.prototypeGrammar.match(r,e==="operation"?"OperationSignature":"AttributeSignature");if(t.failed())throw new Error(t.message);return H.prototypeGrammarSemantics(t).parse()}function Dr(r,e,t){return function(...n){const i=(this._semantics.operations[e]||this._semantics.attributes[e]).formals.map(o=>this.args[o]);if(!this.isIteration()&&n.length===1)return t.apply(n[0],i);throw vr(this.ctorName,e,r,de)}}H.createSemantics=function(r,e){const t=new H(r,e!==void 0?e:H.BuiltInSemantics._getSemantics()),n=function(i){if(!(i instanceof _t))throw new TypeError("Semantics expected a MatchResult, but got "+Me(i));if(i.failed())throw new TypeError("cannot apply Semantics to "+i.toString());const o=i._cst;if(o.grammar!==r)throw new Error("Cannot use a MatchResult from grammar '"+o.grammar.name+"' with a semantics for '"+r.name+"'");const a=new Oe(i.input);return t.wrap(o,a.interval(i._cstOffset,i.input.length))};return n.addOperation=function(s,i){return t.addOperationOrAttribute("operation",s,i),n},n.extendOperation=function(s,i){return t.extendOperationOrAttribute("operation",s,i),n},n.addAttribute=function(s,i){return t.addOperationOrAttribute("attribute",s,i),n},n.extendAttribute=function(s,i){return t.extendOperationOrAttribute("attribute",s,i),n},n._getActionDict=function(s){const i=t.operations[s]||t.attributes[s];if(!i)throw new Error('"'+s+'" is not a valid operation or attribute name in this semantics for "'+r.name+'"');return i.actionDict},n._remove=function(s){let i;return s in t.operations?(i=t.operations[s],delete t.operations[s]):s in t.attributes&&(i=t.attributes[s],delete t.attributes[s]),delete t.Wrapper.prototype[s],i},n.getOperationNames=function(){return Object.keys(t.operations)},n.getAttributeNames=function(){return Object.keys(t.attributes)},n.getGrammar=function(){return t.grammar},n.toRecipe=function(s){return t.toRecipe(s)},n.toString=t.toString.bind(t),n._getSemantics=function(){return t},n};class ge{constructor(e,t,n,s){this.name=e,this.formals=t,this.actionDict=n,this.builtInDefault=s}checkActionDict(e){e._checkTopDownActionDict(this.typeName,this.name,this.actionDict)}execute(e,t){try{const{ctorName:n}=t._node;let s=this.actionDict[n];return s?(de.push([this,n]),s.apply(t,t._children())):t.isNonterminal()&&(s=this.actionDict._nonterminal,s)?(de.push([this,"_nonterminal",n]),s.apply(t,t._children())):(de.push([this,"default action",n]),this.actionDict._default.apply(t,t._children()))}finally{de.pop()}}}ge.prototype.typeName="operation";class ze extends ge{constructor(e,t,n){super(e,[],t,n)}execute(e,t){const n=t._node,s=e.attributeKeys[this.name];return He(n,s)||(n[s]=ge.prototype.execute.call(this,e,t)),n[s]}}ze.prototype.typeName="attribute";const Lt=["_iter","_terminal","_nonterminal","_default"];function Rt(r){return Object.keys(r.rules).sort().map(e=>r.rules[e])}const $r=r=>r.replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029");let Pt,Ft;class j{constructor(e,t,n,s){if(this.name=e,this.superGrammar=t,this.rules=n,s){if(!(s in n))throw new Error("Invalid start rule: '"+s+"' is not a rule in grammar '"+e+"'");this.defaultStartRule=s}this._matchStateInitializer=void 0,this.supportsIncrementalParsing=!0}matcher(){return new Tr(this)}isBuiltIn(){return this===j.ProtoBuiltInRules||this===j.BuiltInRules}equals(e){if(this===e)return!0;if(e==null||this.name!==e.name||this.defaultStartRule!==e.defaultStartRule||!(this.superGrammar===e.superGrammar||this.superGrammar.equals(e.superGrammar)))return!1;const t=Rt(this),n=Rt(e);return t.length===n.length&&t.every((s,i)=>s.description===n[i].description&&s.formals.join(",")===n[i].formals.join(",")&&s.body.toString()===n[i].body.toString())}match(e,t){const n=this.matcher();return n.replaceInputRange(0,0,e),n.match(t)}trace(e,t){const n=this.matcher();return n.replaceInputRange(0,0,e),n.trace(t)}createSemantics(){return H.createSemantics(this)}extendSemantics(e){return H.createSemantics(this,e._getSemantics())}_checkTopDownActionDict(e,t,n){const s=[];for(const i in n){const o=n[i];if(!Lt.includes(i)&&!(i in this.rules)){s.push(`'${i}' is not a valid semantic action for '${this.name}'`);continue}if(typeof o!="function"){s.push(`'${i}' must be a function in an action dictionary for '${this.name}'`);continue}const u=o.length,h=this._topDownActionArity(i);if(u!==h){let c;i==="_iter"||i==="_nonterminal"?c=`it should use a rest parameter, e.g. \`${i}(...children) {}\`. NOTE: this is new in Ohm v16 — see https://ohmjs.org/d/ati for details.`:c=`expected ${h}, got ${u}`,s.push(`Semantic action '${i}' has the wrong arity: ${c}`)}}if(s.length>0){const i=s.map(a=>"- "+a),o=new Error([`Found errors in the action dictionary of the '${t}' ${e}:`,...i].join(`
`));throw o.problems=s,o}}_topDownActionArity(e){return Lt.includes(e)?0:this.rules[e].body.getArity()}_inheritsFrom(e){let t=this.superGrammar;for(;t;){if(t.equals(e,!0))return!0;t=t.superGrammar}return!1}toRecipe(e=void 0){const t={};this.source&&(t.source=this.source.contents);let n=null;this.defaultStartRule&&(n=this.defaultStartRule);const s={};Object.keys(this.rules).forEach(a=>{const u=this.rules[a],{body:h}=u,c=!this.superGrammar||!this.superGrammar.rules[a];let l;c?l="define":l=h instanceof we?"extend":"override";const p={};if(u.source&&this.source){const S=u.source.relativeTo(this.source);p.sourceInterval=[S.startIdx,S.endIdx]}const f=c?u.description:null,g=h.outputRecipe(u.formals,this.source);s[a]=[l,p,f,u.formals,g]});let i="null";e?i=e:this.superGrammar&&!this.superGrammar.isBuiltIn()&&(i=this.superGrammar.toRecipe());const o=[...["grammar",t,this.name].map(JSON.stringify),i,...[n,s].map(JSON.stringify)];return $r(`[${o.join(",")}]`)}toOperationActionDictionaryTemplate(){return this._toOperationOrAttributeActionDictionaryTemplate()}toAttributeActionDictionaryTemplate(){return this._toOperationOrAttributeActionDictionaryTemplate()}_toOperationOrAttributeActionDictionaryTemplate(){const e=new ce;e.append("{");let t=!0;for(const n in this.rules){const{body:s}=this.rules[n];t?t=!1:e.append(","),e.append(`
`),e.append("  "),this.addSemanticActionTemplate(n,s,e)}return e.append(`
}`),e.contents()}addSemanticActionTemplate(e,t,n){n.append(e),n.append(": function(");const s=this._topDownActionArity(e);n.append(Ae("_",s).join(", ")),n.append(`) {
`),n.append("  }")}parseApplication(e){let t;if(e.indexOf("<")===-1)t=new I(e);else{const s=Pt.match(e,"Base_application");t=Ft(s,{})}if(!(t.ruleName in this.rules))throw ht(t.ruleName,this.name);const{formals:n}=this.rules[t.ruleName];if(n.length!==t.args.length){const{source:s}=this.rules[t.ruleName];throw ft(t.ruleName,n.length,t.args.length,s)}return t}_setUpMatchState(e){this._matchStateInitializer&&this._matchStateInitializer(e)}}j.ProtoBuiltInRules=new j("ProtoBuiltInRules",void 0,{any:{body:P,formals:[],description:"any character",primitive:!0},end:{body:F,formals:[],description:"end of input",primitive:!0},caseInsensitive:{body:new Ue(new k(0)),formals:["str"],primitive:!0},lower:{body:new L("Ll"),formals:[],description:"a lowercase letter",primitive:!0},upper:{body:new L("Lu"),formals:[],description:"an uppercase letter",primitive:!0},unicodeLtmo:{body:new L("Ltmo"),formals:[],description:"a Unicode character in Lt, Lm, or Lo",primitive:!0},spaces:{body:new le(new I("space")),formals:[]},space:{body:new C("\0"," "),formals:[],description:"a space"}}),j.initApplicationParser=function(r,e){Pt=r,Ft=e};class Ct{constructor(e){this.name=e}sourceInterval(e,t){return this.source.subInterval(e,t-e)}ensureSuperGrammar(){return this.superGrammar||this.withSuperGrammar(this.name==="BuiltInRules"?j.ProtoBuiltInRules:j.BuiltInRules),this.superGrammar}ensureSuperGrammarRuleForOverriding(e,t){const n=this.ensureSuperGrammar().rules[e];if(!n)throw or(e,this.superGrammar.name,t);return n}installOverriddenOrExtendedRule(e,t,n,s){const i=Ce(t);if(i.length>0)throw dt(e,i,s);const o=this.ensureSuperGrammar().rules[e],a=o.formals,u=a?a.length:0;if(t.length!==u)throw ft(e,u,t.length,s);return this.install(e,t,n,o.description,s)}install(e,t,n,s,i,o=!1){return this.rules[e]={body:n.introduceParams(t),formals:t,description:s,source:i,primitive:o},this}withSuperGrammar(e){if(this.superGrammar)throw new Error("the super grammar of a GrammarDecl cannot be set more than once");return this.superGrammar=e,this.rules=Object.create(e.rules),e.isBuiltIn()||(this.defaultStartRule=e.defaultStartRule),this}withDefaultStartRule(e){return this.defaultStartRule=e,this}withSource(e){return this.source=new Oe(e).interval(0,e.length),this}build(){const e=new j(this.name,this.ensureSuperGrammar(),this.rules,this.defaultStartRule);e._matchStateInitializer=e.superGrammar._matchStateInitializer,e.supportsIncrementalParsing=e.superGrammar.supportsIncrementalParsing;const t=[];let n=!1;return Object.keys(e.rules).forEach(s=>{const{body:i}=e.rules[s];try{i.assertChoicesHaveUniformArity(s)}catch(o){t.push(o)}try{i.assertAllApplicationsAreValid(s,e)}catch(o){t.push(o),n=!0}}),n||Object.keys(e.rules).forEach(s=>{const{body:i}=e.rules[s];try{i.assertIteratedExprsAreNotNullable(e,[])}catch(o){t.push(o)}}),t.length>0&&Ir(t),this.source&&(e.source=this.source),e}define(e,t,n,s,i,o){if(this.ensureSuperGrammar(),this.superGrammar.rules[e])throw mt(e,this.name,this.superGrammar.name,i);if(this.rules[e])throw mt(e,this.name,this.name,i);const a=Ce(t);if(a.length>0)throw dt(e,a,i);return this.install(e,t,n,s,i,o)}override(e,t,n,s,i){return this.ensureSuperGrammarRuleForOverriding(e,i),this.installOverriddenOrExtendedRule(e,t,n,i),this}extend(e,t,n,s,i){if(!this.ensureSuperGrammar().rules[e])throw ar(e,this.superGrammar.name,i);const a=new we(this.superGrammar,e,n);return a.source=n.source,this.installOverriddenOrExtendedRule(e,t,a,i),this}}class Ne{constructor(){this.currentDecl=null,this.currentRuleName=null}newGrammar(e){return new Ct(e)}grammar(e,t,n,s,i){const o=new Ct(t);return n&&o.withSuperGrammar(n instanceof j?n:this.fromRecipe(n)),s&&o.withDefaultStartRule(s),e&&e.source&&o.withSource(e.source),this.currentDecl=o,Object.keys(i).forEach(a=>{this.currentRuleName=a;const u=i[a],h=u[0],c=u[1],l=u[2],p=u[3],f=this.fromRecipe(u[4]);let g;o.source&&c&&c.sourceInterval&&(g=o.source.subInterval(c.sourceInterval[0],c.sourceInterval[1]-c.sourceInterval[0])),o[h](a,p,f,l,g)}),this.currentRuleName=this.currentDecl=null,o.build()}terminal(e){return new N(e)}range(e,t){return new C(e,t)}param(e){return new k(e)}alt(...e){let t=[];for(let n of e)n instanceof d||(n=this.fromRecipe(n)),n instanceof O?t=t.concat(n.terms):t.push(n);return t.length===1?t[0]:new O(t)}seq(...e){let t=[];for(let n of e)n instanceof d||(n=this.fromRecipe(n)),n instanceof E?t=t.concat(n.factors):t.push(n);return t.length===1?t[0]:new E(t)}star(e){return e instanceof d||(e=this.fromRecipe(e)),new le(e)}plus(e){return e instanceof d||(e=this.fromRecipe(e)),new pe(e)}opt(e){return e instanceof d||(e=this.fromRecipe(e)),new Z(e)}not(e){return e instanceof d||(e=this.fromRecipe(e)),new q(e)}lookahead(e){return e instanceof d||(e=this.fromRecipe(e)),new B(e)}lex(e){return e instanceof d||(e=this.fromRecipe(e)),new U(e)}app(e,t){return t&&t.length>0&&(t=t.map(function(n){return n instanceof d?n:this.fromRecipe(n)},this)),new I(e,t)}splice(e,t){return new be(this.currentDecl.superGrammar,this.currentRuleName,e.map(n=>this.fromRecipe(n)),t.map(n=>this.fromRecipe(n)))}fromRecipe(e){const t=e[0]==="grammar"?e.slice(1):e.slice(2),n=this[e[0]](...t),s=e[1];return s&&s.sourceInterval&&this.currentDecl&&n.withSource(this.currentDecl.sourceInterval(...s.sourceInterval)),n}}function Ke(r){return typeof r=="function"?r.call(new Ne):(typeof r=="string"&&(r=JSON.parse(r)),new Ne().fromRecipe(r))}var We=Ke(["grammar",{source:`BuiltInRules {

  alnum  (an alpha-numeric character)
    = letter
    | digit

  letter  (a letter)
    = lower
    | upper
    | unicodeLtmo

  digit  (a digit)
    = "0".."9"

  hexDigit  (a hexadecimal digit)
    = digit
    | "a".."f"
    | "A".."F"

  ListOf<elem, sep>
    = NonemptyListOf<elem, sep>
    | EmptyListOf<elem, sep>

  NonemptyListOf<elem, sep>
    = elem (sep elem)*

  EmptyListOf<elem, sep>
    = /* nothing */

  listOf<elem, sep>
    = nonemptyListOf<elem, sep>
    | emptyListOf<elem, sep>

  nonemptyListOf<elem, sep>
    = elem (sep elem)*

  emptyListOf<elem, sep>
    = /* nothing */

  // Allows a syntactic rule application within a lexical context.
  applySyntactic<app> = app
}`},"BuiltInRules",null,null,{alnum:["define",{sourceInterval:[18,78]},"an alpha-numeric character",[],["alt",{sourceInterval:[60,78]},["app",{sourceInterval:[60,66]},"letter",[]],["app",{sourceInterval:[73,78]},"digit",[]]]],letter:["define",{sourceInterval:[82,142]},"a letter",[],["alt",{sourceInterval:[107,142]},["app",{sourceInterval:[107,112]},"lower",[]],["app",{sourceInterval:[119,124]},"upper",[]],["app",{sourceInterval:[131,142]},"unicodeLtmo",[]]]],digit:["define",{sourceInterval:[146,177]},"a digit",[],["range",{sourceInterval:[169,177]},"0","9"]],hexDigit:["define",{sourceInterval:[181,254]},"a hexadecimal digit",[],["alt",{sourceInterval:[219,254]},["app",{sourceInterval:[219,224]},"digit",[]],["range",{sourceInterval:[231,239]},"a","f"],["range",{sourceInterval:[246,254]},"A","F"]]],ListOf:["define",{sourceInterval:[258,336]},null,["elem","sep"],["alt",{sourceInterval:[282,336]},["app",{sourceInterval:[282,307]},"NonemptyListOf",[["param",{sourceInterval:[297,301]},0],["param",{sourceInterval:[303,306]},1]]],["app",{sourceInterval:[314,336]},"EmptyListOf",[["param",{sourceInterval:[326,330]},0],["param",{sourceInterval:[332,335]},1]]]]],NonemptyListOf:["define",{sourceInterval:[340,388]},null,["elem","sep"],["seq",{sourceInterval:[372,388]},["param",{sourceInterval:[372,376]},0],["star",{sourceInterval:[377,388]},["seq",{sourceInterval:[378,386]},["param",{sourceInterval:[378,381]},1],["param",{sourceInterval:[382,386]},0]]]]],EmptyListOf:["define",{sourceInterval:[392,434]},null,["elem","sep"],["seq",{sourceInterval:[438,438]}]],listOf:["define",{sourceInterval:[438,516]},null,["elem","sep"],["alt",{sourceInterval:[462,516]},["app",{sourceInterval:[462,487]},"nonemptyListOf",[["param",{sourceInterval:[477,481]},0],["param",{sourceInterval:[483,486]},1]]],["app",{sourceInterval:[494,516]},"emptyListOf",[["param",{sourceInterval:[506,510]},0],["param",{sourceInterval:[512,515]},1]]]]],nonemptyListOf:["define",{sourceInterval:[520,568]},null,["elem","sep"],["seq",{sourceInterval:[552,568]},["param",{sourceInterval:[552,556]},0],["star",{sourceInterval:[557,568]},["seq",{sourceInterval:[558,566]},["param",{sourceInterval:[558,561]},1],["param",{sourceInterval:[562,566]},0]]]]],emptyListOf:["define",{sourceInterval:[572,682]},null,["elem","sep"],["seq",{sourceInterval:[685,685]}]],applySyntactic:["define",{sourceInterval:[685,710]},null,["app"],["param",{sourceInterval:[707,710]},0]]}]);j.BuiltInRules=We,Sr(j.BuiltInRules);var Ye=Ke(["grammar",{source:`Ohm {

  Grammars
    = Grammar*

  Grammar
    = ident SuperGrammar? "{" Rule* "}"

  SuperGrammar
    = "<:" ident

  Rule
    = ident Formals? ruleDescr? "="  RuleBody  -- define
    | ident Formals?            ":=" OverrideRuleBody  -- override
    | ident Formals?            "+=" RuleBody  -- extend

  RuleBody
    = "|"? NonemptyListOf<TopLevelTerm, "|">

  TopLevelTerm
    = Seq caseName  -- inline
    | Seq

  OverrideRuleBody
    = "|"? NonemptyListOf<OverrideTopLevelTerm, "|">

  OverrideTopLevelTerm
    = "..."  -- superSplice
    | TopLevelTerm

  Formals
    = "<" ListOf<ident, ","> ">"

  Params
    = "<" ListOf<Seq, ","> ">"

  Alt
    = NonemptyListOf<Seq, "|">

  Seq
    = Iter*

  Iter
    = Pred "*"  -- star
    | Pred "+"  -- plus
    | Pred "?"  -- opt
    | Pred

  Pred
    = "~" Lex  -- not
    | "&" Lex  -- lookahead
    | Lex

  Lex
    = "#" Base  -- lex
    | Base

  Base
    = ident Params? ~(ruleDescr? "=" | ":=" | "+=")  -- application
    | oneCharTerminal ".." oneCharTerminal           -- range
    | terminal                                       -- terminal
    | "(" Alt ")"                                    -- paren

  ruleDescr  (a rule description)
    = "(" ruleDescrText ")"

  ruleDescrText
    = (~")" any)*

  caseName
    = "--" (~"\\n" space)* name (~"\\n" space)* ("\\n" | &"}")

  name  (a name)
    = nameFirst nameRest*

  nameFirst
    = "_"
    | letter

  nameRest
    = "_"
    | alnum

  ident  (an identifier)
    = name

  terminal
    = "\\"" terminalChar* "\\""

  oneCharTerminal
    = "\\"" terminalChar "\\""

  terminalChar
    = escapeChar
      | ~"\\\\" ~"\\"" ~"\\n" "\\u{0}".."\\u{10FFFF}"

  escapeChar  (an escape sequence)
    = "\\\\\\\\"                                     -- backslash
    | "\\\\\\""                                     -- doubleQuote
    | "\\\\\\'"                                     -- singleQuote
    | "\\\\b"                                      -- backspace
    | "\\\\n"                                      -- lineFeed
    | "\\\\r"                                      -- carriageReturn
    | "\\\\t"                                      -- tab
    | "\\\\u{" hexDigit hexDigit? hexDigit?
             hexDigit? hexDigit? hexDigit? "}"   -- unicodeCodePoint
    | "\\\\u" hexDigit hexDigit hexDigit hexDigit  -- unicodeEscape
    | "\\\\x" hexDigit hexDigit                    -- hexEscape

  space
   += comment

  comment
    = "//" (~"\\n" any)* &("\\n" | end)  -- singleLine
    | "/*" (~"*/" any)* "*/"  -- multiLine

  tokens = token*

  token = caseName | comment | ident | operator | punctuation | terminal | any

  operator = "<:" | "=" | ":=" | "+=" | "*" | "+" | "?" | "~" | "&"

  punctuation = "<" | ">" | "," | "--"
}`},"Ohm",null,"Grammars",{Grammars:["define",{sourceInterval:[9,32]},null,[],["star",{sourceInterval:[24,32]},["app",{sourceInterval:[24,31]},"Grammar",[]]]],Grammar:["define",{sourceInterval:[36,83]},null,[],["seq",{sourceInterval:[50,83]},["app",{sourceInterval:[50,55]},"ident",[]],["opt",{sourceInterval:[56,69]},["app",{sourceInterval:[56,68]},"SuperGrammar",[]]],["terminal",{sourceInterval:[70,73]},"{"],["star",{sourceInterval:[74,79]},["app",{sourceInterval:[74,78]},"Rule",[]]],["terminal",{sourceInterval:[80,83]},"}"]]],SuperGrammar:["define",{sourceInterval:[87,116]},null,[],["seq",{sourceInterval:[106,116]},["terminal",{sourceInterval:[106,110]},"<:"],["app",{sourceInterval:[111,116]},"ident",[]]]],Rule_define:["define",{sourceInterval:[131,181]},null,[],["seq",{sourceInterval:[131,170]},["app",{sourceInterval:[131,136]},"ident",[]],["opt",{sourceInterval:[137,145]},["app",{sourceInterval:[137,144]},"Formals",[]]],["opt",{sourceInterval:[146,156]},["app",{sourceInterval:[146,155]},"ruleDescr",[]]],["terminal",{sourceInterval:[157,160]},"="],["app",{sourceInterval:[162,170]},"RuleBody",[]]]],Rule_override:["define",{sourceInterval:[188,248]},null,[],["seq",{sourceInterval:[188,235]},["app",{sourceInterval:[188,193]},"ident",[]],["opt",{sourceInterval:[194,202]},["app",{sourceInterval:[194,201]},"Formals",[]]],["terminal",{sourceInterval:[214,218]},":="],["app",{sourceInterval:[219,235]},"OverrideRuleBody",[]]]],Rule_extend:["define",{sourceInterval:[255,305]},null,[],["seq",{sourceInterval:[255,294]},["app",{sourceInterval:[255,260]},"ident",[]],["opt",{sourceInterval:[261,269]},["app",{sourceInterval:[261,268]},"Formals",[]]],["terminal",{sourceInterval:[281,285]},"+="],["app",{sourceInterval:[286,294]},"RuleBody",[]]]],Rule:["define",{sourceInterval:[120,305]},null,[],["alt",{sourceInterval:[131,305]},["app",{sourceInterval:[131,170]},"Rule_define",[]],["app",{sourceInterval:[188,235]},"Rule_override",[]],["app",{sourceInterval:[255,294]},"Rule_extend",[]]]],RuleBody:["define",{sourceInterval:[309,362]},null,[],["seq",{sourceInterval:[324,362]},["opt",{sourceInterval:[324,328]},["terminal",{sourceInterval:[324,327]},"|"]],["app",{sourceInterval:[329,362]},"NonemptyListOf",[["app",{sourceInterval:[344,356]},"TopLevelTerm",[]],["terminal",{sourceInterval:[358,361]},"|"]]]]],TopLevelTerm_inline:["define",{sourceInterval:[385,408]},null,[],["seq",{sourceInterval:[385,397]},["app",{sourceInterval:[385,388]},"Seq",[]],["app",{sourceInterval:[389,397]},"caseName",[]]]],TopLevelTerm:["define",{sourceInterval:[366,418]},null,[],["alt",{sourceInterval:[385,418]},["app",{sourceInterval:[385,397]},"TopLevelTerm_inline",[]],["app",{sourceInterval:[415,418]},"Seq",[]]]],OverrideRuleBody:["define",{sourceInterval:[422,491]},null,[],["seq",{sourceInterval:[445,491]},["opt",{sourceInterval:[445,449]},["terminal",{sourceInterval:[445,448]},"|"]],["app",{sourceInterval:[450,491]},"NonemptyListOf",[["app",{sourceInterval:[465,485]},"OverrideTopLevelTerm",[]],["terminal",{sourceInterval:[487,490]},"|"]]]]],OverrideTopLevelTerm_superSplice:["define",{sourceInterval:[522,543]},null,[],["terminal",{sourceInterval:[522,527]},"..."]],OverrideTopLevelTerm:["define",{sourceInterval:[495,562]},null,[],["alt",{sourceInterval:[522,562]},["app",{sourceInterval:[522,527]},"OverrideTopLevelTerm_superSplice",[]],["app",{sourceInterval:[550,562]},"TopLevelTerm",[]]]],Formals:["define",{sourceInterval:[566,606]},null,[],["seq",{sourceInterval:[580,606]},["terminal",{sourceInterval:[580,583]},"<"],["app",{sourceInterval:[584,602]},"ListOf",[["app",{sourceInterval:[591,596]},"ident",[]],["terminal",{sourceInterval:[598,601]},","]]],["terminal",{sourceInterval:[603,606]},">"]]],Params:["define",{sourceInterval:[610,647]},null,[],["seq",{sourceInterval:[623,647]},["terminal",{sourceInterval:[623,626]},"<"],["app",{sourceInterval:[627,643]},"ListOf",[["app",{sourceInterval:[634,637]},"Seq",[]],["terminal",{sourceInterval:[639,642]},","]]],["terminal",{sourceInterval:[644,647]},">"]]],Alt:["define",{sourceInterval:[651,685]},null,[],["app",{sourceInterval:[661,685]},"NonemptyListOf",[["app",{sourceInterval:[676,679]},"Seq",[]],["terminal",{sourceInterval:[681,684]},"|"]]]],Seq:["define",{sourceInterval:[689,704]},null,[],["star",{sourceInterval:[699,704]},["app",{sourceInterval:[699,703]},"Iter",[]]]],Iter_star:["define",{sourceInterval:[719,736]},null,[],["seq",{sourceInterval:[719,727]},["app",{sourceInterval:[719,723]},"Pred",[]],["terminal",{sourceInterval:[724,727]},"*"]]],Iter_plus:["define",{sourceInterval:[743,760]},null,[],["seq",{sourceInterval:[743,751]},["app",{sourceInterval:[743,747]},"Pred",[]],["terminal",{sourceInterval:[748,751]},"+"]]],Iter_opt:["define",{sourceInterval:[767,783]},null,[],["seq",{sourceInterval:[767,775]},["app",{sourceInterval:[767,771]},"Pred",[]],["terminal",{sourceInterval:[772,775]},"?"]]],Iter:["define",{sourceInterval:[708,794]},null,[],["alt",{sourceInterval:[719,794]},["app",{sourceInterval:[719,727]},"Iter_star",[]],["app",{sourceInterval:[743,751]},"Iter_plus",[]],["app",{sourceInterval:[767,775]},"Iter_opt",[]],["app",{sourceInterval:[790,794]},"Pred",[]]]],Pred_not:["define",{sourceInterval:[809,824]},null,[],["seq",{sourceInterval:[809,816]},["terminal",{sourceInterval:[809,812]},"~"],["app",{sourceInterval:[813,816]},"Lex",[]]]],Pred_lookahead:["define",{sourceInterval:[831,852]},null,[],["seq",{sourceInterval:[831,838]},["terminal",{sourceInterval:[831,834]},"&"],["app",{sourceInterval:[835,838]},"Lex",[]]]],Pred:["define",{sourceInterval:[798,862]},null,[],["alt",{sourceInterval:[809,862]},["app",{sourceInterval:[809,816]},"Pred_not",[]],["app",{sourceInterval:[831,838]},"Pred_lookahead",[]],["app",{sourceInterval:[859,862]},"Lex",[]]]],Lex_lex:["define",{sourceInterval:[876,892]},null,[],["seq",{sourceInterval:[876,884]},["terminal",{sourceInterval:[876,879]},"#"],["app",{sourceInterval:[880,884]},"Base",[]]]],Lex:["define",{sourceInterval:[866,903]},null,[],["alt",{sourceInterval:[876,903]},["app",{sourceInterval:[876,884]},"Lex_lex",[]],["app",{sourceInterval:[899,903]},"Base",[]]]],Base_application:["define",{sourceInterval:[918,979]},null,[],["seq",{sourceInterval:[918,963]},["app",{sourceInterval:[918,923]},"ident",[]],["opt",{sourceInterval:[924,931]},["app",{sourceInterval:[924,930]},"Params",[]]],["not",{sourceInterval:[932,963]},["alt",{sourceInterval:[934,962]},["seq",{sourceInterval:[934,948]},["opt",{sourceInterval:[934,944]},["app",{sourceInterval:[934,943]},"ruleDescr",[]]],["terminal",{sourceInterval:[945,948]},"="]],["terminal",{sourceInterval:[951,955]},":="],["terminal",{sourceInterval:[958,962]},"+="]]]]],Base_range:["define",{sourceInterval:[986,1041]},null,[],["seq",{sourceInterval:[986,1022]},["app",{sourceInterval:[986,1001]},"oneCharTerminal",[]],["terminal",{sourceInterval:[1002,1006]},".."],["app",{sourceInterval:[1007,1022]},"oneCharTerminal",[]]]],Base_terminal:["define",{sourceInterval:[1048,1106]},null,[],["app",{sourceInterval:[1048,1056]},"terminal",[]]],Base_paren:["define",{sourceInterval:[1113,1168]},null,[],["seq",{sourceInterval:[1113,1124]},["terminal",{sourceInterval:[1113,1116]},"("],["app",{sourceInterval:[1117,1120]},"Alt",[]],["terminal",{sourceInterval:[1121,1124]},")"]]],Base:["define",{sourceInterval:[907,1168]},null,[],["alt",{sourceInterval:[918,1168]},["app",{sourceInterval:[918,963]},"Base_application",[]],["app",{sourceInterval:[986,1022]},"Base_range",[]],["app",{sourceInterval:[1048,1056]},"Base_terminal",[]],["app",{sourceInterval:[1113,1124]},"Base_paren",[]]]],ruleDescr:["define",{sourceInterval:[1172,1231]},"a rule description",[],["seq",{sourceInterval:[1210,1231]},["terminal",{sourceInterval:[1210,1213]},"("],["app",{sourceInterval:[1214,1227]},"ruleDescrText",[]],["terminal",{sourceInterval:[1228,1231]},")"]]],ruleDescrText:["define",{sourceInterval:[1235,1266]},null,[],["star",{sourceInterval:[1255,1266]},["seq",{sourceInterval:[1256,1264]},["not",{sourceInterval:[1256,1260]},["terminal",{sourceInterval:[1257,1260]},")"]],["app",{sourceInterval:[1261,1264]},"any",[]]]]],caseName:["define",{sourceInterval:[1270,1338]},null,[],["seq",{sourceInterval:[1285,1338]},["terminal",{sourceInterval:[1285,1289]},"--"],["star",{sourceInterval:[1290,1304]},["seq",{sourceInterval:[1291,1302]},["not",{sourceInterval:[1291,1296]},["terminal",{sourceInterval:[1292,1296]},`
`]],["app",{sourceInterval:[1297,1302]},"space",[]]]],["app",{sourceInterval:[1305,1309]},"name",[]],["star",{sourceInterval:[1310,1324]},["seq",{sourceInterval:[1311,1322]},["not",{sourceInterval:[1311,1316]},["terminal",{sourceInterval:[1312,1316]},`
`]],["app",{sourceInterval:[1317,1322]},"space",[]]]],["alt",{sourceInterval:[1326,1337]},["terminal",{sourceInterval:[1326,1330]},`
`],["lookahead",{sourceInterval:[1333,1337]},["terminal",{sourceInterval:[1334,1337]},"}"]]]]],name:["define",{sourceInterval:[1342,1382]},"a name",[],["seq",{sourceInterval:[1363,1382]},["app",{sourceInterval:[1363,1372]},"nameFirst",[]],["star",{sourceInterval:[1373,1382]},["app",{sourceInterval:[1373,1381]},"nameRest",[]]]]],nameFirst:["define",{sourceInterval:[1386,1418]},null,[],["alt",{sourceInterval:[1402,1418]},["terminal",{sourceInterval:[1402,1405]},"_"],["app",{sourceInterval:[1412,1418]},"letter",[]]]],nameRest:["define",{sourceInterval:[1422,1452]},null,[],["alt",{sourceInterval:[1437,1452]},["terminal",{sourceInterval:[1437,1440]},"_"],["app",{sourceInterval:[1447,1452]},"alnum",[]]]],ident:["define",{sourceInterval:[1456,1489]},"an identifier",[],["app",{sourceInterval:[1485,1489]},"name",[]]],terminal:["define",{sourceInterval:[1493,1531]},null,[],["seq",{sourceInterval:[1508,1531]},["terminal",{sourceInterval:[1508,1512]},'"'],["star",{sourceInterval:[1513,1526]},["app",{sourceInterval:[1513,1525]},"terminalChar",[]]],["terminal",{sourceInterval:[1527,1531]},'"']]],oneCharTerminal:["define",{sourceInterval:[1535,1579]},null,[],["seq",{sourceInterval:[1557,1579]},["terminal",{sourceInterval:[1557,1561]},'"'],["app",{sourceInterval:[1562,1574]},"terminalChar",[]],["terminal",{sourceInterval:[1575,1579]},'"']]],terminalChar:["define",{sourceInterval:[1583,1660]},null,[],["alt",{sourceInterval:[1602,1660]},["app",{sourceInterval:[1602,1612]},"escapeChar",[]],["seq",{sourceInterval:[1621,1660]},["not",{sourceInterval:[1621,1626]},["terminal",{sourceInterval:[1622,1626]},"\\"]],["not",{sourceInterval:[1627,1632]},["terminal",{sourceInterval:[1628,1632]},'"']],["not",{sourceInterval:[1633,1638]},["terminal",{sourceInterval:[1634,1638]},`
`]],["range",{sourceInterval:[1639,1660]},"\0","􏿿"]]]],escapeChar_backslash:["define",{sourceInterval:[1703,1758]},null,[],["terminal",{sourceInterval:[1703,1709]},"\\\\"]],escapeChar_doubleQuote:["define",{sourceInterval:[1765,1822]},null,[],["terminal",{sourceInterval:[1765,1771]},'\\"']],escapeChar_singleQuote:["define",{sourceInterval:[1829,1886]},null,[],["terminal",{sourceInterval:[1829,1835]},"\\'"]],escapeChar_backspace:["define",{sourceInterval:[1893,1948]},null,[],["terminal",{sourceInterval:[1893,1898]},"\\b"]],escapeChar_lineFeed:["define",{sourceInterval:[1955,2009]},null,[],["terminal",{sourceInterval:[1955,1960]},"\\n"]],escapeChar_carriageReturn:["define",{sourceInterval:[2016,2076]},null,[],["terminal",{sourceInterval:[2016,2021]},"\\r"]],escapeChar_tab:["define",{sourceInterval:[2083,2132]},null,[],["terminal",{sourceInterval:[2083,2088]},"\\t"]],escapeChar_unicodeCodePoint:["define",{sourceInterval:[2139,2243]},null,[],["seq",{sourceInterval:[2139,2221]},["terminal",{sourceInterval:[2139,2145]},"\\u{"],["app",{sourceInterval:[2146,2154]},"hexDigit",[]],["opt",{sourceInterval:[2155,2164]},["app",{sourceInterval:[2155,2163]},"hexDigit",[]]],["opt",{sourceInterval:[2165,2174]},["app",{sourceInterval:[2165,2173]},"hexDigit",[]]],["opt",{sourceInterval:[2188,2197]},["app",{sourceInterval:[2188,2196]},"hexDigit",[]]],["opt",{sourceInterval:[2198,2207]},["app",{sourceInterval:[2198,2206]},"hexDigit",[]]],["opt",{sourceInterval:[2208,2217]},["app",{sourceInterval:[2208,2216]},"hexDigit",[]]],["terminal",{sourceInterval:[2218,2221]},"}"]]],escapeChar_unicodeEscape:["define",{sourceInterval:[2250,2309]},null,[],["seq",{sourceInterval:[2250,2291]},["terminal",{sourceInterval:[2250,2255]},"\\u"],["app",{sourceInterval:[2256,2264]},"hexDigit",[]],["app",{sourceInterval:[2265,2273]},"hexDigit",[]],["app",{sourceInterval:[2274,2282]},"hexDigit",[]],["app",{sourceInterval:[2283,2291]},"hexDigit",[]]]],escapeChar_hexEscape:["define",{sourceInterval:[2316,2371]},null,[],["seq",{sourceInterval:[2316,2339]},["terminal",{sourceInterval:[2316,2321]},"\\x"],["app",{sourceInterval:[2322,2330]},"hexDigit",[]],["app",{sourceInterval:[2331,2339]},"hexDigit",[]]]],escapeChar:["define",{sourceInterval:[1664,2371]},"an escape sequence",[],["alt",{sourceInterval:[1703,2371]},["app",{sourceInterval:[1703,1709]},"escapeChar_backslash",[]],["app",{sourceInterval:[1765,1771]},"escapeChar_doubleQuote",[]],["app",{sourceInterval:[1829,1835]},"escapeChar_singleQuote",[]],["app",{sourceInterval:[1893,1898]},"escapeChar_backspace",[]],["app",{sourceInterval:[1955,1960]},"escapeChar_lineFeed",[]],["app",{sourceInterval:[2016,2021]},"escapeChar_carriageReturn",[]],["app",{sourceInterval:[2083,2088]},"escapeChar_tab",[]],["app",{sourceInterval:[2139,2221]},"escapeChar_unicodeCodePoint",[]],["app",{sourceInterval:[2250,2291]},"escapeChar_unicodeEscape",[]],["app",{sourceInterval:[2316,2339]},"escapeChar_hexEscape",[]]]],space:["extend",{sourceInterval:[2375,2394]},null,[],["app",{sourceInterval:[2387,2394]},"comment",[]]],comment_singleLine:["define",{sourceInterval:[2412,2458]},null,[],["seq",{sourceInterval:[2412,2443]},["terminal",{sourceInterval:[2412,2416]},"//"],["star",{sourceInterval:[2417,2429]},["seq",{sourceInterval:[2418,2427]},["not",{sourceInterval:[2418,2423]},["terminal",{sourceInterval:[2419,2423]},`
`]],["app",{sourceInterval:[2424,2427]},"any",[]]]],["lookahead",{sourceInterval:[2430,2443]},["alt",{sourceInterval:[2432,2442]},["terminal",{sourceInterval:[2432,2436]},`
`],["app",{sourceInterval:[2439,2442]},"end",[]]]]]],comment_multiLine:["define",{sourceInterval:[2465,2501]},null,[],["seq",{sourceInterval:[2465,2487]},["terminal",{sourceInterval:[2465,2469]},"/*"],["star",{sourceInterval:[2470,2482]},["seq",{sourceInterval:[2471,2480]},["not",{sourceInterval:[2471,2476]},["terminal",{sourceInterval:[2472,2476]},"*/"]],["app",{sourceInterval:[2477,2480]},"any",[]]]],["terminal",{sourceInterval:[2483,2487]},"*/"]]],comment:["define",{sourceInterval:[2398,2501]},null,[],["alt",{sourceInterval:[2412,2501]},["app",{sourceInterval:[2412,2443]},"comment_singleLine",[]],["app",{sourceInterval:[2465,2487]},"comment_multiLine",[]]]],tokens:["define",{sourceInterval:[2505,2520]},null,[],["star",{sourceInterval:[2514,2520]},["app",{sourceInterval:[2514,2519]},"token",[]]]],token:["define",{sourceInterval:[2524,2600]},null,[],["alt",{sourceInterval:[2532,2600]},["app",{sourceInterval:[2532,2540]},"caseName",[]],["app",{sourceInterval:[2543,2550]},"comment",[]],["app",{sourceInterval:[2553,2558]},"ident",[]],["app",{sourceInterval:[2561,2569]},"operator",[]],["app",{sourceInterval:[2572,2583]},"punctuation",[]],["app",{sourceInterval:[2586,2594]},"terminal",[]],["app",{sourceInterval:[2597,2600]},"any",[]]]],operator:["define",{sourceInterval:[2604,2669]},null,[],["alt",{sourceInterval:[2615,2669]},["terminal",{sourceInterval:[2615,2619]},"<:"],["terminal",{sourceInterval:[2622,2625]},"="],["terminal",{sourceInterval:[2628,2632]},":="],["terminal",{sourceInterval:[2635,2639]},"+="],["terminal",{sourceInterval:[2642,2645]},"*"],["terminal",{sourceInterval:[2648,2651]},"+"],["terminal",{sourceInterval:[2654,2657]},"?"],["terminal",{sourceInterval:[2660,2663]},"~"],["terminal",{sourceInterval:[2666,2669]},"&"]]],punctuation:["define",{sourceInterval:[2673,2709]},null,[],["alt",{sourceInterval:[2687,2709]},["terminal",{sourceInterval:[2687,2690]},"<"],["terminal",{sourceInterval:[2693,2696]},">"],["terminal",{sourceInterval:[2699,2702]},","],["terminal",{sourceInterval:[2705,2709]},"--"]]]}]);const Ze=Object.create(d.prototype);function kt(r,e){for(const t in r)if(t===e)return!0;return!1}function Mt(r,e,t){const n=new Ne;let s,i,o,a=!1;return(t||Ye).createSemantics().addOperation("visit",{Grammars(c){return c.children.map(l=>l.visit())},Grammar(c,l,p,f,g){const S=c.visit();s=n.newGrammar(S),l.child(0)&&l.child(0).visit(),f.children.map(z=>z.visit());const b=s.build();if(b.source=this.source.trimmed(),kt(e,S))throw sr(b);return e[S]=b,b},SuperGrammar(c,l){const p=l.visit();if(p==="null")s.withSuperGrammar(null);else{if(!e||!kt(e,p))throw nr(p,e,l.source);s.withSuperGrammar(e[p])}},Rule_define(c,l,p,f,g){i=c.visit(),o=l.children.map(X=>X.visit())[0]||[],!s.defaultStartRule&&s.ensureSuperGrammar()!==j.ProtoBuiltInRules&&s.withDefaultStartRule(i);const S=g.visit(),b=p.children.map(X=>X.visit())[0],z=this.source.trimmed();return s.define(i,o,S,b,z)},Rule_override(c,l,p,f){i=c.visit(),o=l.children.map(b=>b.visit())[0]||[];const g=this.source.trimmed();s.ensureSuperGrammarRuleForOverriding(i,g),a=!0;const S=f.visit();return a=!1,s.override(i,o,S,null,g)},Rule_extend(c,l,p,f){i=c.visit(),o=l.children.map(b=>b.visit())[0]||[];const g=f.visit(),S=this.source.trimmed();return s.extend(i,o,g,null,S)},RuleBody(c,l){return n.alt(...l.visit()).withSource(this.source)},OverrideRuleBody(c,l){const p=l.visit(),f=p.indexOf(Ze);if(f>=0){const g=p.slice(0,f),S=p.slice(f+1);return S.forEach(b=>{if(b===Ze)throw fr(b)}),new be(s.superGrammar,i,g,S).withSource(this.source)}else return n.alt(...p).withSource(this.source)},Formals(c,l,p){return l.visit()},Params(c,l,p){return l.visit()},Alt(c){return n.alt(...c.visit()).withSource(this.source)},TopLevelTerm_inline(c,l){const p=i+"_"+l.visit(),f=c.visit(),g=this.source.trimmed(),S=!(s.superGrammar&&s.superGrammar.rules[p]);a&&!S?s.override(p,o,f,null,g):s.define(p,o,f,null,g);const b=o.map(z=>n.app(z));return n.app(p,b).withSource(f.source)},OverrideTopLevelTerm_superSplice(c){return Ze},Seq(c){return n.seq(...c.children.map(l=>l.visit())).withSource(this.source)},Iter_star(c,l){return n.star(c.visit()).withSource(this.source)},Iter_plus(c,l){return n.plus(c.visit()).withSource(this.source)},Iter_opt(c,l){return n.opt(c.visit()).withSource(this.source)},Pred_not(c,l){return n.not(l.visit()).withSource(this.source)},Pred_lookahead(c,l){return n.lookahead(l.visit()).withSource(this.source)},Lex_lex(c,l){return n.lex(l.visit()).withSource(this.source)},Base_application(c,l){const p=l.children.map(f=>f.visit())[0]||[];return n.app(c.visit(),p).withSource(this.source)},Base_range(c,l,p){return n.range(c.visit(),p.visit()).withSource(this.source)},Base_terminal(c){return n.terminal(c.visit()).withSource(this.source)},Base_paren(c,l,p){return l.visit()},ruleDescr(c,l,p){return l.visit()},ruleDescrText(c){return this.sourceString.trim()},caseName(c,l,p,f,g){return p.visit()},name(c,l){return this.sourceString},nameFirst(c){},nameRest(c){},terminal(c,l,p){return l.children.map(f=>f.visit()).join("")},oneCharTerminal(c,l,p){return l.visit()},escapeChar(c){try{return ut(this.sourceString)}catch(l){throw l instanceof RangeError&&l.message.startsWith("Invalid code point ")?dr(c):l}},NonemptyListOf(c,l,p){return[c.visit()].concat(p.children.map(f=>f.visit()))},EmptyListOf(){return[]},_terminal(){return this.sourceString}})(r).visit()}var qr=Ke(["grammar",{source:`OperationsAndAttributes {

  AttributeSignature =
    name

  OperationSignature =
    name Formals?

  Formals
    = "(" ListOf<name, ","> ")"

  name  (a name)
    = nameFirst nameRest*

  nameFirst
    = "_"
    | letter

  nameRest
    = "_"
    | alnum

}`},"OperationsAndAttributes",null,"AttributeSignature",{AttributeSignature:["define",{sourceInterval:[29,58]},null,[],["app",{sourceInterval:[54,58]},"name",[]]],OperationSignature:["define",{sourceInterval:[62,100]},null,[],["seq",{sourceInterval:[87,100]},["app",{sourceInterval:[87,91]},"name",[]],["opt",{sourceInterval:[92,100]},["app",{sourceInterval:[92,99]},"Formals",[]]]]],Formals:["define",{sourceInterval:[104,143]},null,[],["seq",{sourceInterval:[118,143]},["terminal",{sourceInterval:[118,121]},"("],["app",{sourceInterval:[122,139]},"ListOf",[["app",{sourceInterval:[129,133]},"name",[]],["terminal",{sourceInterval:[135,138]},","]]],["terminal",{sourceInterval:[140,143]},")"]]],name:["define",{sourceInterval:[147,187]},"a name",[],["seq",{sourceInterval:[168,187]},["app",{sourceInterval:[168,177]},"nameFirst",[]],["star",{sourceInterval:[178,187]},["app",{sourceInterval:[178,186]},"nameRest",[]]]]],nameFirst:["define",{sourceInterval:[191,223]},null,[],["alt",{sourceInterval:[207,223]},["terminal",{sourceInterval:[207,210]},"_"],["app",{sourceInterval:[217,223]},"letter",[]]]],nameRest:["define",{sourceInterval:[227,257]},null,[],["alt",{sourceInterval:[242,257]},["terminal",{sourceInterval:[242,245]},"_"],["app",{sourceInterval:[252,257]},"alnum",[]]]]}]);Br(j.BuiltInRules),jr(qr);function Br(r){const e={empty(){return this.iteration()},nonEmpty(t,n,s){return this.iteration([t].concat(s.children))},self(...t){return this}};H.BuiltInSemantics=H.createSemantics(r,null).addOperation("asIteration",{emptyListOf:e.empty,nonemptyListOf:e.nonEmpty,EmptyListOf:e.empty,NonemptyListOf:e.nonEmpty,_iter:e.self})}function jr(r){H.prototypeGrammarSemantics=r.createSemantics().addOperation("parse",{AttributeSignature(e){return{name:e.parse(),formals:[]}},OperationSignature(e,t){return{name:e.parse(),formals:t.children.map(n=>n.parse())[0]||[]}},Formals(e,t,n){return t.asIteration().children.map(s=>s.parse())},name(e,t){return this.sourceString}}),H.prototypeGrammar=r}function Gr(r){let e=0;const t=[0],n=()=>t[t.length-1],s={},i=/( *).*(?:$|\r?\n|\r)/g;let o;for(;(o=i.exec(r))!=null;){const[a,u]=o;if(a.length===0)break;const h=u.length,c=n(),l=e+h;if(h>c)t.push(h),s[l]=1;else if(h<c){const p=t.length;for(;n()!==h;)t.pop();s[l]=-1*(p-t.length)}e+=a.length}return t.length>1&&(s[e]=1-t.length),s}const Tt="an indented block",Dt="a dedent",$t=1114112;class Ur extends Oe{constructor(e){super(e.input),this.state=e}_indentationAt(e){return this.state.userData[e]||0}atEnd(){return super.atEnd()&&this._indentationAt(this.pos)===0}next(){if(this._indentationAt(this.pos)!==0){this.examinedLength=Math.max(this.examinedLength,this.pos);return}return super.next()}nextCharCode(){return this._indentationAt(this.pos)!==0?(this.examinedLength=Math.max(this.examinedLength,this.pos),$t):super.nextCharCode()}nextCodePoint(){return this._indentationAt(this.pos)!==0?(this.examinedLength=Math.max(this.examinedLength,this.pos),$t):super.nextCodePoint()}}class qt extends d{constructor(e=!0){super(),this.isIndent=e}allowsSkippingPrecedingSpace(){return!0}eval(e){const{inputStream:t}=e,n=e.userData;e.doNotMemoize=!0;const s=t.pos,i=this.isIndent?1:-1;return(n[s]||0)*i>0?(e.userData=Object.create(n),e.userData[s]-=i,e.pushBinding(new ue(0),s),!0):(e.processFailure(s,this),!1)}getArity(){return 1}_assertAllApplicationsAreValid(e,t){}_isNullable(e,t){return!1}assertChoicesHaveUniformArity(e){}assertIteratedExprsAreNotNullable(e){}introduceParams(e){return this}substituteParams(e){return this}toString(){return this.isIndent?"indent":"dedent"}toDisplayString(){return this.toString()}toFailure(e){const t=this.isIndent?Tt:Dt;return new V(this,t,"description")}}const Vr=new I("indent"),Hr=new I("dedent"),zr=new be(We,"any",[Vr,Hr],[]),Kr=new Ne().newGrammar("IndentationSensitive").withSuperGrammar(We).define("indent",[],new qt(!0),Tt,void 0,!0).define("dedent",[],new qt(!1),Dt,void 0,!0).extend("any",[],zr,"any character",void 0).build();Object.assign(Kr,{_matchStateInitializer(r){r.userData=Gr(r.input),r.inputStream=new Ur(r)},supportsIncrementalParsing:!1}),j.initApplicationParser(Ye,Mt);const Wr=r=>!!r.constructor&&typeof r.constructor.isBuffer=="function"&&r.constructor.isBuffer(r);function Yr(r,e){const t=Ye.match(r,"Grammars");if(t.failed())throw rr(t);return Mt(t,e)}function Zr(r,e){const t=Jr(r),n=Object.keys(t);if(n.length===0)throw new Error("Missing grammar definition");if(n.length>1){const i=t[n[1]].source;throw new Error(qe(i.sourceString,i.startIdx)+"Found more than one grammar definition -- use ohm.grammars() instead.")}return t[n[0]]}function Jr(r,e){const t=Object.create({});if(typeof r!="string")if(Wr(r))r=r.toString();else throw new TypeError("Expected string as first argument, got "+Me(r));return Yr(r,t),t}const oe=48e3,W=1/oe,Le=2*Math.PI,Bt=0,Je=1,jt=2,Qr=3,Xr=4,en=5,tn=6,rn=7,nn=8,Qe=new Map([["gain",Bt],["tempo",Je],["glide",jt],["slide",Qr],["pressure",Xr],["paramA",en],["paramB",tn],["paramC",rn],["paramD",nn]]);class y{constructor(e,t){this.defaultParamValues=e,this.makeSignal=t}static make(e,t){return new y(e,t)}new(e){const t={...e};for(const[n,s]of Object.entries(this.defaultParamValues))e.hasOwnProperty(n)||(t[n]=s());return this.makeSignal(t)}paramNames(){return Object.keys(this.defaultParamValues)}}class w{constructor(e,t){this.defaultParamValues=e,this.codegenFn=t}static make(e,t){return new w(e,t)}codegen(e){return this.codegenFn({...this.defaultParamValues,...e})}paramNames(){return Object.keys(this.defaultParamValues)}}const Xe={"unary-":w.make({x:"0"},r=>`(-${r.x})`),"+":w.make({x:"0",y:"0"},r=>`(${r.x} + ${r.y})`),"-":w.make({x:"0",y:"0"},r=>`(${r.x} - ${r.y})`),"*":w.make({x:"0",y:"0"},r=>`(${r.x} * ${r.y})`),"/":w.make({x:"0",y:"0"},r=>`(${r.x} / ifZero(${r.y}, 0.00001))`),"%":w.make({x:"0",y:"0"},r=>`(${r.x} % ifZero(${r.y}, 0.00001))`),clamp:w.make({input:"0",min:"0",max:"1"},r=>`Math.min(Math.max(${r.input}, ${r.min}), ${r.max})`),min:w.make({input:"0",y:"0"},r=>`Math.min(${r.input}, ${r.y})`),max:w.make({input:"0",y:"0"},r=>`Math.max(${r.input}, ${r.y})`),round:w.make({input:"0"},r=>`Math.round(${r.input})`),abs:w.make({input:"0"},r=>`Math.abs(${r.input})`),sqrt:w.make({input:"0"},r=>`Math.sqrt(${r.input})`),norm:w.make({input:"0",min:"-1",max:"1"},r=>`((input, min, max) => max <= min ? 0 : (input - min) / (max - min))(${r.input}, ${r.min}, ${r.max})`),scale:w.make({input:"0",min:"0",max:"1"},r=>`((input, min, max) => input * (max - min) + min)(${r.input}, ${r.min}, ${r.max})`),escale:w.make({input:"0",min:"0",max:"1"},r=>`((input, min, max) => {
      if (min === 0) {
        min = 0.001;
      }
      return min * Math.pow(max / min, input);
    })(${r.input}, ${r.min}, ${r.max})`),semitones:w.make({input:"0"},r=>`Math.pow(2, ${r.input} / 12)`),quantizeFreq:w.make({input:"0",base:"440"},r=>`((input, base) => (base * Math.pow(2, Math.round(12 * Math.log2(input / base)) / 12)))(${r.input}, ${r.base})`),switch2:w.make({input:"0",pos:"0",neg:"0"},r=>`(${r.input} >= 0 ? ${r.pos} : ${r.neg})`),switch3:w.make({input:"0",neg:"0",zero:"0",pos:"0"},r=>`((input, neg, zero, pos) => input === 0 ? zero : input < 0 ? neg : pos)(${r.input}, ${r.neg}, ${r.zero}, ${r.pos})`),softClip:w.make({input:"0"},r=>`((input) => input <= -1 ? -2/3 : input >= 1 ? 2/3 : input - input ** 3 / 3)(${r.input})`)},Gt={noise:()=>v.new(()=>Math.random()*2-1),pinkNoise:()=>{const e=new Array(16).fill(0);let t=0,n=0;return v.new(()=>(t-=e[n],e[n]=2*Math.random()-1,t+=e[n],n=(n+1)%16,t/16))},noteFreq:()=>v.new(r=>r.noteFreq*Math.pow(2,r.params[jt]/12)),noteVel:()=>v.new(r=>r.noteVel)};function sn(r,e,t){let n="off",s=0;return v.new({nextSample(){switch(n){case"off":s=0;break;case"a":s=e.value>0?Math.min(s+W/e.value,1):1,s===1&&(n="d");break;case"d":s=t.value>0?Math.max(s-W/t.value,0):0,s===0&&(n="off");break}return s*r.value},initialValue:0,noteOn(){n="a"}})}function on(r,e,t,n,s){let i="off",o=0;return v.new({nextSample(){switch(i){case"off":o=0;break;case"a":o=e.value>0?Math.min(o+W/e.value,1):1,o===1&&(i="d");break;case"d":o=t.value>0?Math.max(o-W/t.value,n.value):n.value,o===n.value&&(i="s");break;case"s":break;case"r":o=s.value>0?Math.max(o-W/s.value,0):0,o===0&&(i="off");break}return o*r.value},initialValue:0,noteOn(){i="a"},noteOff(){i="r"}})}function an(r,e){let t="off",n=0;return v.new({nextSample(){let s;switch(t){case"off":s=0;break;case"on":e.value>0&&n++>=e.value*oe?(t="off",s=0):s=1;break}return s*r.value},initialValue:0,noteOn(){t="on",n=0},noteOff(){e||(t="off")}})}function cn(r,e){let t=r.value;return v.new(()=>{if(e.value===0)t=r.value;else{const n=W/e.value,s=r.value-t;s>n?t+=n:s<-n?t-=n:t=r.value}return t})}function Ut(r,e,t){let n=r.value,s=!1;return v.new({nextSample(){if(e.value===0)n=r.value;else if(s)n=r.value,s=!1;else{const i=Math.pow(2,1/(e.value*oe));n<r.value?n=Math.min(n*i,r.value):n>r.value&&(n=Math.max(n/i,r.value))}return n},initialValue:n,noteOn(i,o){t&&!o&&i.noteNums.length===1&&(s=!0)}})}function Vt(r){return 440*Math.pow(2,(r-69)/12)}function ln(r,e){const t=Math.floor(e),n=e-t,s=r[t-1<0?r.length-1:t-1],i=r[t],o=r[(t+1)%r.length],a=r[(t+2)%r.length],u=(o-s)/2,h=i-o,c=u+h,l=c+h+(a-i)/2,p=c+l;return((l*n-p)*n+u)*n+i}function Ht(r){if(r>3)return 1;if(r<-3)return-1;{const e=r*r;return r*(27+e)/(27+9*e)}}function Re(r,e,t){return Math.max(e,Math.min(r,t))}const zt=10,un=zt*oe;function pn(r,e){const t=un,n=new Float32Array(t);let s=0;return v.new(()=>{let i=s-Math.min(e.value,zt)*oe;return i<0&&(i+=t),n[s++]=r.value,s>=t&&(s=0),ln(n,i)})}const et=4,Kt=1/et,hn=1/(oe*et),mn=1.8,fn=5,dn=oe*.425,gn=1e-5,tt=.95;function J(r,e,t,n){let s=[0,0,0,0],i=[0,0,0,0],o=1,a=1,u=1,h=0,c=1,l=1,p=0;function f(){const x=Re(t.value,fn,dn)*Le*hn,R=x*x,_=x*R,K=x*_;o=.9892*x-.4324*R+.1381*_-.0202*K,u=1.006+.0536*x-.095*R-.05*K}function g(){a=4*Re(n.value,0,1)*mn}function S(x){c=Math.max(x,0),c>1?(c=Math.min(c,4),l=1+(c-1)*(1-h)):l=c}function b(x){h=Re(x,0,.5),S(c)}function z(x,R){let _=x*.76923077+.23076923*s[R]-i[R];return _=_*o+i[R],i[R]=_,s[R]=x,_}function X(x,R,_,K,T){switch(r){case"lp24":return T;case"lp12":return _;case"bp24":return(_+T)*4-K*8;case"bp12":return(R-_)*2;case"hp24":return x+T-(R+K)*4+_*6;case"hp12":return x+_-R*2;default:return 0}}return S(1),b(.5),v.new(()=>{f(),g();let x=e.value*l;if(Math.abs(x)<gn){for(let T=0;T<4;T++)s[T]*=tt,i[T]*=tt;p*=tt}let _=0,K=0;for(let T=0;T<et;T++){const ye=K*p+(1-K)*x,he=Ht(ye-(i[3]-h*ye)*a*u),ee=z(he,0),te=z(ee,1),re=z(te,2),ne=z(re,3);_+=X(he,ee,te,re,ne)*Kt,K+=Kt}return p=x,_})}const Wt={sine:y.make({input:()=>m(440)},r=>{const e=r.input;let t=0;return v.new(()=>{const n=Math.sin(t*Le),s=e.value*W;return t+=s,t-=Math.floor(t),n})}),saw:y.make({input:()=>m(440)},r=>{const e=r.input;let t=0;return v.new(()=>{const n=2*t-1,s=e.value*W,i=n-ve(t,s);return t+=s,t-=Math.floor(t),i})}),tri:y.make({input:()=>m(440)},r=>{const e=r.input;let t=0,n=0;return v.new(()=>{const s=e.value*W,i=(t>=.25&&t<.75?-1:1)-ve((t+.75)%1,s)+ve((t+.25)%1,s);return n=.999*n+i*s*4,t+=s,t-=Math.floor(t),n})}),pulse:y.make({input:()=>m(440),w:()=>m(.5),sync:()=>m(0)},r=>{const{input:e,w:t,sync:n}=r;let s=0,i=0;return v.new(()=>{const o=s<t.value?-1:1,a=e.value*W,u=o-ve(s,a)+ve((s-t.value+1)%1,a);let h=!1;if(i<0&&n.value>=0){const c=-i/(n.value-i);s=Math.floor((1-c)*a),h=!0}return i=n.value,h||(s+=a,s-=Math.floor(s)),u})}),lglide:y.make({input:()=>m(0),t:()=>m(.1)},r=>cn(r.input,r.t)),eglide:y.make({input:()=>m(0),t:()=>m(1)},r=>Ut(r.input,r.t,!1)),legato:y.make({input:()=>m(0),t:()=>m(1)},r=>Ut(r.input,r.t,!0)),ad:y.make({input:()=>m(1),a:()=>m(0),d:()=>m(.2)},r=>sn(r.input,r.a,r.d)),adsr:y.make({input:()=>m(1),a:()=>m(0),d:()=>m(0),s:()=>m(1),r:()=>m(.2)},r=>on(r.input,r.a,r.d,r.s,r.r)),gate:y.make({input:()=>m(1),t:()=>m(0)},r=>an(r.input,r.t)),lpf:y.make({input:()=>m(0),cf:()=>m(1e3),q:()=>m(.2)},r=>J("lp24",r.input,r.cf,r.q)),lpf12:y.make({input:()=>m(0),cf:()=>m(1e3),q:()=>m(.2)},r=>J("lp12",r.input,r.cf,r.q)),lpf24:y.make({input:()=>m(0),cf:()=>m(1e3),q:()=>m(.2)},r=>J("lp24",r.input,r.cf,r.q)),hpf:y.make({input:()=>m(0),cf:()=>m(1e3),q:()=>m(.2)},r=>J("hp24",r.input,r.cf,r.q)),hpf12:y.make({input:()=>m(0),cf:()=>m(1e3),q:()=>m(.2)},r=>J("hp12",r.input,r.cf,r.q)),hpf24:y.make({input:()=>m(0),cf:()=>m(1e3),q:()=>m(.2)},r=>J("hp24",r.input,r.cf,r.q)),bpf:y.make({input:()=>m(0),cf:()=>m(1e3),q:()=>m(.2)},r=>J("bp24",r.input,r.cf,r.q)),bpf12:y.make({input:()=>m(0),cf:()=>m(1e3),q:()=>m(.2)},r=>J("bp12",r.input,r.cf,r.q)),bpf24:y.make({input:()=>m(0),cf:()=>m(1e3),q:()=>m(.2)},r=>J("bp24",r.input,r.cf,r.q)),delay:y.make({input:()=>m(0),t:()=>m(.25)},r=>pn(r.input,r.t)),beats:y.make({input:()=>m(.25)},r=>{const e=r.input;return v.new(t=>60/t.params[Je]*e.value)}),latch:y.make({input:()=>m(0),useLastValue:()=>m(0)},r=>{const{input:e,useLastValue:t}=r;let n=0;return v.new(()=>(t.value===0&&(n=e.value),n))}),dcBlock:y.make({input:()=>m(0)},r=>{const{input:e}=r,t=.995;let n=0,s=0;return v.new(()=>{const i=e.value,o=i-n+t*s;return n=i,s=o,o})}),junoChorus:y.make({input:()=>m(0),type:()=>m(0)},r=>{const{input:e,type:t}=r,n=2048,s=n-1,i=.4,o=.5,a=40,u=60,h=400,c=480,l=.7,p=.6,f=.86,g=80,S=100,b=300,z=350,X=.7,x=new Float32Array(n),R=new Float32Array(n);let _=0,K=0,T=0;const ye=(he,ee)=>{const te=ee%n,re=te<0?te+n:te,ne=Math.floor(re),xe=ne+1&s,Se=re-ne,me=he[ne],_e=he[xe];return me+(_e-me)*Se};return v.new({nextSample(he){const ee=e.value,te=t.value;let re,ne,xe,Se,me,_e,Pe,st;if(te<1/3)st=ee;else{te<2/3?(re=i,ne=o,xe=a,Se=u,me=h,_e=c,Pe=l):(re=p,ne=f,xe=g,Se=S,me=b,_e=z,Pe=X);const Nn=Math.sin(K*Le),Ln=Math.sin(T*Le),Rn=me+Nn*xe,Pn=_e+Ln*Se;x[_]=ee,R[_]=ee;const Fn=_-Rn,Cn=_-Pn,kn=ye(x,Fn),Mn=ye(R,Cn),Tn=(kn+Mn)*.5;st=ee*(1-Pe)+Tn*Pe,K+=re*W,T+=ne*W,K-=Math.floor(K),T-=Math.floor(T),_=_+1&s}return st}})})};function ve(r,e){return r<e?(r/=e,r+r-r*r-1):r>1-e?(r=(r-1)/e,r*r+r+r+1):0}class Yt{constructor(e){this.errors=e}}class Ie extends Error{constructor(e,t){super(e),this.interval=t}}const Zt=Zr(String.raw`
  MSynth {
    Prog = Decl+

    Decl
      = ident "=" Expr

    Expr = ArrowExpr

    ArrowExpr
      = ArrowExpr ">>" ident Args?  -- send
      | AddExpr

    AddExpr
      = AddExpr "+" MulExpr  -- plus
      | AddExpr "-" MulExpr  -- minus
      | MulExpr

    MulExpr
      = MulExpr "*" NegExpr  -- times
      | MulExpr "/" NegExpr  -- div
      | MulExpr "%" NegExpr  -- mod
      | NegExpr

    NegExpr
      = "-" NegExpr  -- neg
      | SendExpr

    SendExpr
      = SendExpr ~(ident "=") ident Args?  -- send
      | PriExpr

    PriExpr
      = ident Args    -- call
      | ident         -- ref
      | number        -- num
      | "(" Expr ")"  -- par

    Args = "(" ListOf<Arg, ","> ")"

    Arg  (an argument)
      = ident ":" Expr  -- nameAndExpr
      | ident           -- nameIsExpr

    ident  (an identifier)
      = ~keyword "$"? letter alnum*

    number  (a number)
      = digit* "." digit+  -- fract
      | digit+             -- whole

    keyword = def | this
    def = "def" ~alnum
    this = "this" ~alnum

    space += "//" (~"\n" any)*  -- comment
  }
`);class rt{constructor(e){this.interval=e}}class vn extends rt{constructor(e,t){super(t),this.decls=e}checkDuplicateDeclarations(e){const t=new Set;for(const n of this.decls)t.has(n.name)?e.push(new Ie(`duplicate declaration of signal ${n.name}`,n.interval)):t.add(n.name)}checkCalls(e){for(const t of this.decls)t.checkCalls(e)}checkRefs(e){const t=new Set;this.addRefs(t);const n=new Set,s=new Set;for(const i of t){const o=Qt(i);o!==null?n.add(o):Qe.has(i)?n.add(Qe.get(i)):Gt.hasOwnProperty(i)?s.add(i):this.decls.some(a=>a.name===i)||e.push(new Ie(`undeclared reference: ${i}`,this.interval))}return{params:[...n],builtins:[...s]}}addRefs(e){for(const t of this.decls)t.addRefs(e)}trans(e){const t=s=>this.decls.some(i=>i.name===s);let n;return t("left")&&t("right")?n=["__left","__right"]:t("out")?n=["__out"]:n=["Signal.scalar(0)"],`(() => {
      ${e.params.map(s=>`const __param${s} = Signal.new((synth) => synth.params[${s}]);`).join(`
`)}
      ${[...Qe.entries()].filter(([s,i])=>e.params.includes(i)).map(([s,i])=>`const __${s} = __param${i};`).join(`
`)}
      ${e.builtins.map(s=>`const __${s} = __.${s}();`).join(`
`)}
      ${this.decls.map(s=>`let __${s.name};`).join(`
`)}
      ${this.decls.map(s=>s.trans()).join(`
`)}
      ${this.decls.map(s=>`__${s.name} = __${s.name}.force();`).join(`
`)}
      return [${n.join(", ")}];
    })()`}}class In extends rt{constructor(e,t,n){super(n),this.name=e,this.rhs=t}checkCalls(e){this.rhs.checkCalls(e)}addRefs(e){this.rhs.addRefs(e)}trans(){const e=[],t=this.rhs.trans("signal",e),n=e.length===0?t:`{
      ${e.map((s,i)=>`const tmp${i} = ${s};`).join(`
`)}
      return ${t};
    }`;return`__${this.name} = lazy(() => ${n});`}}class nt extends rt{constructor(e,t=[]){super(e),this.children=t}checkCalls(e){for(const t of this.children)t.checkCalls(e)}addRefs(e){for(const t of this.children)t.addRefs(e)}}class G{constructor(e,t,n){this.name=e,this.expr=t,this.interval=n}trans(e){return`${this.name}: ${this.expr.trans("signal",e)}`}}class Q extends nt{constructor(e,t,n){super(n,t.map(s=>s.expr)),this.name=e,this.args=t}checkCalls(e){super.checkCalls(e);const t=Xe[this.name]||Wt[this.name];if(!t){e.push(new Ie(`undeclared module: ${this.name}`,this.interval));return}for(const{name:n}of this.args)t.defaultParamValues.hasOwnProperty(n)||e.push(new Ie(`${n} is not a valid argument for module ${this.name}`,this.interval))}trans(e,t){let n;if(Xe.hasOwnProperty(this.name)){const s=Xe[this.name],i={};for(const{name:o,expr:a}of this.args)i[o]=a.trans("number",t);if(n=s.codegen(i),e==="signal"){const o=t.length;t.push(`Signal.new(() => ${n})`),n=`tmp${o}`}}else{const s=this.args.map(({name:o,expr:a})=>`${o}: ${a.trans("signal",t)}`).join(", ");n=`_.${this.name}.new({ ${s} })`;const i=t.length;t.push(n),n=`tmp${i}`,e==="number"&&(n=`${n}.value`)}return n}}class Jt extends nt{constructor(e,t){super(t),this.name=e}addRefs(e){e.add(this.name)}trans(e,t){const n=Qt(this.name),s=n!==null?`__param${n}`:`__${this.name}`;return e==="signal"?s:`${s}.value`}}class yn extends nt{constructor(e,t){super(t),this.value=e}trans(e){const t=""+this.value;return e==="number"?t:`Signal.scalar(${t})`}}function Qt(r){if(!(r.startsWith("param")&&[...r.slice(5)].every(t=>"0"<=t&&t<="9")))return null;const e=parseInt(r.slice(5));return 0<=e&&e<=127?e:null}const xn=Zt.createSemantics().addOperation("toAst",{Prog(r){return new vn(r.toAst(),this.source)},Decl(r,e,t){return new In(r.sourceString,t.toAst(),this.source)},ArrowExpr_send(r,e,t,n){return new Q(t.sourceString,[new G("input",r.toAst(),r.source),...n.child(0)?.toAst()??[]],this.source)},AddExpr_plus(r,e,t){return new Q("+",[new G("x",r.toAst(),r.source),new G("y",t.toAst(),t.source)],this.source)},AddExpr_minus(r,e,t){return new Q("-",[new G("x",r.toAst(),r.source),new G("y",t.toAst(),t.source)],this.source)},MulExpr_times(r,e,t){return new Q("*",[new G("x",r.toAst(),r.source),new G("y",t.toAst(),t.source)],this.source)},MulExpr_div(r,e,t){return new Q("/",[new G("x",r.toAst(),r.source),new G("y",t.toAst(),t.source)],this.source)},MulExpr_mod(r,e,t){return new Q("%",[new G("x",r.toAst(),r.source),new G("y",t.toAst(),t.source)],this.source)},NegExpr_neg(r,e){return new Q("unary-",[new G("x",e.toAst(),e.source)],this.source)},SendExpr_send(r,e,t){return new Q(e.sourceString,[new G("input",r.toAst(),r.source),...t.child(0)?.toAst()??[]],this.source)},PriExpr_call(r,e){return new Q(r.sourceString,e.toAst(),this.source)},PriExpr_ref(r){return new Jt(this.sourceString,this.source)},PriExpr_num(r){return new yn(parseFloat(this.sourceString),this.source)},PriExpr_par(r,e,t){return e.toAst()},Args(r,e,t){return e.toAst()},Arg_nameAndExpr(r,e,t){return new G(r.sourceString,t.toAst(),this.source)},Arg_nameIsExpr(r){return new G(r.sourceString,new Jt(r.sourceString,this.source),this.source)},ident(r,e,t){return this.sourceString},NonemptyListOf(r,e,t){return[r.toAst()].concat(t.toAst())},EmptyListOf(){return[]},_iter(...r){return r.map(e=>e.toAst())}});function Sn(r){const e=[],t=Zt.match(r);if(t.failed()){const o=t.getRightmostFailures().map(a=>a.type==="string"?`"${a.text}"`:a.text);throw o.length>1&&(o[o.length-1]="or "+o[o.length-1]),e.push(new Ie(`expected ${o.join(", ")}`,t.getInterval())),new Yt(e)}const n=xn(t).toAst();n.checkDuplicateDeclarations(e),n.checkCalls(e);const s=n.checkRefs(e);if(e.length>0)throw new Yt(e);const i=n.trans(s);return console.log(`compiled code:
`,i),()=>_n(i)}function _n(r){const e=Object.create(Wt),t=Gt,n=i=>{let o=null;const a=()=>(o||(o=i()),o),u=v.new({nextSample:h=>a().nextSample(h),initialValue:0,noteOn:(h,c)=>a().noteOn?.(h,c),noteOff:()=>a().noteOff?.()});return u.force=a,u},s=(i,o)=>i===0?o:i;return new Function("Signal","_","__","lazy","ifZero","fastTanh",`return ${r};`)(v,e,t,n,s,Ht)}class An{constructor(e,t,n,s){this.channel=e,this.outs=t,this.allSignals=n,this.params=s}noteNums=[];noteNum=0;noteFreq=0;noteVel=0;processMidiMessage([e,t,n]){if((e&15)===this.channel)switch(e>>4){case 9:{const i=t,o=n;o===0?this.noteOff(i,o):this.noteOn(i,o);break}case 8:{const i=t,o=n;this.noteOff(i,o);break}}}noteOn(e,t){this.noteNums.push(e),this.noteNum=e,this.noteFreq=Vt(e),this.noteVel=t/127,this.allSignals.forEach(n=>n.noteOn?.(this,!1))}noteOff(e,t){const n=this.noteNums.indexOf(e),s=n===this.noteNums.length-1;this.noteNums.splice(n,1);const i=this.noteNums.at(-1);i!=null&&s?(this.noteNum=i,this.noteFreq=Vt(i),this.allSignals.forEach(o=>o.noteOn?.(this,!0))):this.noteNums.length===0&&this.allSignals.forEach(o=>o.noteOff?.())}processFrame(e,t){this.allSignals.forEach(s=>s.computeSample(e,this));const n=this.params[Bt];if(this.outs.length===2&&t.length>=2)for(let s=0;s<2;s++){const i=this.outs[s].value*n;t[s][e]+=i}else{const s=this.outs[0].value*n;for(let i=0;i<t.length;i++)t[i][e]+=s}}}function wn(r,e,t){return new Uint8Array([144|r&15,e&127,t&127])}function bn(r,e,t){return new Uint8Array([128|r&15,e&127,t&127])}class On extends AudioWorkletProcessor{voiceParams=[];voices=[];sequencer=new En(this);constructor(){super(),this.port.onmessage=e=>this.onMessage(e.data)}sendMessage(e,t=[]){this.port.postMessage(e,t)}onMessage(e){switch(e.command){case"init":{this.voiceParams=e.voiceParams.map(t=>new Float32Array(t));break}case"load patch":{console.log("worklet loading patch",e.code);try{const t=Sn(e.code);this.voices=[];for(let n=0;n<(e.mono?1:this.voiceParams.length);n++){const s=[],i=v.doCollectingNewInstances(t,s);this.voices.push(new An(n,i,s,this.voiceParams[n]))}}catch(t){this.sendMessage({event:"log",message:`error loading patch: ${t.message}`}),console.error(t)}break}case"process midi message":{for(let t of this.voices)t.processMidiMessage(e.data);break}case"load steps":{this.sequencer.load(e.steps);break}case"set tempo":{this.sequencer.tempo=e.value;for(let t of this.voices)t.params[Je]=e.value;break}case"set trigger period":{this.sequencer.triggerPeriod=Math.max(.01,e.value);break}case"set note duration":{this.sequencer.noteDuration=Re(e.value,.01,.99);break}case"start sequencer":{this.sequencer.start();break}case"stop sequencer":{this.sequencer.stop();break}default:throw console.error("unsupported message",e),new Error("unsupported message!")}}process(e,[t],n){this.sequencer.run();const s=t[0].length;for(let i=0;i<s;i++)for(const o of this.voices)o.processFrame(i,t);return!0}}class En{constructor(e){this.synth=e}tempo=120;triggerPeriod=1/4;noteDuration=.5;steps=[];stepIdx=0;measuresSinceLastTrigger=1/0;playing=!1;load(e){this.playCurrentStep("noteOff"),this.steps=e,this.stepIdx=0}start(){this.playing=!0,this.stepIdx=0,this.measuresSinceLastTrigger=1/0}stop(){this.playCurrentStep("noteOff"),this.playing=!1}notesAreOn=!1;channelsUsed=[];run(){if(!(!this.playing||this.steps.length===0)){if(this.measuresSinceLastTrigger>=this.triggerPeriod){this.playCurrentStep("noteOn"),this.measuresSinceLastTrigger=0,this.synth.sendMessage({event:"seq step",index:this.stepIdx,action:"noteOn"});return}this.notesAreOn&&this.measuresSinceLastTrigger>=this.noteDuration*this.triggerPeriod&&(this.playCurrentStep("noteOff"),this.synth.sendMessage({event:"seq step",index:this.stepIdx,action:"noteOff"}),this.stepIdx=(this.stepIdx+1)%this.steps.length),this.measuresSinceLastTrigger+=this.tempo/oe}}playCurrentStep(e){const t=this.steps[this.stepIdx];t&&(e==="noteOn"?(this.channelsUsed=[],this.notesAreOn=!0):this.notesAreOn=!1,t.forEach((n,s)=>{let i;e==="noteOn"?(i=this.nextVoiceIdx(),this.channelsUsed.push(i)):i=this.channelsUsed[s],this.synth.voices[i]?.processMidiMessage((e==="noteOn"?wn:bn)(i,n,127))}))}lastVoiceIdx=-1;nextVoiceIdx(){const e=(this.lastVoiceIdx+1)%this.synth.voices.length;return this.lastVoiceIdx=e,e}}registerProcessor("msynth",On)})();
//# sourceMappingURL=msynth-worklet-C39bHXAS.js.map
