(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))e(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const o of r.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&e(o)}).observe(document,{childList:!0,subtree:!0});function t(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function e(i){if(i.ep)return;i.ep=!0;const r=t(i);fetch(i.href,r)}})();const ut=""+new URL("msynth-worklet-HlCev5aV.js",import.meta.url).href;function pt(s,t,e){return new Uint8Array([144|s&15,t&127,e&127])}function ft(s,t,e){return new Uint8Array([128|s&15,t&127,e&127])}const Q=96e3;function mt(s){return 440*Math.pow(2,(s-69)/12)}function O(s,t,e){return Math.max(t,Math.min(s,e))}class g{constructor(t,e,i){this.name=t,this.code=e,this.options=i}}const S=[new g("rebel yell",`
      ampEnv = adsr(0.03, 0, 1, 0.1)
      mod = param3 lglide(0.05) norm abs scale(0.45, 0.55)
      dry = noteFreq pwm(mod) lpf(6000, 0.2) * ampEnv
      out = dry + 0.5 * dry delay(0.4)
    `,{octave:1,mode:"mpe"}),new g("hello again",`
      sync = 0.6
      osc1 = (noteFreq / 4) pwm
      osc2 = sync * 500 * ad(0.2, 0.5) >> pwm(0.5, osc1)
      out = osc2 * adsr(0.05, 0, 1, 0.2)
    `,{octave:-1}),new g("duran duran",`
      decay = 0.102
      delayAmt = 0.547
      detuneAmt = 0.252
      portamento = paramA
      freq = (paramB abs - 0.5) ifPos(noteFreq * 2, noteFreq)
      f1 = freq eglide(portamento)
      f2 = f1 * detuneAmt escale(1.01, 1.05)
      oscs = (f1 pwm + f2 pwm) / 2
      dry = oscs * adsr(0, 0, 1, decay escale(0.1, 2))
      out = dry + delayAmt * dry delay(0.378)
    `,{mono:!0,mode:"piano"}),new g("stranger things",`
      release = paramA
      resonance = (paramB norm - 0.5) abs scale(0.15, 1)
      pwmRate = 0.218
      osc1 = noteFreq pwm(pwmRate sine norm scale(0.2, 0.8))
      osc2 = (2 * noteFreq * 1.005) pwm(pwmRate sine norm scale(0.4, 0.6))
      out = (osc1 + osc2) lpf(10000 * adsr(0.001, 0, 1, 0.5), resonance) * adsr(0, 0, 1, release)
    `,{octave:-2,paramA:.8,paramB:.5}),new g("tom sawyer",`
      resonance = paramA
      w = 0.5 + (1/5) sine norm scale(0, 0.4)
      detune1 = 0.091 * 0.01
      detune2 = 0.836 * 0.01
      delayAmt = paramB
      oscs =
        (
          (noteFreq * (1 - detune1)) pwm(w) +
          (noteFreq * (1 + detune1)) pwm(w) +
          (noteFreq * (1 - 3 * detune2)) pwm(w) +
          (noteFreq * (1 + 3 * detune2)) pwm(w)
        ) / 4
      filterEnv = adsr(0.05, 0, 1, 6) escale(0, 1)
      ampEnv = adsr(0, 0, 1, 12)
      dry = oscs lpf12(10000 * filterEnv, resonance) * ampEnv
      out = dry + delayAmt * dry delay(0.15) >> dcBlock
    `,{mode:"piano",octave:-2,paramA:.755,paramB:.127}),new g("guitar",`
      cutoff = paramA
      feedback = paramB scale(0.9, 0.999)
      burst  = noise * gate(0.005)
      filter = (burst + filter) delay(1 / noteFreq) lpf12(20000 * cutoff, 0) * feedback
      out = burst + filter * adsr(0, 0, 1, 0.1)
    `,{paramA:1,paramB:.99,octave:-1,mode:"strum"}),new g("12 string",`
      cutoff = paramA
      feedback = paramB scale(0.9, 0.999)
      burst  = noise * gate(0.005)
      string1 = (burst + string1) delay(1 / noteFreq) lpf12(20000 * cutoff, 0) * feedback
      string2 = (burst + string2) delay(1 / (noteFreq * 2)) lpf12(20000 * cutoff, 0) * feedback
      out = burst + (string1 + string2) * adsr(0, 0, 1, 0.1)
    `,{paramA:1,paramB:.99,octave:-1,mode:"strum"}),new g("strum bass",`
      out = noteFreq sine * ad(0.01, 5) * adsr(0, 0, 1, 0.1)
    `,{paramA:.2,paramB:1,octave:-2,mode:"strum"}),new g("rick and morty",`
      sound1 = noise bpf(0.2 sine * 800 + 1200, 1)
      sound2 = noise bpf(-(0.25 sine) * 800 + 1200, 1)
      ring = (sound1 + sound1 delay(2) + sound2) * 5.5 pwm norm * 0.5
      out = ring * adsr(0.01, 0, 1, 2)
    `),new g("pwm",`
      out = noteFreq pwm(slide lglide(0.05) norm scale(0.2, 0.8)) * adsr(0.05, 0, 1, 0.4)
    `),new g("pwm pencil",`
      out = noteFreq pwm(slide lglide(0.05) norm scale(0.2, 0.8)) * adsr(0.05, 0, 1, 0.4) * pressure
    `),new g("sine",`
      out = noteFreq sine * adsr(0.01, 0, 1, 0.3)
    `)],gt=document.getElementById("ui"),M=document.createElement("canvas"),n=M.getContext("2d");gt.appendChild(M);const c=2;let h=0,f=0,T=0,E=0,wt="18px sans-serif";function V(){M.style.width=innerWidth+"px",M.style.height=innerHeight+"px",M.width=innerWidth*devicePixelRatio,M.height=innerHeight*devicePixelRatio,n.scale(devicePixelRatio,devicePixelRatio),h=(innerWidth-2*c)/13,f=(innerHeight-2*c)/8,T=h*1.5,E=f/1.5}window.addEventListener("resize",V),V();const yt=8;let k="tap here";class vt{constructor(t,e){this.synth=t,this.channel=e,this.params=new Float32Array(new SharedArrayBuffer(512)),this.note=-1}noteOn(t,e){this.isOn&&this.noteOff(this.note,127),this.note=t,this.synth.sendToWorklet({command:"process midi message",data:pt(this.channel,t,e)})}noteOff(t,e){this.note=-1,this.synth.sendToWorklet({command:"process midi message",data:ft(this.channel,t,e)})}get isOn(){return this.note!==-1}get freq(){return mt(this.note)*Math.pow(2,this.params[0]/12)}set glide(t){this.params[0]=t}get glide(){return this.params[0]}set slide(t){this.params[1]=t}get slide(){return this.params[1]}set pressure(t){this.params[2]=t}get pressure(){return this.params[2]}set paramA(t){this.params[3]=t}get paramA(){return this.params[3]}set paramB(t){this.params[4]=t}get paramB(){return this.params[4]}set gain(t){this.params[5]=t}get gain(){return this.params[5]}}class j{constructor(t="pwm"){if(this.mode="mpe",this.worklet=null,this.voices=[],this.octave=0,this.analyzer=null,this.timeDomainData=null,this.lnf=220,this.patch=S.find(e=>e.name===t),!this.patch)throw new Error("unknown patch name! "+t);for(let e=0;e<yt;e++)this.voices.push(new vt(this,e))}init(){this.worklet=new AudioWorkletNode(A,"msynth"),this.sendToWorklet({command:"init",voiceParams:this.voices.map(e=>e.params.buffer)}),this.analyzer=A.createAnalyser(),this.analyzer.fftSize=2048;const t=this.analyzer.frequencyBinCount;this.timeDomainData=new Uint8Array(t),this.worklet.channelInterpretation="discrete",this.worklet.channelCount=2,this.worklet.channelCountMode="explicit",this.worklet.connect(this.analyzer).connect(A.destination),this.worklet.port.onmessage=e=>Wt(e.data),this.loadPatch(this.patch)}getTimeDomainData(){return!this.analyzer||!this.timeDomainData?null:(this.analyzer.getByteTimeDomainData(this.timeDomainData),this.timeDomainData)}toggleMode(){this.mode=this.mode==="mpe"?"piano":this.mode==="piano"?"guitar":this.mode==="guitar"?"strum":"mpe"}sendToWorklet(t){var e;(e=this.worklet)==null||e.port.postMessage(t)}loadPatch(t){var e,i,r,o,a;this.patch=t,this.sendToWorklet({command:"load patch",code:t.code,mono:((e=t.options)==null?void 0:e.mono)??!1}),this.setParam(3,((i=t.options)==null?void 0:i.paramA)??0),this.setParam(4,((r=t.options)==null?void 0:r.paramB)??0),this.setParam(5,.2),this.octave=((o=t.options)==null?void 0:o.octave)??0,this.mode=((a=t.options)==null?void 0:a.mode)??"mpe"}grabVoice(){var i;if((i=this.patch.options)!=null&&i.mono)return this.voices[0];const t=[...y.values()],e=this.voices.findLast(r=>!t.some(o=>o.voice===r))??this.voices.at(-1);return this.voices.splice(this.voices.indexOf(e),1),this.voices.unshift(e),e}setParam(t,e){for(const i of this.voices)i.params[t]=e}getLowestNoteFreq(){let t=1/0;for(const e of this.voices)e.isOn&&e.freq<t&&(t=e.freq);return Number.isFinite(t)&&(this.lnf=t),this.lnf}}const x=new j("rebel yell"),p=new j("stranger things");let m=x;const xt=47,bt=5,q=4;class Pt{constructor(t,e,i){this.col=t,this.row=e,this.noteName=i,this.isBeingPlayedBySequencer=!1}get note(){return xt+12*m.octave+bt*(7-this.row)+this.col}get x(){return c+this.col*h}get y(){return c+this.row*f}get centerX(){return this.x+h/2}get centerY(){return this.y+f/2}contains(t,e){return this.x<=t&&t<=this.x+h&&this.y<=e&&e<=this.y+f}render(){if(n.beginPath(),n.lineWidth=3,n.strokeStyle="#eee",n.roundRect(this.x,this.y,h,f,q),n.stroke(),m.mode==="strum"&&this.col===12){n.beginPath(),n.fillStyle="#aaa",n.roundRect(this.x,this.y,h,f,q),n.fill();return}n.beginPath(),n.fillStyle=this.noteName===""?"#ccc":"#ddd",n.roundRect(this.x,this.y,h,f,q),n.fill(),m===p&&this.isBeingPlayedBySequencer&&(n.beginPath(),n.fillStyle=this.noteName===""?"#eee":"#bbb",n.roundRect(this.x+20,this.y+20,h-40,f-40,q),n.fill()),this.noteName!==""&&(n.beginPath(),n.font="14px sans-serif",n.fillStyle="#bbb",n.fillText(this.noteName,this.x+4,this.y+16),n.fill())}}const l=[],kt=["C","","D","","E","F","","G","","A","","B"];let J=0;for(let s=2;s<=7;s++){for(let t=0;t<=12;t++)l.push(new Pt(t,s,kt[(J+t)%12]));J+=7}const y=new Map;class qt{constructor(){this.windowMs=150,this.history=[]}addPos(t){this.history.push({pos:t,t:performance.now()})}get speed(){const t=performance.now();if(this.history=this.history.filter(({t:r})=>t-r<=this.windowMs),this.history.length<2)return 0;let e=0;for(let r=1;r<this.history.length;r++)e+=Math.abs(this.history[r].pos-this.history[r-1].pos);const i=this.history[this.history.length-1].t-this.history[0].t;return e/i}}class D{constructor(t,e,i,r,o){this.id=t,this.x0=e,this.y0=i,this.pressure=r,this.synth=o,this.quantizationOffset=0,this.voice=null,this.pad=null,this.speedTracker=new qt,this.x=e,this.y=i,y.set(t,this),this.move(e,i,r)}static add(t,e,i,r,o=m){switch(o.mode){case"piano":return new At(t,e,i,r,o);case"mpe":return new L(t,e,i,r,o);case"guitar":return new U(t,e,i,r,o);case"strum":{const a=l.find(u=>u.contains(e,i));return a&&a.col===12?new Mt(t,e,i,r,o):new X(t,e,i,r,o)}default:throw new Error("unknown mode! "+o.mode)}}}class At extends D{move(t,e,i){const r=l.find(a=>a.contains(t,e))??this.pad,o=r!==this.pad;this.pad&&o&&(this.voice.noteOff(this.pad.note,127),this.voice=null),r&&o&&(this.voice=this.synth.grabVoice()),this.pad=r,this.pad&&(this.voice.glide=0,this.voice.slide=O((this.pad.centerY-e)/(f/2),-1,1),this.voice.pressure=i,o&&this.voice.noteOn(this.pad.note,127))}lift(){var t;(t=this.voice)==null||t.noteOff(this.pad.note,127)}render(){I(this.pad,this.voice)}}class L extends D{static updateQuantizationOffsets(){const t=[];for(const i of y.values())i instanceof L&&(t.push(`${i.id}: ${i.speedTracker.speed.toFixed(3)}`),i.updateQuantizationOffset());let e=innerHeight-t.length*20;n.font="16px sans-serif";for(const i of t)n.beginPath(),n.fillStyle="#00ff",n.fillText(i,20,e),n.fill(),e+=20}updateQuantizationOffset(){if(this.speedTracker.speed>.025||!this.pad)return;const t=l.find(r=>r.row===this.pad.row&&r.contains(this.x,this.y));if(!t)return;const e=.05,i=(t.centerX-this.x)/h;this.quantizationOffset=e*i+(1-e)*this.quantizationOffset,this.updateGlide()}move(t,e,i){this.x=t,this.y=e,this.speedTracker.addPos(t);const r=l.find(a=>{var u;return a.row!==((u=this.pad)==null?void 0:u.row)&&a.contains(t,e)})??this.pad,o=r!==this.pad;this.pad&&o&&(this.voice.noteOff(this.pad.note,127),this.voice=null),r&&o&&(this.voice=this.synth.grabVoice(),this.quantizationOffset=(r.centerX-t)/h),this.pad=r,this.pad&&(this.updateGlide(),this.voice.slide=O((this.pad.centerY-e)/(f/2),-1,1),this.voice.pressure=i,o&&this.voice.noteOn(this.pad.note,127))}updateGlide(){this.voice.glide=(this.x-this.pad.centerX)/h+this.quantizationOffset}lift(){var t;(t=this.voice)==null||t.noteOff(this.pad.note,127)}render(){I(this.pad,this.voice)}}class U extends D{constructor(){super(...arguments),this.pressure=0,this.quantizationOffset=0}move(t,e,i){this.x=t,this.y=e,this.pressure=i;const r=l.find(u=>{var v;return u.row!==((v=this.pad)==null?void 0:v.row)&&u.contains(t,e)}),o=r?F(r.row):this.pad,a=o!==this.pad;if(this.pad&&a){const u=this.pad.row;this.pad=null,this.updateRow(u),this.voice=null}o&&a&&(this.voice=this.synth.voices[o.row],this.quantizationOffset=(r.centerX-t)/h),this.pad=o,this.pad&&this.updateRow(this.pad.row)}updateRow(t){const e=this.synth.voices[t],i=F(t),r=this.getHighestFinger(t);r?(r.updateParams(),e.isOn||e.noteOn(i.note,127)):e.noteOff(i.note,127)}getHighestFinger(t){var i;let e=null;for(const r of y.values())!(r instanceof U)||((i=r.pad)==null?void 0:i.row)!==t||(!e||r.x>e.x)&&(e=r);return e}updateParams(){if(!this.pad||!this.voice)throw new Error("invariant violated!!!");this.voice.glide=(this.x-this.pad.centerX)/h+this.quantizationOffset,this.voice.slide=O((this.pad.centerY-this.y)/(f/2),-1,1),this.voice.pressure=this.pressure}lift(){this.pad&&this.updateRow(this.pad.row)}render(){I(this.pad,this.voice)}}function F(s){return l.find(t=>t.row===s&&t.col===0)}const Ot=.5;class X extends D{constructor(){super(...arguments),this.pressure=0}move(t,e,i){this.pad||(this.pad=l.find(r=>r.col<12&&r.contains(t,e))??null),this.x=t,this.y=e,this.pressure=i,this.updateGlide()}updateGlide(){var t;this.pad&&((t=this.getHighestFinger(this.pad.row))==null||t._updateGlide())}_updateGlide(){const{row:t}=this.pad,e=F(t),i=Math.abs(this.y-this.y0)/f*Ot,r=this.synth.voices[t],o=this.getNearestFret();r.glide=o.note+i-e.note}getHighestFinger(t){var i;let e=null;for(const r of y.values())!(r instanceof X)||((i=r.pad)==null?void 0:i.row)!==t||(!e||r.x>e.x)&&(e=r);return e}getNearestFret(){let t=this.pad,e=Math.abs(t.centerX-this.x);for(const i of l){if(i.row!==this.pad.row||i.col===12)continue;const r=Math.abs(i.centerX-this.x);r<e&&(t=i,e=r)}return t}lift(){if(this.updateGlide(),this.pad&&!this.getHighestFinger(this.pad.row)){const t=this.synth.voices[this.pad.row],e=F(this.pad.row);t.noteOff(e.note,127)}}render(){if(!this.pad)return;const t=F(this.pad.row),e=this.getNearestFret().centerX,i=this.y-this.y0+t.centerY,r="rgba(100, 100, 100, 0.5)";n.beginPath(),n.fillStyle=r,n.arc(e,i,h/3,0,Math.PI*2),n.fill();for(let o of l){if(o.col!==0||o.row===t.row)continue;const a=e-(o.note-t.note)*h;if(a>=innerWidth-c-h)continue;const u=i+o.y-t.y;n.beginPath(),n.strokeStyle=r,n.arc(a,u,h/3,0,Math.PI*2),n.stroke()}}}class Mt extends D{move(t,e,i){this.x=innerWidth-c-h/2,this.y=e;const r=this.pad;if(this.pad=l.find(d=>d.col===12&&d.contains(this.x,this.y))??null,this.pad===r||!this.pad)return;const{row:o,note:a}=F(this.pad.row),u=m.voices[o],v=[...y.values()].find(d=>{var B;return d instanceof X&&((B=d.pad)==null?void 0:B.row)===o});v&&(v.updateGlide(),u.noteOn(a,127))}lift(){}render(){const t="rgba(100, 100, 100, 0.5)";n.beginPath(),n.fillStyle=t,n.arc(this.x,this.y,h/3,0,Math.PI*2),n.fill()}}function I(s,t){if(!(!s||!t))for(let e of l){if(e.col!==0)continue;const i=e.centerX+(s.note-e.note+t.glide)*h,r=e.centerY-t.slide*(f/2),o=`rgba(100, 100, 100, ${t.pressure})`,a=e.row===s.row;n.beginPath(),a?n.fillStyle=o:n.strokeStyle=o,n.arc(i,r,h/3,0,Math.PI*2),a?n.fill():n.stroke()}}class b{constructor(t=null){this.thingAbove=t,this.pointer=null}get x(){if(this.thingAbove)return this.thingAbove.x;throw new Error("must override x if no thingAbove")}get y(){if(this.thingAbove)return this.thingAbove.y+this.thingAbove.h;throw new Error("must override y if no thingAbove")}get w(){var t;return((t=this.thingAbove)==null?void 0:t.w)??T}get h(){var t;return((t=this.thingAbove)==null?void 0:t.h)??E}contains(t,e){return this.x<=t&&t<=this.x+this.w&&this.y<=e&&e<=this.y+this.h}get backgroundColor(){return this.pointer?"#ccc":"#ddd"}get foregroundColor(){return this.pointer?"#fff":"#888"}render(t){n.beginPath(),n.lineWidth=3,n.strokeStyle="#eee",n.roundRect(this.x,this.y,this.w,this.h,q),n.stroke(),n.beginPath(),n.fillStyle=this.backgroundColor,n.roundRect(this.x,this.y,this.w,this.h,q),n.fill(),t&&this.renderLabel(t)}renderLabel(t){n.beginPath(),n.font=wt,n.fillStyle="#888",n.fillText(t,this.x+(this.w-n.measureText(t).width)/2,this.y+this.h/2),n.fill()}onPointerDown(t,e){}onPointerMove(t,e){}onPointerUp(t,e){}}class K extends b{constructor(t,e,i){super(),this.synth=t,this.paramNum=e,this.name=i,this.value0=null,this.y0=null}get y(){return c}get w(){return T/2}get h(){return E*3}get backgroundColor(){return"#ddd"}render(){super.render(),n.beginPath(),n.fillStyle="#ccc",n.roundRect(this.x,this.y+this.h,this.w,-this.h*this.value,q),n.fill(),this.renderLabel(this.name)}get value(){var t,e;return((e=(t=this.synth)==null?void 0:t.voices[0])==null?void 0:e.params[this.paramNum])??0}set value(t){this.synth.setParam(this.paramNum,t)}onPointerDown(t,e){this.value0=this.value,this.y0=e}onPointerMove(t,e){const i=e-this.pointer.y0;this.value=O(this.value0-i/this.h,0,1)}}const C=new class extends K{get x(){return c}}(x,5,"vol 1"),Dt=new class extends K{get x(){return C.x+C.w}}(p,5,"vol 2");class Z extends b{constructor(t){super(),this.synth=t}render(){super.render(this.synth.patch.name)}onPointerDown(){const t=(S.indexOf(this.synth.patch)+1)%S.length;this.synth.loadPatch(S[t])}}class _ extends b{constructor(t,e){super(e),this.synth=t}render(){super.render(this.synth.mode)}onPointerDown(){this.synth.toggleMode()}}class tt extends b{constructor(t,e){super(e),this.synth=t,this.octave0=null}render(){super.render(`octave ${this.synth.octave}`)}onPointerDown(t,e){this.octave0=this.synth.octave}onPointerMove(t,e){const i=e-this.pointer.y0;this.synth.octave=O(Math.round(this.octave0-i/25),-3,3)}}class et extends b{constructor(t){super(),this.synth=t}get y(){return c}get w(){return T*1.5}get h(){return E*3}render(){super.render();const t=this.synth.getTimeDomainData();if(!t)return;const e=this.synth.getLowestNoteFreq(),i=Q/e,r=Math.round(i*2);let o=0;for(let d=0;d<t.length-1;d++)if(t[d]<=128&&t[d+1]>128){o=d;break}n.lineWidth=1,n.strokeStyle=this.foregroundColor,n.beginPath();const a=Math.min(r,t.length-o),u=this.w/a;let v=this.x;for(let d=o;d<a;d++){if(v>this.x+this.w+10)debugger;const B=t[d]/128*this.h/2;d===o?n.moveTo(v,B):n.lineTo(v,B),v+=u}n.stroke()}}const N=new class extends Z{get x(){return c+1.5*h}get y(){return c}}(x),st=new _(x,N),Ft=new tt(x,st),Bt=new class extends et{get x(){return N.x+N.w}}(x);class it extends b{constructor(t,e,i){super(i),this.paramNum=t,this.name=e,this.value0=null,this.x0=null}get backgroundColor(){return"#ddd"}render(){super.render(),n.beginPath(),n.fillStyle="#ccc",n.roundRect(this.x,this.y,this.w*this.value,this.h,q),n.fill(),this.renderLabel(this.name)}get value(){var t;return((t=m==null?void 0:m.voices[0])==null?void 0:t.params[this.paramNum])??0}set value(t){m.setParam(this.paramNum,t)}onPointerDown(t,e){this.value0=this.value,this.x0=t}onPointerMove(t,e){const i=t-this.pointer.x0;this.value=O(this.value0+i/this.w,0,1)}}const nt=new class extends b{get x(){return c+h*5}get y(){return c}get w(){return T*2}render(){super.render(m===x?"\u2190 controlling synth 1":"controlling synth 2 \u2192")}onPointerDown(){m=m===x?p:x}},rt=new it(3,"param A",nt),Tt=new it(4,"param B",rt),Y=new class extends Z{get x(){return H.x-this.w}get y(){return c}}(p),ot=new _(p,Y),zt=new tt(p,ot),St=new class extends et{get x(){return Y.x-this.w}}(p);let R=120;const H=new class extends b{constructor(){super(...arguments),this.tempo0=null}get x(){return innerWidth-c-this.w}get y(){return c}render(){super.render(`tempo ${R}`)}onPointerDown(s,t){this.tempo0=R}onPointerMove(s,t){const e=t-this.pointer.y0;R=O(Math.round(this.tempo0-e/10),10,200),p.sendToWorklet({command:"set tempo",value:R})}};let w=[],P,G=0;const at=new class extends b{render(){super.render(P==="playing"?`step ${G+1} / ${w.length}`:w.length===0?"record steps":`${w.length} steps`)}onPointerDown(){$(),w=[],P="recording"}onPointerUp(){p.sendToWorklet({command:"load steps",steps:w}),w.length>0?ht():$()}}(H),Et=new class extends b{render(){super.render(P==="recording"?"add rest":P==="playing"?"stop":"play")}onPointerDown(){P==="recording"?w.push([]):P==="playing"?$():ht()}}(at);function ht(){w.length!==0&&(p.setParam(0,0),P="playing",G=0,p.sendToWorklet({command:"start sequencer"}))}function $(){P="stopped",p.sendToWorklet({command:"stop sequencer"});for(const s of l)s.isBeingPlayedBySequencer=!1}const W=[C,Dt,N,st,Ft,Bt,nt,rt,Tt,Y,ot,zt,St,H,at,Et];window.addEventListener("pointerdown",s=>{for(const t of W)t.contains(s.clientX,s.clientY)&&(t.onPointerDown(s.clientX,s.clientY),t.pointer={id:s.pointerId,x0:s.clientX,y0:s.clientY},s.preventDefault())}),window.addEventListener("pointermove",s=>{var t;for(const e of W)((t=e.pointer)==null?void 0:t.id)===s.pointerId&&(e.onPointerMove(s.clientX,s.clientY),s.preventDefault())}),window.addEventListener("pointerup",s=>{var t;for(const e of W)((t=e.pointer)==null?void 0:t.id)===s.pointerId&&(e.onPointerUp(s.clientX,s.clientY),e.pointer=null,s.preventDefault())});function dt(){n.clearRect(0,0,innerWidth,innerHeight);for(const t of W)t.render();for(const t of l)t.render();for(const t of y.values())t.render();n.font="16px sans-serif";const{width:s}=n.measureText(k);n.beginPath(),n.fillStyle="#00ff",n.fillText(k,innerWidth-s-20,innerHeight-20),n.fill(),L.updateQuantizationOffsets(),requestAnimationFrame(dt)}dt();const A=new AudioContext({latencyHint:"balanced",sampleRate:Q});let z="need initialization";function Nt(){return z==="ready"?!0:(z==="need initialization"&&Rt(),!1)}async function Rt(){z==="need initialization"&&(z="initializing",k="initializing audio...",A.resume(),k="loading worklet...",await A.audioWorklet.addModule(ut),x.init(),p.init(),p.sendToWorklet({command:"load steps",steps:w}),z="ready",k="ready!",await Lt(2),k="")}function Wt(s){switch(s.event){case"seq step":{s.action==="noteOn"&&(G=s.index);for(const t of w[s.index]||[])for(const e of l)e.note===t&&(e.isBeingPlayedBySequencer=s.action==="noteOn");break}case"log":{k=s.message;break}default:k="??? "+JSON.stringify(s);break}}window.addEventListener("pointerdown",()=>{(A.state==="suspended"||A.state==="interrupted")&&A.resume()}),window.addEventListener("pointerdown",async s=>{if(!Nt())return;const t=[...y.values()].some(e=>!!e.pad);for(const e of l)if(e.contains(s.clientX,s.clientY)){P==="recording"&&m===p&&(t||w.push([]),w.at(-1).push(e.note)),D.add(s.pointerId,s.clientX,s.clientY,lt(s));break}}),window.addEventListener("pointermove",s=>{const t=y.get(s.pointerId);t&&(t.move(s.clientX,s.clientY,lt(s)),s.preventDefault())}),window.addEventListener("pointerup",ct),window.addEventListener("pointercancel",ct);function ct(s){const t=y.get(s.pointerId);t&&(y.delete(s.pointerId),t.lift())}function lt(s){return s.pointerType==="pen"?s.pressure:s.pointerType==="touch"?Math.abs(Math.max(s.width,s.height)-20)/130:1}function Lt(s){return new Promise(t=>setTimeout(t,s*1e3))}
