(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))e(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const r of i.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&e(r)}).observe(document,{childList:!0,subtree:!0});function t(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerPolicy&&(i.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?i.credentials="include":s.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function e(s){if(s.ep)return;s.ep=!0;const i=t(s);fetch(s.href,i)}})();const lt=""+new URL("msynth-worklet-CnkM3A_-.js",import.meta.url).href;function pt(n,t,e){return new Uint8Array([144|n&15,t&127,e&127])}function ut(n,t,e){return new Uint8Array([128|n&15,t&127,e&127])}const $=96e3;function mt(n){return 440*Math.pow(2,(n-69)/12)}function F(n,t,e){return Math.max(t,Math.min(n,e))}class g{constructor(t,e,s){this.name=t,this.code=e,this.options=s}}const X=[new g("rebel yell",`
      ampEnv = adsr(0.03, 0, 1, 0.1)
      mod = param3 lglide(0.05) norm abs scale(0.45, 0.55)
      dry = noteFreq pwm(mod) lpf(6000, 0.2) * ampEnv
      out = dry + 0.5 * dry delay(0.4)
    `,{octave:1,mode:"mpe"}),new g("hello again",`
      sync = 0.6
      osc1 = (noteFreq / 4) pwm
      osc2 = sync * 500 * ad(0.2, 0.5) >> pwm(0.5, osc1)
      out = osc2 * adsr(0.05, 0, 1, 0.2)
    `,{octave:-1}),new g("duran duran",`
      decay = 0.102
      delayAmt = 0.547
      detuneAmt = 0.252
      portamento = paramA
      freq = (paramB abs - 0.5) ifPos(noteFreq * 2, noteFreq)
      f1 = freq eglide(portamento)
      f2 = f1 * detuneAmt escale(1.01, 1.05)
      oscs = (f1 pwm + f2 pwm) / 2
      dry = oscs * adsr(0, 0, 1, decay escale(0.1, 2))
      out = dry + delayAmt * dry delay(0.378)
    `,{mono:!0,mode:"piano"}),new g("stranger things",`
      release = paramA
      resonance = (paramB norm - 0.5) abs scale(0.15, 1)
      pwmRate = 0.218
      osc1 = noteFreq pwm(pwmRate sine norm scale(0.2, 0.8))
      osc2 = (2 * noteFreq * 1.005) pwm(pwmRate sine norm scale(0.4, 0.6))
      out = (osc1 + osc2) lpf(10000 * adsr(0.001, 0, 1, 0.5), resonance) * adsr(0, 0, 1, release)
    `,{octave:-2,paramA:.8,paramB:.5}),new g("tom sawyer",`
      resonance = paramA
      w = 0.5 + (1/5) sine norm scale(0, 0.4)
      detune1 = 0.091 * 0.01
      detune2 = 0.836 * 0.01
      delayAmt = paramB
      oscs =
        (
          (noteFreq * (1 - detune1)) pwm(w) +
          (noteFreq * (1 + detune1)) pwm(w) +
          (noteFreq * (1 - 3 * detune2)) pwm(w) +
          (noteFreq * (1 + 3 * detune2)) pwm(w)
        ) / 4
      filterEnv = adsr(0.05, 0, 1, 6) escale(0, 1)
      ampEnv = adsr(0, 0, 1, 12)
      dry = oscs lpf12(10000 * filterEnv, resonance) * ampEnv
      out = dry + delayAmt * dry delay(0.15) >> dcBlock
    `,{mode:"piano",octave:-2,paramA:.755,paramB:.127}),new g("guitar",`
      cutoff = paramA
      feedback = paramB scale(0.9, 0.999)
      burst  = noise * gate(0.005)
      filter = (burst + filter) delay(1 / noteFreq) lpf12(20000 * cutoff, 0) * feedback
      out = burst + filter * adsr(0, 0, 1, 0.1)
    `,{paramA:1,paramB:.99,octave:-1,mode:"strum"}),new g("12 string",`
      cutoff = paramA
      feedback = paramB scale(0.9, 0.999)
      burst  = noise * gate(0.005)
      string1 = (burst + string1) delay(1 / noteFreq) lpf12(20000 * cutoff, 0) * feedback
      string2 = (burst + string2) delay(1 / (noteFreq * 2)) lpf12(20000 * cutoff, 0) * feedback
      out = burst + (string1 + string2) * adsr(0, 0, 1, 0.1)
    `,{paramA:1,paramB:.99,octave:-1,mode:"strum"}),new g("strum bass",`
      out = noteFreq sine * ad(0.01, 5) * adsr(0, 0, 1, 0.1)
    `,{paramA:.2,paramB:1,octave:-2,mode:"strum"}),new g("rick and morty",`
      sound1 = noise bpf(0.2 sine * 800 + 1200, 1)
      sound2 = noise bpf(-(0.25 sine) * 800 + 1200, 1)
      ring = (sound1 + sound1 delay(2) + sound2) * 5.5 pwm norm * 0.5
      out = ring * adsr(0.01, 0, 1, 2)
    `),new g("pwm",`
      out = noteFreq pwm(slide lglide(0.05) norm scale(0.2, 0.8)) * adsr(0.05, 0, 1, 0.4)
    `),new g("pwm pencil",`
      out = noteFreq pwm(slide lglide(0.05) norm scale(0.2, 0.8)) * adsr(0.05, 0, 1, 0.4) * pressure
    `),new g("sine",`
      out = noteFreq sine * adsr(0.01, 0, 1, 0.3)
    `)],ft=document.getElementById("ui"),O=document.createElement("canvas"),o=O.getContext("2d");ft.appendChild(O);const u=2;let h=0,d=0,M=0,R=0,gt="18px sans-serif";function V(){O.style.width=innerWidth+"px",O.style.height=innerHeight+"px",O.width=innerWidth*devicePixelRatio,O.height=innerHeight*devicePixelRatio,o.scale(devicePixelRatio,devicePixelRatio),h=(innerWidth-2*u)/13,d=(innerHeight-2*u)/8,M=h*1.5,R=d/1.5}window.addEventListener("resize",V),V();const wt=8;let k="tap here";class yt{constructor(t,e){this.synth=t,this.channel=e,this.params=new Float32Array(new SharedArrayBuffer(512)),this.note=-1}noteOn(t,e){this.isOn&&this.noteOff(this.note,127),this.note=t,this.synth.sendToWorklet({command:"process midi message",data:pt(this.channel,t,e)})}noteOff(t,e){this.note=-1,this.synth.sendToWorklet({command:"process midi message",data:ut(this.channel,t,e)})}get isOn(){return this.note!==-1}get freq(){return mt(this.note)*Math.pow(2,this.params[0]/12)}set glide(t){this.params[0]=t}get glide(){return this.params[0]}set slide(t){this.params[1]=t}get slide(){return this.params[1]}set pressure(t){this.params[2]=t}get pressure(){return this.params[2]}set paramA(t){this.params[3]=t}get paramA(){return this.params[3]}set paramB(t){this.params[4]=t}get paramB(){return this.params[4]}set gain(t){this.params[5]=t}get gain(){return this.params[5]}}class j{constructor(t="pwm"){if(this.mode="mpe",this.worklet=null,this.voices=[],this.octave=0,this.analyzer=null,this.timeDomainData=null,this.lnf=220,this.patch=X.find(e=>e.name===t),!this.patch)throw new Error("unknown patch name! "+t);for(let e=0;e<wt;e++)this.voices.push(new yt(this,e))}init(){this.worklet=new AudioWorkletNode(q,"msynth"),this.sendToWorklet({command:"init",voiceParams:this.voices.map(e=>e.params.buffer)}),this.analyzer=q.createAnalyser(),this.analyzer.fftSize=2048;const t=this.analyzer.frequencyBinCount;this.timeDomainData=new Uint8Array(t),this.worklet.channelInterpretation="discrete",this.worklet.channelCount=2,this.worklet.channelCountMode="explicit",this.worklet.connect(this.analyzer).connect(q.destination),this.worklet.port.onmessage=e=>Nt(e.data),this.loadPatch(this.patch)}getTimeDomainData(){return!this.analyzer||!this.timeDomainData?null:(this.analyzer.getByteTimeDomainData(this.timeDomainData),this.timeDomainData)}toggleMode(){this.mode=this.mode==="mpe"?"piano":this.mode==="piano"?"guitar":this.mode==="guitar"?"strum":"mpe"}sendToWorklet(t){var e;(e=this.worklet)==null||e.port.postMessage(t)}loadPatch(t){var e,s,i,r,a;this.patch=t,this.sendToWorklet({command:"load patch",code:t.code,mono:((e=t.options)==null?void 0:e.mono)??!1}),this.setParam(3,((s=t.options)==null?void 0:s.paramA)??0),this.setParam(4,((i=t.options)==null?void 0:i.paramB)??0),this.setParam(5,.2),this.octave=((r=t.options)==null?void 0:r.octave)??0,this.mode=((a=t.options)==null?void 0:a.mode)??"mpe"}grabVoice(){var s;if((s=this.patch.options)!=null&&s.mono)return this.voices[0];const t=[...x.values()],e=this.voices.findLast(i=>!t.some(r=>r.voice===i))??this.voices.at(-1);return this.voices.splice(this.voices.indexOf(e),1),this.voices.unshift(e),e}setParam(t,e){for(const s of this.voices)s.params[t]=e}getLowestNoteFreq(){let t=1/0;for(const e of this.voices)e.isOn&&e.freq<t&&(t=e.freq);return Number.isFinite(t)&&(this.lnf=t),this.lnf}}const v=new j("guitar"),p=new j("stranger things");let f=v;const vt=47,xt=5,A=4;class bt{constructor(t,e,s){this.col=t,this.row=e,this.noteName=s,this.isBeingPlayedBySequencer=!1}get note(){return vt+12*f.octave+xt*(7-this.row)+this.col}get posX(){return u+this.col*h}get posY(){return u+this.row*d}contains(t,e){return this.posX<=t&&t<=this.posX+h&&this.posY<=e&&e<=this.posY+d}render(){if(o.beginPath(),o.lineWidth=3,o.strokeStyle="#eee",o.roundRect(this.posX,this.posY,h,d,A),o.stroke(),f.mode==="strum"&&this.col===12){o.beginPath(),o.fillStyle="#aaa",o.roundRect(this.posX,this.posY,h,d,A),o.fill();return}o.beginPath(),o.fillStyle=this.noteName===""?"#ccc":"#ddd",o.roundRect(this.posX,this.posY,h,d,A),o.fill(),f===p&&this.isBeingPlayedBySequencer&&(o.beginPath(),o.fillStyle=this.noteName===""?"#eee":"#bbb",o.roundRect(this.posX+20,this.posY+20,h-40,d-40,A),o.fill()),this.noteName!==""&&(o.beginPath(),o.font="14px sans-serif",o.fillStyle="#bbb",o.fillText(this.noteName,this.posX+4,this.posY+16),o.fill())}}const m=[],Pt=["C","","D","","E","F","","G","","A","","B"];let J=0;for(let n=2;n<=7;n++){for(let t=0;t<=12;t++)m.push(new bt(t,n,Pt[(J+t)%12]));J+=7}const x=new Map;class B{constructor(t,e,s,i,r){this.id=t,this.x0=e,this.y0=s,this.pressure=i,this.synth=r,this.voice=null,this.pad=null,this.x=e,this.y=s,x.set(t,this),this.move(e,s,i)}static add(t,e,s,i,r=f){switch(r.mode){case"piano":return new kt(t,e,s,i,r);case"mpe":return new At(t,e,s,i,r);case"guitar":return new U(t,e,s,i,r);case"strum":{const a=m.find(l=>l.contains(e,s));return a&&a.col===12?new Ft(t,e,s,i,r):new z(t,e,s,i,r)}default:throw new Error("unknown mode! "+r.mode)}}}class kt extends B{move(t,e,s){const i=m.find(a=>a.contains(t,e))??this.pad,r=i!==this.pad;this.pad&&r&&(this.voice.noteOff(this.pad.note,127),this.voice=null),i&&r&&(this.voice=this.synth.grabVoice()),this.pad=i,this.pad&&(this.voice.glide=0,this.voice.slide=F((this.pad.posY+d/2-e)/(d/2),-1,1),this.voice.pressure=s,r&&this.voice.noteOn(this.pad.note,127))}lift(){var t;(t=this.voice)==null||t.noteOff(this.pad.note,127)}render(){S(this.pad,this.voice)}}class At extends B{constructor(){super(...arguments),this.quantizationOffset=0}move(t,e,s){const i=m.find(a=>{var l;return a.row!==((l=this.pad)==null?void 0:l.row)&&a.contains(t,e)})??this.pad,r=i!==this.pad;if(this.pad&&r&&(this.voice.noteOff(this.pad.note,127),this.voice=null),i&&r&&(this.voice=this.synth.grabVoice(),this.quantizationOffset=(i.posX+h/2-t)/h),this.pad=i,this.pad){const a=this.pad.posX+h/2,l=this.pad.posY+d/2;this.voice.glide=(t-a)/h+this.quantizationOffset,this.voice.slide=F((l-e)/(d/2),-1,1),this.voice.pressure=s,r&&this.voice.noteOn(this.pad.note,127)}}lift(){var t;(t=this.voice)==null||t.noteOff(this.pad.note,127)}render(){S(this.pad,this.voice)}}class U extends B{constructor(){super(...arguments),this.pressure=0,this.quantizationOffset=0}move(t,e,s){this.x=t,this.y=e,this.pressure=s;const i=m.find(l=>{var y;return l.row!==((y=this.pad)==null?void 0:y.row)&&l.contains(t,e)}),r=i?E(i.row):this.pad,a=r!==this.pad;if(this.pad&&a){const l=this.pad.row;this.pad=null,this.updateRow(l),this.voice=null}r&&a&&(this.voice=this.synth.voices[r.row],this.quantizationOffset=(i.posX+h/2-t)/h),this.pad=r,this.pad&&this.updateRow(this.pad.row)}updateRow(t){const e=this.synth.voices[t],s=E(t),i=this.getHighestFinger(t);i?(i.updateParams(),e.isOn||e.noteOn(s.note,127)):e.noteOff(s.note,127)}getHighestFinger(t){var s;let e=null;for(const i of x.values())!(i instanceof U)||((s=i.pad)==null?void 0:s.row)!==t||(!e||i.x>e.x)&&(e=i);return e}updateParams(){if(!this.pad||!this.voice)throw new Error("invariant violated!!!");const t=this.pad.posX+h/2,e=this.pad.posY+d/2;this.voice.glide=(this.x-t)/h+this.quantizationOffset,this.voice.slide=F((e-this.y)/(d/2),-1,1),this.voice.pressure=this.pressure}lift(){this.pad&&this.updateRow(this.pad.row)}render(){S(this.pad,this.voice)}}function E(n){return m.find(t=>t.row===n&&t.col===0)}const qt=.5;class z extends B{constructor(){super(...arguments),this.pressure=0}move(t,e,s){this.pad||(this.pad=m.find(i=>i.col<12&&i.contains(t,e))??null),this.x=t,this.y=e,this.pressure=s,this.updateGlide()}updateGlide(){var t;this.pad&&((t=this.getHighestFinger(this.pad.row))==null||t._updateGlide())}_updateGlide(){const{row:t}=this.pad,e=E(t),s=Math.abs(this.y-this.y0)/d*qt,i=this.synth.voices[t],r=this.getNearestFret();i.glide=r.note+s-e.note}getHighestFinger(t){var s;let e=null;for(const i of x.values())!(i instanceof z)||((s=i.pad)==null?void 0:s.row)!==t||(!e||i.x>e.x)&&(e=i);return e}getNearestFret(){let t=this.pad,e=Math.abs(t.posX+h/2-this.x);for(const s of m){if(s.row!==this.pad.row||s.col===12)continue;const i=Math.abs(s.posX+h/2-this.x);i<e&&(t=s,e=i)}return t}lift(){if(this.updateGlide(),this.pad&&!this.getHighestFinger(this.pad.row)){const t=this.synth.voices[this.pad.row],e=E(this.pad.row);t.noteOff(e.note,127)}}render(){var t;S(this.pad,this.synth.voices[((t=this.pad)==null?void 0:t.row)??-1])}}class Ft extends B{move(t,e,s){const i=this.pad;if(this.pad=m.find(c=>c.col===12&&c.contains(t,e))??null,this.pad===i||!this.pad)return;const{row:r,note:a}=E(this.pad.row),l=f.voices[r],y=[...x.values()].find(c=>{var D;return c instanceof z&&((D=c.pad)==null?void 0:D.row)===r});y&&(y.updateGlide(),l.noteOn(a,127))}lift(){}render(){}}function S(n,t){if(!(!n||!t))for(let e of m){if(e.col!==0)continue;const s=e.posX+h/2+(n.note-e.note+t.glide)*h,i=e.posY+d/2-t.slide*(d/2),r=`rgba(100, 100, 100, ${t.pressure})`,a=e.row===n.row;o.beginPath(),a?o.fillStyle=r:o.strokeStyle=r,o.arc(s,i,h/3,0,Math.PI*2),a?o.fill():o.stroke()}}class b{constructor(t=null){this.thingAbove=t,this.pointer=null}get x(){if(this.thingAbove)return this.thingAbove.x;throw new Error("must override x if no thingAbove")}get y(){if(this.thingAbove)return this.thingAbove.y+this.thingAbove.h;throw new Error("must override y if no thingAbove")}get w(){var t;return((t=this.thingAbove)==null?void 0:t.w)??M}get h(){var t;return((t=this.thingAbove)==null?void 0:t.h)??R}contains(t,e){return this.x<=t&&t<=this.x+this.w&&this.y<=e&&e<=this.y+this.h}get backgroundColor(){return this.pointer?"#ccc":"#ddd"}get foregroundColor(){return this.pointer?"#fff":"#888"}render(t){o.beginPath(),o.lineWidth=3,o.strokeStyle="#eee",o.roundRect(this.x,this.y,this.w,this.h,A),o.stroke(),o.beginPath(),o.fillStyle=this.backgroundColor,o.roundRect(this.x,this.y,this.w,this.h,A),o.fill(),t&&this.renderLabel(t)}renderLabel(t){o.beginPath(),o.font=gt,o.fillStyle="#888",o.fillText(t,this.x+(this.w-o.measureText(t).width)/2,this.y+this.h/2),o.fill()}onPointerDown(t,e){}onPointerMove(t,e){}onPointerUp(t,e){}}class K extends b{constructor(t,e,s){super(),this.synth=t,this.paramNum=e,this.name=s,this.value0=null,this.y0=null}get y(){return u}get w(){return M/2}get h(){return R*3}get backgroundColor(){return"#ddd"}render(){super.render(),o.beginPath(),o.fillStyle="#ccc",o.roundRect(this.x,this.y+this.h,this.w,-this.h*this.value,A),o.fill(),this.renderLabel(this.name)}get value(){var t,e;return((e=(t=this.synth)==null?void 0:t.voices[0])==null?void 0:e.params[this.paramNum])??0}set value(t){this.synth.setParam(this.paramNum,t)}onPointerDown(t,e){this.value0=this.value,this.y0=e}onPointerMove(t,e){const s=e-this.pointer.y0;this.value=F(this.value0-s/this.h,0,1)}}const Y=new class extends K{get x(){return u}}(v,5,"vol 1"),Ot=new class extends K{get x(){return Y.x+Y.w}}(p,5,"vol 2");class _ extends b{constructor(t){super(),this.synth=t}render(){super.render(this.synth.patch.name)}onPointerDown(){const t=(X.indexOf(this.synth.patch)+1)%X.length;this.synth.loadPatch(X[t])}}class Q extends b{constructor(t,e){super(e),this.synth=t}render(){super.render(this.synth.mode)}onPointerDown(){this.synth.toggleMode()}}class Z extends b{constructor(t,e){super(e),this.synth=t,this.octave0=null}render(){super.render(`octave ${this.synth.octave}`)}onPointerDown(t,e){this.octave0=this.synth.octave}onPointerMove(t,e){const s=e-this.pointer.y0;this.synth.octave=F(Math.round(this.octave0-s/25),-3,3)}}class tt extends b{constructor(t){super(),this.synth=t}get y(){return u}get w(){return M*1.5}get h(){return R*3}render(){super.render();const t=this.synth.getTimeDomainData();if(!t)return;const e=this.synth.getLowestNoteFreq(),s=$/e,i=Math.round(s*2);let r=0;for(let c=0;c<t.length-1;c++)if(t[c]<=128&&t[c+1]>128){r=c;break}o.lineWidth=1,o.strokeStyle=this.foregroundColor,o.beginPath();const a=Math.min(i,t.length-r),l=this.w/a;let y=this.x;for(let c=r;c<a;c++){if(y>this.x+this.w+10)debugger;const D=t[c]/128*this.h/2;c===r?o.moveTo(y,D):o.lineTo(y,D),y+=l}o.stroke()}}const N=new class extends _{get x(){return u+1.5*h}get y(){return u}}(v),et=new Q(v,N),Bt=new Z(v,et),Dt=new class extends tt{get x(){return N.x+N.w}}(v);class nt extends b{constructor(t,e,s){super(s),this.paramNum=t,this.name=e,this.value0=null,this.x0=null}get backgroundColor(){return"#ddd"}render(){super.render(),o.beginPath(),o.fillStyle="#ccc",o.roundRect(this.x,this.y,this.w*this.value,this.h,A),o.fill(),this.renderLabel(this.name)}get value(){var t;return((t=f==null?void 0:f.voices[0])==null?void 0:t.params[this.paramNum])??0}set value(t){f.setParam(this.paramNum,t)}onPointerDown(t,e){this.value0=this.value,this.x0=t}onPointerMove(t,e){const s=t-this.pointer.x0;this.value=F(this.value0+s/this.w,0,1)}}const st=new class extends b{get x(){return u+h*5}get y(){return u}get w(){return M*2}render(){super.render(f===v?"\u2190 controlling synth 1":"controlling synth 2 \u2192")}onPointerDown(){f=f===v?p:v}},it=new nt(3,"param A",st),Mt=new nt(4,"param B",it),C=new class extends _{get x(){return H.x-this.w}get y(){return u}}(p),ot=new Q(p,C),Et=new Z(p,ot),Tt=new class extends tt{get x(){return C.x-this.w}}(p);let W=120;const H=new class extends b{constructor(){super(...arguments),this.tempo0=null}get x(){return innerWidth-u-this.w}get y(){return u}render(){super.render(`tempo ${W}`)}onPointerDown(n,t){this.tempo0=W}onPointerMove(n,t){const e=t-this.pointer.y0;W=F(Math.round(this.tempo0-e/10),10,200),p.sendToWorklet({command:"set tempo",value:W})}};let w=[],P,I=0;const rt=new class extends b{render(){super.render(P==="playing"?`step ${I+1} / ${w.length}`:w.length===0?"record steps":`${w.length} steps`)}onPointerDown(){G(),w=[],P="recording"}onPointerUp(){p.sendToWorklet({command:"load steps",steps:w}),w.length>0?at():G()}}(H),Xt=new class extends b{render(){super.render(P==="recording"?"add rest":P==="playing"?"stop":"play")}onPointerDown(){P==="recording"?w.push([]):P==="playing"?G():at()}}(rt);function at(){w.length!==0&&(p.setParam(0,0),P="playing",I=0,p.sendToWorklet({command:"start sequencer"}))}function G(){P="stopped",p.sendToWorklet({command:"stop sequencer"});for(const n of m)n.isBeingPlayedBySequencer=!1}const L=[Y,Ot,N,et,Bt,Dt,st,it,Mt,C,ot,Et,Tt,H,rt,Xt];window.addEventListener("pointerdown",n=>{for(const t of L)t.contains(n.clientX,n.clientY)&&(t.onPointerDown(n.clientX,n.clientY),t.pointer={id:n.pointerId,x0:n.clientX,y0:n.clientY})}),window.addEventListener("pointermove",n=>{var t;for(const e of L)((t=e.pointer)==null?void 0:t.id)===n.pointerId&&e.onPointerMove(n.clientX,n.clientY)}),window.addEventListener("pointerup",n=>{var t;for(const e of L)((t=e.pointer)==null?void 0:t.id)===n.pointerId&&(e.onPointerUp(n.clientX,n.clientY),e.pointer=null)});function ht(){o.clearRect(0,0,innerWidth,innerHeight);for(const t of L)t.render();for(const t of m)t.render();for(const t of x.values())t.render();o.font="16px sans-serif";const{width:n}=o.measureText(k);o.beginPath(),o.fillStyle="#00ff",o.fillText(k,innerWidth-n-20,innerHeight-20),o.fill(),requestAnimationFrame(ht)}ht();const q=new AudioContext({latencyHint:"balanced",sampleRate:$});let T="need initialization";function Rt(){return T==="ready"?!0:(T==="need initialization"&&St(),!1)}async function St(){T==="need initialization"&&(T="initializing",k="initializing audio...",q.resume(),k="loading worklet...",await q.audioWorklet.addModule(lt),v.init(),p.init(),p.sendToWorklet({command:"load steps",steps:w}),T="ready",k="ready!",await Wt(2),k="")}function Nt(n){switch(n.event){case"seq step":{n.action==="noteOn"&&(I=n.index);for(const t of w[n.index]||[])for(const e of m)e.note===t&&(e.isBeingPlayedBySequencer=n.action==="noteOn");break}case"log":{k=n.message;break}default:k="??? "+JSON.stringify(n);break}}window.addEventListener("pointerdown",()=>{(q.state==="suspended"||q.state==="interrupted")&&q.resume()}),window.addEventListener("pointerdown",async n=>{if(!Rt())return;const t=[...x.values()].some(e=>!!e.pad);for(const e of m)if(e.contains(n.clientX,n.clientY)){P==="recording"&&f===p&&(t||w.push([]),w.at(-1).push(e.note)),B.add(n.pointerId,n.clientX,n.clientY,ct(n));break}}),window.addEventListener("pointermove",n=>{const t=x.get(n.pointerId);t&&t.move(n.clientX,n.clientY,ct(n))}),window.addEventListener("pointerup",dt),window.addEventListener("pointercancel",dt);function dt(n){const t=x.get(n.pointerId);t&&(x.delete(n.pointerId),t.lift())}function ct(n){return n.pointerType==="pen"?n.pressure:n.pointerType==="touch"?Math.abs(Math.max(n.width,n.height)-20)/130:1}function Wt(n){return new Promise(t=>setTimeout(t,n*1e3))}
