(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))e(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const o of r.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&e(o)}).observe(document,{childList:!0,subtree:!0});function t(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerPolicy&&(r.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?r.credentials="include":n.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function e(n){if(n.ep)return;n.ep=!0;const r=t(n);fetch(n.href,r)}})();const bt=""+new URL("msynth-worklet-DzX-FDV6.js",import.meta.url).href;function xt(s,t,e){return new Uint8Array([144|s&15,t&127,e&127])}function Pt(s,t,e){return new Uint8Array([128|s&15,t&127,e&127])}const st=96e3;function kt(s){return 440*Math.pow(2,(s-69)/12)}function D(s,t,e){return Math.max(t,Math.min(s,e))}class w{constructor(t,e,n){this.name=t,this.code=e,this.options=n}}const rt=[new w("rebel yell",`
      ampEnv = adsr(0.03, 0, 1, 0.1)
      mod = param3 lglide(0.05) norm abs scale(0.45, 0.55)
      dry = noteFreq pwm(mod) lpf(6000, 0.2) * ampEnv
      out = dry + 0.5 * dry delay(0.4)
    `,{octave:1,mode:"mpe"}),new w("hello again",`
      sync = 0.6
      osc1 = (noteFreq / 4) pwm
      osc2 = sync * 500 * ad(0.2, 0.5) >> pwm(0.5, osc1)
      out = osc2 * adsr(0.05, 0, 1, 0.2) >> dcBlock
    `,{octave:-1}),new w("duran duran",`
      decay = 0.102
      delayAmt = 0.547
      detuneAmt = 0.252
      portamento = paramA
      freq = (paramB abs - 0.5) ifPos(noteFreq * 2, noteFreq)
      f1 = freq eglide(portamento)
      f2 = f1 * detuneAmt escale(1.01, 1.05)
      oscs = (f1 pwm + f2 pwm) / 2
      dry = oscs * adsr(0, 0, 1, decay escale(0.1, 2))
      out = dry + delayAmt * dry delay(0.378)
    `,{mono:!0,mode:"piano"}),new w("stranger things",`
      release = paramA
      resonance = (paramB norm - 0.5) abs scale(0.15, 1)
      pwmRate = 0.218
      osc1 = noteFreq pwm(pwmRate sine norm scale(0.2, 0.8))
      osc2 = (2 * noteFreq * 1.005) pwm(pwmRate sine norm scale(0.4, 0.6))
      out = (osc1 + osc2) lpf(10000 * adsr(0.001, 0, 1, 0.5), resonance) * adsr(0, 0, 1, release) >> dcBlock
    `,{octave:-2,paramA:.8,paramB:.5}),new w("tom sawyer",`
      resonance = paramA
      w = 0.5 + (1/5) sine norm scale(0, 0.4)
      detune1 = 0.091 * 0.01
      detune2 = 0.836 * 0.01
      delayAmt = paramB
      oscs =
        (
          (noteFreq * (1 - detune1)) pwm(w) +
          (noteFreq * (1 + detune1)) pwm(w) +
          (noteFreq * (1 - 3 * detune2)) pwm(w) +
          (noteFreq * (1 + 3 * detune2)) pwm(w)
        ) / 4
      filterEnv = adsr(0.05, 0, 1, 6) escale(0, 1)
      ampEnv = adsr(0, 0, 1, 12)
      dry = oscs lpf12(10000 * filterEnv, resonance) * ampEnv
      out = dry + delayAmt * dry delay(0.15) >> dcBlock
    `,{mode:"piano",octave:-2,paramA:.755,paramB:.127}),new w("guitar",`
      cutoff = paramA
      feedback = paramB scale(0.9, 0.999)
      burst  = noise * gate(0.005) * noteVel
      filter = (burst + filter) delay(1 / noteFreq) lpf12(20000 * cutoff, 0) * feedback
      out = burst + filter * adsr(0, 0, 1, 0.1)
    `,{paramA:1,paramB:.99,octave:-1,mode:"strum"}),new w("12 string",`
      cutoff = paramA
      feedback = paramB scale(0.9, 0.999)
      burst  = noise * gate(0.005) * noteVel
      string1 = (burst + string1) delay(1 / noteFreq) lpf12(20000 * cutoff, 0) * feedback
      string2 = (burst + string2) delay(1 / (noteFreq * 2)) lpf12(20000 * cutoff, 0) * feedback
      out = burst + (string1 + string2) * adsr(0, 0, 1, 0.1)
    `,{paramA:1,paramB:.99,octave:-1,mode:"strum"}),new w("strum bass",`
      out = noteFreq sine * ad(0.01, 5) * adsr(0, 0, 1, 0.1)
    `,{paramA:.2,paramB:1,octave:-2,mode:"strum"}),new w("rick and morty",`
      sound1 = noise bpf(0.2 sine * 800 + 1200, 1)
      sound2 = noise bpf(-(0.25 sine) * 800 + 1200, 1)
      ring = (sound1 + sound1 delay(2) + sound2) * 5.5 pwm norm * 0.5
      out = ring * adsr(0.01, 0, 1, 2)
    `),new w("pwm",`
      out = noteFreq pwm(slide lglide(0.05) norm scale(0.2, 0.8)) * adsr(0.05, 0, 1, 0.4)
    `),new w("pwm pencil",`
      out = noteFreq pwm(slide lglide(0.05) norm scale(0.2, 0.8)) * adsr(0.05, 0, 1, 0.4) * pressure
    `),new w("sine",`
      out = noteFreq sine * adsr(0.01, 0, 1, 0.3)
    `)],At=document.getElementById("ui"),q=document.createElement("canvas"),i=q.getContext("2d");At.appendChild(q);const f=2,Ot="#ccc",U="#ddd",M="#888",St="#888",Tt="#bbe",Q="#ccd",O="#dde",S="#88c",Xt="#88c";let l=0,m=0;const qt="14px Inter",Mt="#bbb",Yt="#eee";let j=0,V=0;const Ct="500 18px Inter",J="500 16px Inter",P=30,ot=10,z=150,W=5;function at(){q.style.width=innerWidth+"px",q.style.height=innerHeight+"px",q.width=innerWidth*devicePixelRatio,q.height=innerHeight*devicePixelRatio,i.scale(devicePixelRatio,devicePixelRatio),l=(innerWidth-2*f)/13,m=(innerHeight-2*f)/8,j=l*1.5,V=m/1.5}window.addEventListener("resize",at),at();const Dt=8;let T="tap here";class Wt{constructor(t,e){this.synth=t,this.channel=e,this.params=new Float32Array(new SharedArrayBuffer(512)),this.note=-1}noteOn(t,e){this.isOn&&this.noteOff(this.note,127),this.note=t,this.synth.sendToWorklet({command:"process midi message",data:xt(this.channel,t,e)})}noteOff(t,e){this.note=-1,this.synth.sendToWorklet({command:"process midi message",data:Pt(this.channel,t,e)})}get isOn(){return this.note!==-1}get freq(){return kt(this.note)*Math.pow(2,this.params[0]/12)}set glide(t){this.params[0]=t}get glide(){return this.params[0]}set slide(t){this.params[1]=t}get slide(){return this.params[1]}set pressure(t){this.params[2]=t}get pressure(){return this.params[2]}set paramA(t){this.params[3]=t}get paramA(){return this.params[3]}set paramB(t){this.params[4]=t}get paramB(){return this.params[4]}set paramC(t){this.params[5]=t}get paramC(){return this.params[5]}set gain(t){this.params[6]=t}get gain(){return this.params[6]}}class ht{constructor(t="pwm"){if(this.mode="mpe",this.worklet=null,this.voices=[],this.octave=0,this.analyzer=null,this.timeDomainData=null,this.lnf=220,this.patch=rt.find(e=>e.name===t),!this.patch)throw new Error("unknown patch name! "+t);for(let e=0;e<Dt;e++)this.voices.push(new Wt(this,e))}init(){this.worklet=new AudioWorkletNode(X,"msynth"),this.sendToWorklet({command:"init",voiceParams:this.voices.map(e=>e.params.buffer)}),this.analyzer=X.createAnalyser(),this.analyzer.fftSize=32768;const t=this.analyzer.frequencyBinCount;this.timeDomainData=new Uint8Array(t),this.worklet.channelInterpretation="discrete",this.worklet.channelCount=2,this.worklet.channelCountMode="explicit",this.worklet.connect(this.analyzer).connect(X.destination),this.worklet.port.onmessage=e=>ee(e.data),this.loadPatch(this.patch)}getTimeDomainData(){return!this.analyzer||!this.timeDomainData?null:(this.analyzer.getByteTimeDomainData(this.timeDomainData),this.timeDomainData)}toggleMode(){this.mode=this.mode==="mpe"?"piano":this.mode==="piano"?"guitar":this.mode==="guitar"?"strum":"mpe"}sendToWorklet(t){var e;(e=this.worklet)==null||e.port.postMessage(t)}loadPatch(t){var e,n,r,o,a,c;this.patch=t,this.sendToWorklet({command:"load patch",code:t.code,mono:((e=t.options)==null?void 0:e.mono)??!1}),this.setParam(3,((n=t.options)==null?void 0:n.paramA)??0),this.setParam(4,((r=t.options)==null?void 0:r.paramB)??0),this.setParam(5,((o=t.options)==null?void 0:o.paramC)??0),this.setParam(6,.2),this.octave=((a=t.options)==null?void 0:a.octave)??0,this.mode=((c=t.options)==null?void 0:c.mode)??"mpe"}grabVoice(){var n;if((n=this.patch.options)!=null&&n.mono)return this.voices[0];const t=[...b.values()],e=this.voices.findLast(r=>!t.some(o=>o.voice===r))??this.voices.at(-1);return this.voices.splice(this.voices.indexOf(e),1),this.voices.unshift(e),e}setParam(t,e){for(const n of this.voices)n.params[t]=e}getLowestNoteFreq(){let t=1/0;for(const e of this.voices)e.isOn&&e.freq<t&&(t=e.freq);return Number.isFinite(t)&&(this.lnf=t),this.lnf}patchSelector(t){return new Z(t,"top","left",rt,()=>this.patch,e=>{this.loadPatch(e)},e=>e.name,()=>h===this)}modeSelector(t){return new Z(t,"top","right",["mpe","guitar","piano","strum"],()=>this.mode,e=>{this.mode=e},e=>e,()=>h===this)}octaveSelector(t){return new Z(t,"bottom","right",[2,1,0,-1,-2],()=>this.octave,e=>{this.octave=e},e=>"octave "+(e>0?"+":"")+e,()=>h===this,!0)}}const Y=new ht("rebel yell"),d=new ht("stranger things");let h=Y;const Ft=47,Lt=5,v=5;class Bt{constructor(t,e,n){this.col=t,this.row=e,this.noteName=n,this.isBeingPlayedBySequencer=!1}get note(){return Ft+12*h.octave+Lt*(7-this.row)+this.col}get x(){return f+this.col*l}get y(){return f+this.row*m}get rightX(){return this.x+l}get bottomY(){return this.y+m}get centerX(){return this.x+l/2}get centerY(){return this.y+m/2}contains(t,e){return this.x<=t&&t<=this.rightX&&this.y<=e&&e<=this.bottomY}render(){if(i.beginPath(),i.lineWidth=3,i.strokeStyle="#efefef",i.roundRect(this.x,this.y,l,m,v),i.stroke(),h.mode==="strum"&&this.col===12){i.beginPath(),i.fillStyle=Tt,i.roundRect(this.x,this.y,l,m,v),i.fill();return}i.beginPath(),i.fillStyle=this.noteName===""?Q:O,i.roundRect(this.x,this.y,l,m,v),i.fill(),h===d&&this.isBeingPlayedBySequencer&&(i.beginPath(),i.fillStyle=this.noteName===""?Yt:Mt,i.roundRect(this.x+20,this.y+20,l-40,m-40,v),i.fill()),this.noteName!==""&&(i.globalAlpha=.5,i.beginPath(),i.font=qt,i.fillStyle=S,i.fillText(this.noteName,this.x+4,this.y+16),i.fill(),i.globalAlpha=1)}}const u=[],Ut=["C","","D","","E","F","","G","","A","","B"];let lt=0;for(let s=2;s<=7;s++){for(let t=0;t<=12;t++)u.push(new Bt(t,s,Ut[(lt+t)%12]));lt+=7}const b=new Map;class zt{constructor(){this.windowMs=150,this.history=[]}addPos(t){this.history.push({pos:t,t:performance.now()})}get speed(){const t=performance.now();if(this.history=this.history.filter(({t:r})=>t-r<=this.windowMs),this.history.length<2)return 0;let e=0;for(let r=1;r<this.history.length;r++)e+=Math.abs(this.history[r].pos-this.history[r-1].pos);const n=this.history[this.history.length-1].t-this.history[0].t;return e/n}}class C{constructor(t,e,n,r,o){this.id=t,this.x0=e,this.y0=n,this.pressure=r,this.synth=o,this.quantizationOffset=0,this.voice=null,this.pad=null,this.speedTracker=new zt,this.lastT=0,this.x=e,this.y=n,b.set(t,this),this.move(e,n,r)}static add(t,e,n,r,o=h){switch(o.mode){case"piano":return new Et(t,e,n,r,o);case"mpe":return new ct(t,e,n,r,o);case"guitar":return new H(t,e,n,r,o);case"strum":{const a=u.find(c=>c.contains(e,n));return a&&a.col===12?new Nt(t,e,n,r,o):new $(t,e,n,r,o)}default:throw new Error("unknown mode! "+o.mode)}}static updateQuantizationOffsets(){for(const t of b.values())(t instanceof ct||t instanceof H)&&t.updateQuantizationOffset()}updateQuantizationOffset(){const t=u.find(o=>{var a;return o.row===((a=this.pad)==null?void 0:a.row)&&o.contains(this.x,this.y)});if(this.speedTracker.speed>.025||!this.pad||!t){this.lastT=performance.now();return}const e=performance.now(),n=.002*(e-this.lastT),r=(t.centerX-this.x)/l;this.quantizationOffset=n*r+(1-n)*this.quantizationOffset,this.updateGlide(),this.lastT=e}updateGlide(){this.voice.glide=(this.x-this.pad.centerX)/l+this.quantizationOffset}}class Et extends C{move(t,e,n){const r=u.find(a=>a.contains(t,e))??this.pad,o=r!==this.pad;this.pad&&o&&(this.voice.noteOff(this.pad.note,127),this.voice=null),r&&o&&(this.voice=this.synth.grabVoice()),this.pad=r,this.pad&&(this.voice.glide=0,this.voice.slide=D((this.pad.centerY-e)/(m/2),-1,1),this.voice.pressure=n,o&&this.voice.noteOn(this.pad.note,127))}lift(){var t;(t=this.voice)==null||t.noteOff(this.pad.note,127)}render(){K(this.pad,this.voice)}}class ct extends C{move(t,e,n){this.x=t,this.y=e,this.speedTracker.addPos(t);const r=u.find(a=>{var c;return a.row!==((c=this.pad)==null?void 0:c.row)&&a.contains(t,e)})??this.pad,o=r!==this.pad;this.pad&&o&&(this.voice.noteOff(this.pad.note,127),this.voice=null),r&&o&&(this.voice=this.synth.grabVoice(),this.quantizationOffset=(r.centerX-t)/l),this.pad=r,this.pad&&(this.updateGlide(),this.voice.slide=D((this.pad.centerY-e)/(m/2),-1,1),this.voice.pressure=n,o&&this.voice.noteOn(this.pad.note,127))}lift(){var t;(t=this.voice)==null||t.noteOff(this.pad.note,127)}render(){K(this.pad,this.voice)}}class H extends C{constructor(){super(...arguments),this.pressure=0}move(t,e,n){this.x=t,this.y=e,this.pressure=n,this.speedTracker.addPos(t);const r=u.find(c=>{var x;return c.row!==((x=this.pad)==null?void 0:x.row)&&c.contains(t,e)}),o=r?F(r.row):this.pad,a=o!==this.pad;if(this.pad&&a){const c=this.pad.row;this.pad=null,this.updateRow(c),this.voice=null}o&&a&&(this.voice=this.synth.voices[o.row],this.quantizationOffset=(r.centerX-t)/l),this.pad=o,this.pad&&this.updateRow(this.pad.row)}updateRow(t){const e=this.synth.voices[t],n=F(t),r=this.getHighestFinger(t);r?(r.updateParams(),e.isOn||e.noteOn(n.note,127)):e.noteOff(n.note,127)}getHighestFinger(t){var n;let e=null;for(const r of b.values())!(r instanceof H)||((n=r.pad)==null?void 0:n.row)!==t||(!e||r.x>e.x)&&(e=r);return e}updateParams(){if(!this.pad||!this.voice)throw new Error("invariant violated!!!");this.updateGlide(),this.voice.slide=D((this.pad.centerY-this.y)/(m/2),-1,1),this.voice.pressure=this.pressure}lift(){this.pad&&this.updateRow(this.pad.row)}render(){K(this.pad,this.voice)}}function F(s){return u.find(t=>t.row===s&&t.col===0)}const Rt=.5;class $ extends C{constructor(){super(...arguments),this.pressure=0}move(t,e,n){this.pad||(this.pad=u.find(r=>r.col<12&&r.contains(t,e))??null),this.x=t,this.y=e,this.pressure=n,this.updateGlide()}updateGlide(){var t;this.pad&&((t=this.getHighestFinger(this.pad.row))==null||t._updateGlide())}_updateGlide(){const{row:t}=this.pad,e=F(t),n=Math.abs(this.y-this.y0)/m*Rt,r=this.synth.voices[t],o=this.getNearestFret();r.glide=o.note+n-e.note}getHighestFinger(t){var n;let e=null;for(const r of b.values())!(r instanceof $)||((n=r.pad)==null?void 0:n.row)!==t||(!e||r.x>e.x)&&(e=r);return e}getNearestFret(){let t=this.pad,e=Math.abs(t.centerX-this.x);for(const n of u){if(n.row!==this.pad.row||n.col===12)continue;const r=Math.abs(n.centerX-this.x);r<e&&(t=n,e=r)}return t}lift(){if(this.updateGlide(),this.pad&&!this.getHighestFinger(this.pad.row)){const t=this.synth.voices[this.pad.row],e=F(this.pad.row);t.noteOff(e.note,127)}}render(){if(!this.pad)return;const t=F(this.pad.row),e=this.getNearestFret().centerX,n=this.y-this.y0+t.centerY,r="rgba(100, 100, 100, 0.5)";i.beginPath(),i.fillStyle=r,i.arc(e,n,l/3,0,Math.PI*2),i.fill();for(let o of u){if(o.col!==0||o.row===t.row)continue;const a=e-(o.note-t.note)*l;if(a>=innerWidth-f-l)continue;const c=n+o.y-t.y;i.beginPath(),i.strokeStyle=r,i.arc(a,c,l/3,0,Math.PI*2),i.stroke()}}}class Nt extends C{constructor(){super(...arguments),this.velocity=1,this.maxVelocity=0}move(t,e,n){const r=performance.now();this.x=innerWidth-f-l/2,this.y=e,this.prev===void 0?(this.prev={t:performance.now(),y:e},this.velocity=this.maxVelocity=.5):this.velocity=Math.min(10*Math.abs(e-this.prev.y)/(r-this.prev.t)/m,1),this.maxVelocity=Math.max(this.velocity,this.maxVelocity),this.prev.t=r,this.prev.y=e;const o=this.pad;if(this.pad=u.find(p=>p.col===12&&p.contains(this.x,this.y))??null,this.pad===o||!this.pad)return;const{row:a,note:c}=F(this.pad.row),x=h.voices[a],A=[...b.values()].find(p=>{var nt;return p instanceof $&&((nt=p.pad)==null?void 0:nt.row)===a});A&&(A.updateGlide(),x.noteOn(c,127*this.velocity))}lift(){}render(){const t="rgba(100, 100, 100, 0.5)";i.beginPath(),i.fillStyle=t,i.arc(this.x,this.y,l/3,0,Math.PI*2),i.fill()}}function K(s,t){if(!(!s||!t))for(let e of u){if(e.col!==0)continue;const n=e.centerX+(s.note-e.note+t.glide)*l,r=e.centerY-t.slide*(m/2),o=`rgba(100, 100, 100, ${t.pressure})`,a=e.row===s.row;i.beginPath(),a?i.fillStyle=o:i.strokeStyle=o,i.arc(n,r,l/3,0,Math.PI*2),a?i.fill():i.stroke()}}class g{constructor(t){this.thingAbove=t,this.pointer=null}get x(){if(this.thingAbove)return this.thingAbove.x;throw new Error("must override x if no thingAbove")}get rightX(){return this.x+this.w}get y(){if(this.thingAbove)return this.thingAbove.bottomY;throw new Error("must override y if no thingAbove")}get bottomY(){return this.y+this.h}get w(){var t;return((t=this.thingAbove)==null?void 0:t.w)??j}get h(){var t;return((t=this.thingAbove)==null?void 0:t.h)??V}contains(t,e){return this.x<=t&&t<=this.rightX&&this.y<=e&&e<=this.bottomY}get backgroundColor(){return this.pointer?"#ccc":"#ddd"}get foregroundColor(){return M}render(t){i.beginPath(),i.lineWidth=3,i.strokeStyle="#eee",i.roundRect(this.x,this.y,this.w,this.h,v),i.stroke(),i.beginPath(),i.fillStyle=this.backgroundColor,i.roundRect(this.x,this.y,this.w,this.h,v),i.fill(),t&&this.renderLabel(t)}renderOnTop(){}renderLabel(t){i.beginPath(),i.font=Ct,i.fillStyle=this.foregroundColor,i.fillText(t,this.x+(this.w-i.measureText(t).width)/2,this.y+this.h/2),i.fill()}onPointerDown(t,e){}onPointerMove(t,e){}onPointerUp(t,e){}}class dt extends g{constructor(t,e,n){super(),this.synth=t,this.paramNum=e,this.name=n,this.value0=null,this.y0=null}get y(){return f}get w(){return j/2}get h(){return V*3}get foregroundColor(){return h===this.synth?S:M}get backgroundColor(){return h===this.synth?O:U}render(){super.render(),i.beginPath(),i.fillStyle=h===this.synth?Q:Ot,i.roundRect(this.x,this.bottomY,this.w,-this.h*this.value,v),i.fill(),this.renderLabel(this.name)}get value(){var t,e;return((e=(t=this.synth)==null?void 0:t.voices[0])==null?void 0:e.params[this.paramNum])??0}set value(t){this.synth.setParam(this.paramNum,t)}onPointerDown(t,e){this.value0=this.value,this.y0=e}onPointerMove(t,e){const n=e-this.pointer.y0;this.value=D(this.value0-n/this.h,0,1)}}const pt=new class extends dt{get x(){return f}}(Y,6,"vol");class Vt extends g{constructor(t,e,n,r,o,a=!1){super(t instanceof g?t:void 0),this.thingAboveOrGetX=t,this.options=e,this.getValue=n,this.setValue=r,this.valueToString=o,this.placeCurrentValueAtY0=a,this.popUpWidth=0,this.popUpHeight=0,this.popUpX=0,this.popUpY=0,this.optionX=0,this.optionY0=0,this.maxLabelWidth=0,this.optionLabels=e.map(o),a||this.optionLabels.unshift("")}get x(){return this.thingAboveOrGetX instanceof g?super.x:this.thingAboveOrGetX()}get y(){return this.thingAboveOrGetX instanceof g?super.y:f}onPointerDown(t,e){this.pointerPos={initial:{x:t,y:e},current:{x:t,y:e}},i.font=J,this.maxLabelWidth=this.optionLabels.map(r=>i.measureText(r).width).reduce((r,o)=>Math.max(r,o)),this.popUpWidth=1.125*z+this.maxLabelWidth,this.popUpHeight=(this.optionLabels.length+.5)*P;const n=this.pointerPos.initial.x<innerWidth/2;this.popUpX=n?this.pointerPos.initial.x-z/2:this.pointerPos.initial.x-this.popUpWidth+z/2,this.popUpY=this.pointerPos.initial.y-P,this.placeCurrentValueAtY0&&(this.popUpY-=P*this.options.indexOf(this.getValue())),this.optionX=this.popUpX+(n?z:.125*z),this.optionY0=this.popUpY+(this.placeCurrentValueAtY0?0:P),this.onPointerMove(t,e)}onPointerMove(t,e){this.pointerPos.current.x=t,this.pointerPos.current.y=e;const n=this.popUpY+(this.placeCurrentValueAtY0?1:2)*P,r=Math.round((e-n)/P);if(r<0)return;const o=this.options[Math.min(r,this.options.length-1)];o!==this.getValue()&&this.setValue(o)}onPointerUp(t,e){this.pointerPos=void 0}render(){super.render(this.valueToString(this.getValue()))}renderOnTop(){if(!this.pointerPos)return;i.fillStyle="rgba(255, 255, 255, 0.5)",i.filter="drop-shadow(5px 5px 5px)",i.beginPath(),i.roundRect(this.popUpX,this.popUpY,this.popUpWidth,this.popUpHeight,v),i.fill(),i.filter="none",i.filter="blur(10px)",i.fillStyle="rgba(255, 255, 255, 0.8)",i.beginPath(),i.roundRect(this.popUpX,this.popUpY,this.popUpWidth,this.popUpHeight,v),i.fill(),i.filter="none";let t=this.optionY0;for(const e of this.options)t+=P,this.renderOption(this.valueToString(e),this.getValue()===e,this.optionX,t)}renderOption(t,e,n,r){i.font=J,e&&(i.filter="blur(10px)",i.beginPath(),i.fillStyle=O,i.roundRect(n-W,r-P+ot,this.maxLabelWidth+2*W,P,v*2),i.fill(),i.filter="none"),i.beginPath(),i.fillStyle=e?"#333":"#999",i.fillText(t,n,r),i.fill()}}class Z extends Vt{constructor(t,e,n,r,o,a,c,x,A=!1){super(()=>0,r,o,a,c,A),this.parent=t,this.vPlacement=e,this.hPlacement=n,this.isActive=x}get x(){return this.hPlacement==="left"?this.parent.x+W:this.parent.rightX-this.w-W}get y(){return this.vPlacement==="top"?this.parent.y+W:this.parent.bottomY-this.h-W+ot}get w(){return i.font=J,i.measureText(this.valueToPaddedString(this.getValue())).width}get h(){return P}render(){this.renderLabel(this.valueToPaddedString(this.getValue()))}valueToPaddedString(t){return this.hPlacement==="left"?this.valueToString(t)+"    ":"    "+this.valueToString(t)}get foregroundColor(){return this.isActive()?S:M}}const N=class N extends g{constructor(t){super(),this.synth=t}get y(){return f}get w(){return l*3.5}get h(){return V*3}onPointerDown(t,e){h=this.synth}render(){super.render();const t=this.synth.getTimeDomainData();if(!t)return;const e=this.synth.getLowestNoteFreq(),n=st/e,r=Math.round(n*2);let o=0;for(let p=0;p<t.length-1;p++)if(t[p]<=128&&t[p+1]>128){o=p;break}i.beginPath();const a=Math.min(r,t.length-o),c=this.w/a;let x=this.x,A=0;for(let p=o;p<a;p++)A=t[p]/128*this.h/2,p===o?i.moveTo(x,A):i.lineTo(x,A),x+=c;i.lineWidth=1,i.strokeStyle=h===this.synth?Xt:St,i.stroke()}get foregroundColor(){return h===this.synth?S:M}get backgroundColor(){return h===this.synth?O:U}};N.gradient=i.createLinearGradient(0,0,0,q.height),N.gradient.addColorStop(0,"rgba(0, 255, 255, 0.8)"),N.gradient.addColorStop(1,"rgba(0, 0, 128, 0.2)");let G=N;const L=new class extends G{get x(){return pt.rightX}}(Y),Gt=Y.patchSelector(L),It=Y.modeSelector(L),Ht=Y.octaveSelector(L);class _ extends g{constructor(t,e,n){super(n instanceof g?n:void 0),this.paramNum=t,this.name=e,this.thingAboveOrGetX=n,this.value0=null,this.x0=null}get x(){return this.thingAboveOrGetX instanceof g?super.x:this.thingAboveOrGetX()}get y(){return this.thingAboveOrGetX instanceof g?super.y:f}get w(){return l*3}get foregroundColor(){return S}get backgroundColor(){return O}render(){super.render(),i.beginPath(),i.fillStyle=Q,i.roundRect(this.x,this.y,this.w*this.value,this.h,v),i.fill(),this.renderLabel(this.name)}get value(){var t;return((t=h==null?void 0:h.voices[0])==null?void 0:t.params[this.paramNum])??0}set value(t){h.setParam(this.paramNum,t)}onPointerDown(t,e){this.value0=this.value,this.x0=t}onPointerMove(t,e){const n=t-this.pointer.x0;this.value=D(this.value0+n/this.w,0,1)}}const tt=new _(3,"param A",()=>L.x+L.w),ut=new _(4,"param B",tt),$t=new _(5,"param C",ut),E=new class extends G{get x(){return tt.rightX}}(d),Qt=d.patchSelector(E),jt=d.modeSelector(E),Jt=d.octaveSelector(E),Kt=new class extends dt{get x(){return E.rightX}}(d,6,"vol");let I=120;const mt=new class extends g{constructor(){super(...arguments),this.tempo0=null}get x(){return innerWidth-f-this.w}get y(){return f}render(){super.render(`tempo ${I}`)}onPointerDown(s,t){this.tempo0=I}onPointerMove(s,t){const e=t-this.pointer.y0;I=D(Math.round(this.tempo0-e/10),10,200),d.sendToWorklet({command:"set tempo",value:I})}get foregroundColor(){return h===d?S:M}get backgroundColor(){return h===d?O:U}};let y=[],k,et=0;const ft=new class extends g{render(){super.render(k==="playing"?`step ${et+1} / ${y.length}`:y.length===0?"record steps":`${y.length} steps`)}onPointerDown(){it(),y=[],k="recording"}onPointerUp(){d.sendToWorklet({command:"load steps",steps:y}),y.length>0?gt():it()}get foregroundColor(){return h===d?S:M}get backgroundColor(){return h===d?O:U}}(mt),Zt=new class extends g{render(){super.render(k==="recording"?"add rest":k==="playing"?"stop":"play")}onPointerDown(){k==="recording"?y.push([]):k==="playing"?it():gt()}get foregroundColor(){return h===d?S:M}get backgroundColor(){return h===d?O:U}}(ft);function gt(){y.length!==0&&(d.setParam(0,0),k="playing",et=0,d.sendToWorklet({command:"start sequencer"}))}function it(){k="stopped",d.sendToWorklet({command:"stop sequencer"});for(const s of u)s.isBeingPlayedBySequencer=!1}const B=[pt,L,Gt,It,Ht,tt,ut,$t,E,Qt,jt,Jt,Kt,mt,ft,Zt];window.addEventListener("pointerdown",s=>{for(let t=B.length-1;t>=0;t--){const e=B[t];if(e.contains(s.clientX,s.clientY)){e.onPointerDown(s.clientX,s.clientY),e.pointer={id:s.pointerId,x0:s.clientX,y0:s.clientY},s.preventDefault();break}}}),window.addEventListener("pointermove",s=>{var t;for(const e of B)if(((t=e.pointer)==null?void 0:t.id)===s.pointerId){e.onPointerMove(s.clientX,s.clientY),s.preventDefault();break}}),window.addEventListener("pointerup",s=>{var t;for(const e of B)if(((t=e.pointer)==null?void 0:t.id)===s.pointerId){e.onPointerUp(s.clientX,s.clientY),e.pointer=null,s.preventDefault();break}});function wt(){i.clearRect(0,0,innerWidth,innerHeight);for(const t of B)t.render();for(const t of u)t.render();for(const t of b.values())t.render();for(const t of B)t.renderOnTop();i.font="16px Inter";const{width:s}=i.measureText(T);i.beginPath(),i.fillStyle="#00ff",i.fillText(T,innerWidth-s-20,innerHeight-20),i.fill(),C.updateQuantizationOffsets(),requestAnimationFrame(wt)}wt();const X=new AudioContext({latencyHint:"balanced",sampleRate:st});let R="need initialization";function _t(){return R==="ready"?!0:(R==="need initialization"&&te(),!1)}async function te(){R==="need initialization"&&(R="initializing",T="initializing audio...",X.resume(),T="loading worklet...",await X.audioWorklet.addModule(bt),Y.init(),d.init(),d.sendToWorklet({command:"load steps",steps:y}),R="ready",T="ready!",await ie(2),T="")}function ee(s){switch(s.event){case"seq step":{s.action==="noteOn"&&(et=s.index);for(const t of y[s.index]||[])for(const e of u)e.note===t&&(e.isBeingPlayedBySequencer=s.action==="noteOn");break}case"log":{T=s.message;break}default:T="??? "+JSON.stringify(s);break}}window.addEventListener("pointerdown",()=>{(X.state==="suspended"||X.state==="interrupted")&&X.resume()}),window.addEventListener("pointerdown",async s=>{if(!_t())return;const t=[...b.values()].some(e=>!!e.pad);for(const e of u)if(e.contains(s.clientX,s.clientY)){k==="recording"&&h===d&&(t||y.push([]),y.at(-1).push(e.note)),C.add(s.pointerId,s.clientX,s.clientY,vt(s));break}}),window.addEventListener("pointermove",s=>{const t=b.get(s.pointerId);t&&(t.move(s.clientX,s.clientY,vt(s)),s.preventDefault())}),window.addEventListener("pointerup",yt),window.addEventListener("pointercancel",yt);function yt(s){const t=b.get(s.pointerId);t&&(b.delete(s.pointerId),t.lift())}function vt(s){return s.pointerType==="pen"?s.pressure:s.pointerType==="touch"?Math.abs(Math.max(s.width,s.height)-20)/130:1}function ie(s){return new Promise(t=>setTimeout(t,s*1e3))}
