(function(){const i=document.createElement("link").relList;if(i&&i.supports&&i.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))e(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const r of o.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&e(r)}).observe(document,{childList:!0,subtree:!0});function t(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerPolicy&&(o.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?o.credentials="include":n.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function e(n){if(n.ep)return;n.ep=!0;const o=t(n);fetch(n.href,o)}})();const dt=""+new URL("msynth-worklet-HlCev5aV.js",import.meta.url).href;function ct(i,t,e){return new Uint8Array([144|i&15,t&127,e&127])}function pt(i,t,e){return new Uint8Array([128|i&15,t&127,e&127])}const V=96e3;function ut(i){return 440*Math.pow(2,(i-69)/12)}function q(i,t,e){return Math.max(t,Math.min(i,e))}class g{constructor(t,e,n){this.name=t,this.code=e,this.options=n}}const $=[new g("rebel yell",`
      ampEnv = adsr(0.03, 0, 1, 0.1)
      mod = param3 lglide(0.05) norm abs scale(0.45, 0.55)
      dry = noteFreq pwm(mod) lpf(6000, 0.2) * ampEnv
      out = dry + 0.5 * dry delay(0.4)
    `,{octave:1,mode:"mpe"}),new g("hello again",`
      sync = 0.6
      osc1 = (noteFreq / 4) pwm
      osc2 = sync * 500 * ad(0.2, 0.5) >> pwm(0.5, osc1)
      out = osc2 * adsr(0.05, 0, 1, 0.2)
    `,{octave:-1}),new g("duran duran",`
      decay = 0.102
      delayAmt = 0.547
      detuneAmt = 0.252
      portamento = paramA
      freq = (paramB abs - 0.5) ifPos(noteFreq * 2, noteFreq)
      f1 = freq eglide(portamento)
      f2 = f1 * detuneAmt escale(1.01, 1.05)
      oscs = (f1 pwm + f2 pwm) / 2
      dry = oscs * adsr(0, 0, 1, decay escale(0.1, 2))
      out = dry + delayAmt * dry delay(0.378)
    `,{mono:!0,mode:"piano"}),new g("stranger things",`
      release = paramA
      resonance = (paramB norm - 0.5) abs scale(0.15, 1)
      pwmRate = 0.218
      osc1 = noteFreq pwm(pwmRate sine norm scale(0.2, 0.8))
      osc2 = (2 * noteFreq * 1.005) pwm(pwmRate sine norm scale(0.4, 0.6))
      out = (osc1 + osc2) lpf(10000 * adsr(0.001, 0, 1, 0.5), resonance) * adsr(0, 0, 1, release)
    `,{octave:-2,paramA:.8,paramB:.5}),new g("tom sawyer",`
      resonance = paramA
      w = 0.5 + (1/5) sine norm scale(0, 0.4)
      detune1 = 0.091 * 0.01
      detune2 = 0.836 * 0.01
      delayAmt = paramB
      oscs =
        (
          (noteFreq * (1 - detune1)) pwm(w) +
          (noteFreq * (1 + detune1)) pwm(w) +
          (noteFreq * (1 - 3 * detune2)) pwm(w) +
          (noteFreq * (1 + 3 * detune2)) pwm(w)
        ) / 4
      filterEnv = adsr(0.05, 0, 1, 6) escale(0, 1)
      ampEnv = adsr(0, 0, 1, 12)
      dry = oscs lpf12(10000 * filterEnv, resonance) * ampEnv
      out = dry + delayAmt * dry delay(0.15) >> dcBlock
    `,{mode:"piano",octave:-2,paramA:.755,paramB:.127}),new g("guitar",`
      cutoff = paramA
      feedback = paramB scale(0.9, 0.999)
      burst  = noise * gate(0.005)
      filter = (burst + filter) delay(1 / noteFreq) lpf12(20000 * cutoff, 0) * feedback
      out = burst + filter * adsr(0, 0, 1, 0.1)
    `,{paramA:1,paramB:.99,octave:-1,mode:"strum"}),new g("12 string",`
      cutoff = paramA
      feedback = paramB scale(0.9, 0.999)
      burst  = noise * gate(0.005)
      string1 = (burst + string1) delay(1 / noteFreq) lpf12(20000 * cutoff, 0) * feedback
      string2 = (burst + string2) delay(1 / (noteFreq * 2)) lpf12(20000 * cutoff, 0) * feedback
      out = burst + (string1 + string2) * adsr(0, 0, 1, 0.1)
    `,{paramA:1,paramB:.99,octave:-1,mode:"strum"}),new g("strum bass",`
      out = noteFreq sine * ad(0.01, 5) * adsr(0, 0, 1, 0.1)
    `,{paramA:.2,paramB:1,octave:-2,mode:"strum"}),new g("rick and morty",`
      sound1 = noise bpf(0.2 sine * 800 + 1200, 1)
      sound2 = noise bpf(-(0.25 sine) * 800 + 1200, 1)
      ring = (sound1 + sound1 delay(2) + sound2) * 5.5 pwm norm * 0.5
      out = ring * adsr(0.01, 0, 1, 2)
    `),new g("pwm",`
      out = noteFreq pwm(slide lglide(0.05) norm scale(0.2, 0.8)) * adsr(0.05, 0, 1, 0.4)
    `),new g("pwm pencil",`
      out = noteFreq pwm(slide lglide(0.05) norm scale(0.2, 0.8)) * adsr(0.05, 0, 1, 0.4) * pressure
    `),new g("sine",`
      out = noteFreq sine * adsr(0.01, 0, 1, 0.3)
    `)],ft=document.getElementById("ui"),T=document.createElement("canvas"),s=T.getContext("2d");ft.appendChild(T);const p=2;let h=0,f=0,M=0,X=0,mt="18px sans-serif";function Q(){T.style.width=innerWidth+"px",T.style.height=innerHeight+"px",T.width=innerWidth*devicePixelRatio,T.height=innerHeight*devicePixelRatio,s.scale(devicePixelRatio,devicePixelRatio),h=(innerWidth-2*p)/13,f=(innerHeight-2*p)/8,M=h*1.5,X=f/1.5}window.addEventListener("resize",Q),Q();const gt=8;let A="tap here";class wt{constructor(t,e){this.synth=t,this.channel=e,this.params=new Float32Array(new SharedArrayBuffer(512)),this.note=-1}noteOn(t,e){this.isOn&&this.noteOff(this.note,127),this.note=t,this.synth.sendToWorklet({command:"process midi message",data:ct(this.channel,t,e)})}noteOff(t,e){this.note=-1,this.synth.sendToWorklet({command:"process midi message",data:pt(this.channel,t,e)})}get isOn(){return this.note!==-1}get freq(){return ut(this.note)*Math.pow(2,this.params[0]/12)}set glide(t){this.params[0]=t}get glide(){return this.params[0]}set slide(t){this.params[1]=t}get slide(){return this.params[1]}set pressure(t){this.params[2]=t}get pressure(){return this.params[2]}set paramA(t){this.params[3]=t}get paramA(){return this.params[3]}set paramB(t){this.params[4]=t}get paramB(){return this.params[4]}set gain(t){this.params[5]=t}get gain(){return this.params[5]}}class j{constructor(t="pwm"){if(this.mode="mpe",this.worklet=null,this.voices=[],this.octave=0,this.analyzer=null,this.timeDomainData=null,this.lnf=220,this.patch=$.find(e=>e.name===t),!this.patch)throw new Error("unknown patch name! "+t);for(let e=0;e<gt;e++)this.voices.push(new wt(this,e))}init(){this.worklet=new AudioWorkletNode(O,"msynth"),this.sendToWorklet({command:"init",voiceParams:this.voices.map(e=>e.params.buffer)}),this.analyzer=O.createAnalyser(),this.analyzer.fftSize=32768;const t=this.analyzer.frequencyBinCount;this.timeDomainData=new Uint8Array(t),this.worklet.channelInterpretation="discrete",this.worklet.channelCount=2,this.worklet.channelCountMode="explicit",this.worklet.connect(this.analyzer).connect(O.destination),this.worklet.port.onmessage=e=>zt(e.data),this.loadPatch(this.patch)}getTimeDomainData(){return!this.analyzer||!this.timeDomainData?null:(this.analyzer.getByteTimeDomainData(this.timeDomainData),this.timeDomainData)}toggleMode(){this.mode=this.mode==="mpe"?"piano":this.mode==="piano"?"guitar":this.mode==="guitar"?"strum":"mpe"}sendToWorklet(t){var e;(e=this.worklet)==null||e.port.postMessage(t)}loadPatch(t){var e,n,o,r,a;this.patch=t,this.sendToWorklet({command:"load patch",code:t.code,mono:((e=t.options)==null?void 0:e.mono)??!1}),this.setParam(3,((n=t.options)==null?void 0:n.paramA)??0),this.setParam(4,((o=t.options)==null?void 0:o.paramB)??0),this.setParam(5,.2),this.octave=((r=t.options)==null?void 0:r.octave)??0,this.mode=((a=t.options)==null?void 0:a.mode)??"mpe"}grabVoice(){var n;if((n=this.patch.options)!=null&&n.mono)return this.voices[0];const t=[...y.values()],e=this.voices.findLast(o=>!t.some(r=>r.voice===o))??this.voices.at(-1);return this.voices.splice(this.voices.indexOf(e),1),this.voices.unshift(e),e}setParam(t,e){for(const n of this.voices)n.params[t]=e}getLowestNoteFreq(){let t=1/0;for(const e of this.voices)e.isOn&&e.freq<t&&(t=e.freq);return Number.isFinite(t)&&(this.lnf=t),this.lnf}patchSelector(t){return new H(t,$,()=>this.patch,e=>{this.loadPatch(e)},e=>e.name)}modeSelector(t){return new H(t,["mpe","guitar","piano","strum"],()=>this.mode,e=>{this.mode=e},e=>e)}octaveSelector(t){return new H(t,[2,1,0,-1,-2],()=>this.octave,e=>{this.octave=e},e=>(e>0?"+":"")+e)}}const b=new j("rebel yell"),u=new j("stranger things");let m=b;const yt=47,vt=5,P=5;class xt{constructor(t,e,n){this.col=t,this.row=e,this.noteName=n,this.isBeingPlayedBySequencer=!1}get note(){return yt+12*m.octave+vt*(7-this.row)+this.col}get x(){return p+this.col*h}get y(){return p+this.row*f}get centerX(){return this.x+h/2}get centerY(){return this.y+f/2}contains(t,e){return this.x<=t&&t<=this.x+h&&this.y<=e&&e<=this.y+f}render(){if(s.beginPath(),s.lineWidth=3,s.strokeStyle="#eee",s.roundRect(this.x,this.y,h,f,P),s.stroke(),m.mode==="strum"&&this.col===12){s.beginPath(),s.fillStyle="#aaa",s.roundRect(this.x,this.y,h,f,P),s.fill();return}s.beginPath(),s.fillStyle=this.noteName===""?"#ccc":"#ddd",s.roundRect(this.x,this.y,h,f,P),s.fill(),m===u&&this.isBeingPlayedBySequencer&&(s.beginPath(),s.fillStyle=this.noteName===""?"#eee":"#bbb",s.roundRect(this.x+20,this.y+20,h-40,f-40,P),s.fill()),this.noteName!==""&&(s.beginPath(),s.font="14px sans-serif",s.fillStyle="#bbb",s.fillText(this.noteName,this.x+4,this.y+16),s.fill())}}const c=[],bt=["C","","D","","E","F","","G","","A","","B"];let J=0;for(let i=2;i<=7;i++){for(let t=0;t<=12;t++)c.push(new xt(t,i,bt[(J+t)%12]));J+=7}const y=new Map;class Pt{constructor(){this.windowMs=150,this.history=[]}addPos(t){this.history.push({pos:t,t:performance.now()})}get speed(){const t=performance.now();if(this.history=this.history.filter(({t:o})=>t-o<=this.windowMs),this.history.length<2)return 0;let e=0;for(let o=1;o<this.history.length;o++)e+=Math.abs(this.history[o].pos-this.history[o-1].pos);const n=this.history[this.history.length-1].t-this.history[0].t;return e/n}}class S{constructor(t,e,n,o,r){this.id=t,this.x0=e,this.y0=n,this.pressure=o,this.synth=r,this.quantizationOffset=0,this.voice=null,this.pad=null,this.speedTracker=new Pt,this.lastT=0,this.x=e,this.y=n,y.set(t,this),this.move(e,n,o)}static add(t,e,n,o,r=m){switch(r.mode){case"piano":return new kt(t,e,n,o,r);case"mpe":return new K(t,e,n,o,r);case"guitar":return new R(t,e,n,o,r);case"strum":{const a=c.find(l=>l.contains(e,n));return a&&a.col===12?new Ot(t,e,n,o,r):new U(t,e,n,o,r)}default:throw new Error("unknown mode! "+r.mode)}}static updateQuantizationOffsets(){for(const t of y.values())(t instanceof K||t instanceof R)&&t.updateQuantizationOffset()}updateQuantizationOffset(){const t=c.find(r=>{var a;return r.row===((a=this.pad)==null?void 0:a.row)&&r.contains(this.x,this.y)});if(this.speedTracker.speed>.025||!this.pad||!t){this.lastT=performance.now();return}const e=performance.now(),n=.002*(e-this.lastT),o=(t.centerX-this.x)/h;this.quantizationOffset=n*o+(1-n)*this.quantizationOffset,this.updateGlide(),this.lastT=e}updateGlide(){this.voice.glide=(this.x-this.pad.centerX)/h+this.quantizationOffset}}class kt extends S{move(t,e,n){const o=c.find(a=>a.contains(t,e))??this.pad,r=o!==this.pad;this.pad&&r&&(this.voice.noteOff(this.pad.note,127),this.voice=null),o&&r&&(this.voice=this.synth.grabVoice()),this.pad=o,this.pad&&(this.voice.glide=0,this.voice.slide=q((this.pad.centerY-e)/(f/2),-1,1),this.voice.pressure=n,r&&this.voice.noteOn(this.pad.note,127))}lift(){var t;(t=this.voice)==null||t.noteOff(this.pad.note,127)}render(){L(this.pad,this.voice)}}class K extends S{move(t,e,n){this.x=t,this.y=e,this.speedTracker.addPos(t);const o=c.find(a=>{var l;return a.row!==((l=this.pad)==null?void 0:l.row)&&a.contains(t,e)})??this.pad,r=o!==this.pad;this.pad&&r&&(this.voice.noteOff(this.pad.note,127),this.voice=null),o&&r&&(this.voice=this.synth.grabVoice(),this.quantizationOffset=(o.centerX-t)/h),this.pad=o,this.pad&&(this.updateGlide(),this.voice.slide=q((this.pad.centerY-e)/(f/2),-1,1),this.voice.pressure=n,r&&this.voice.noteOn(this.pad.note,127))}lift(){var t;(t=this.voice)==null||t.noteOff(this.pad.note,127)}render(){L(this.pad,this.voice)}}class R extends S{constructor(){super(...arguments),this.pressure=0}move(t,e,n){this.x=t,this.y=e,this.pressure=n,this.speedTracker.addPos(t);const o=c.find(l=>{var x;return l.row!==((x=this.pad)==null?void 0:x.row)&&l.contains(t,e)}),r=o?W(o.row):this.pad,a=r!==this.pad;if(this.pad&&a){const l=this.pad.row;this.pad=null,this.updateRow(l),this.voice=null}r&&a&&(this.voice=this.synth.voices[r.row],this.quantizationOffset=(o.centerX-t)/h),this.pad=r,this.pad&&this.updateRow(this.pad.row)}updateRow(t){const e=this.synth.voices[t],n=W(t),o=this.getHighestFinger(t);o?(o.updateParams(),e.isOn||e.noteOn(n.note,127)):e.noteOff(n.note,127)}getHighestFinger(t){var n;let e=null;for(const o of y.values())!(o instanceof R)||((n=o.pad)==null?void 0:n.row)!==t||(!e||o.x>e.x)&&(e=o);return e}updateParams(){if(!this.pad||!this.voice)throw new Error("invariant violated!!!");this.updateGlide(),this.voice.slide=q((this.pad.centerY-this.y)/(f/2),-1,1),this.voice.pressure=this.pressure}lift(){this.pad&&this.updateRow(this.pad.row)}render(){L(this.pad,this.voice)}}function W(i){return c.find(t=>t.row===i&&t.col===0)}const At=.5;class U extends S{constructor(){super(...arguments),this.pressure=0}move(t,e,n){this.pad||(this.pad=c.find(o=>o.col<12&&o.contains(t,e))??null),this.x=t,this.y=e,this.pressure=n,this.updateGlide()}updateGlide(){var t;this.pad&&((t=this.getHighestFinger(this.pad.row))==null||t._updateGlide())}_updateGlide(){const{row:t}=this.pad,e=W(t),n=Math.abs(this.y-this.y0)/f*At,o=this.synth.voices[t],r=this.getNearestFret();o.glide=r.note+n-e.note}getHighestFinger(t){var n;let e=null;for(const o of y.values())!(o instanceof U)||((n=o.pad)==null?void 0:n.row)!==t||(!e||o.x>e.x)&&(e=o);return e}getNearestFret(){let t=this.pad,e=Math.abs(t.centerX-this.x);for(const n of c){if(n.row!==this.pad.row||n.col===12)continue;const o=Math.abs(n.centerX-this.x);o<e&&(t=n,e=o)}return t}lift(){if(this.updateGlide(),this.pad&&!this.getHighestFinger(this.pad.row)){const t=this.synth.voices[this.pad.row],e=W(this.pad.row);t.noteOff(e.note,127)}}render(){if(!this.pad)return;const t=W(this.pad.row),e=this.getNearestFret().centerX,n=this.y-this.y0+t.centerY,o="rgba(100, 100, 100, 0.5)";s.beginPath(),s.fillStyle=o,s.arc(e,n,h/3,0,Math.PI*2),s.fill();for(let r of c){if(r.col!==0||r.row===t.row)continue;const a=e-(r.note-t.note)*h;if(a>=innerWidth-p-h)continue;const l=n+r.y-t.y;s.beginPath(),s.strokeStyle=o,s.arc(a,l,h/3,0,Math.PI*2),s.stroke()}}}class Ot extends S{move(t,e,n){this.x=innerWidth-p-h/2,this.y=e;const o=this.pad;if(this.pad=c.find(d=>d.col===12&&d.contains(this.x,this.y))??null,this.pad===o||!this.pad)return;const{row:r,note:a}=W(this.pad.row),l=m.voices[r],x=[...y.values()].find(d=>{var F;return d instanceof U&&((F=d.pad)==null?void 0:F.row)===r});x&&(x.updateGlide(),l.noteOn(a,127))}lift(){}render(){const t="rgba(100, 100, 100, 0.5)";s.beginPath(),s.fillStyle=t,s.arc(this.x,this.y,h/3,0,Math.PI*2),s.fill()}}function L(i,t){if(!(!i||!t))for(let e of c){if(e.col!==0)continue;const n=e.centerX+(i.note-e.note+t.glide)*h,o=e.centerY-t.slide*(f/2),r=`rgba(100, 100, 100, ${t.pressure})`,a=e.row===i.row;s.beginPath(),a?s.fillStyle=r:s.strokeStyle=r,s.arc(n,o,h/3,0,Math.PI*2),a?s.fill():s.stroke()}}class v{constructor(t){this.thingAbove=t,this.pointer=null}get x(){if(this.thingAbove)return this.thingAbove.x;throw new Error("must override x if no thingAbove")}get y(){if(this.thingAbove)return this.thingAbove.y+this.thingAbove.h;throw new Error("must override y if no thingAbove")}get w(){var t;return((t=this.thingAbove)==null?void 0:t.w)??M}get h(){var t;return((t=this.thingAbove)==null?void 0:t.h)??X}contains(t,e){return this.x<=t&&t<=this.x+this.w&&this.y<=e&&e<=this.y+this.h}get backgroundColor(){return this.pointer?"#ccc":"#ddd"}get foregroundColor(){return this.pointer?"#fff":"#888"}render(t){s.beginPath(),s.lineWidth=3,s.strokeStyle="#eee",s.roundRect(this.x,this.y,this.w,this.h,P),s.stroke(),s.beginPath(),s.fillStyle=this.backgroundColor,s.roundRect(this.x,this.y,this.w,this.h,P),s.fill(),t&&this.renderLabel(t)}renderOnTop(){}renderLabel(t){s.beginPath(),s.font=mt,s.fillStyle="#888",s.fillText(t,this.x+(this.w-s.measureText(t).width)/2,this.y+this.h/2),s.fill()}onPointerDown(t,e){}onPointerMove(t,e){}onPointerUp(t,e){}}class Z extends v{constructor(t,e,n){super(),this.synth=t,this.paramNum=e,this.name=n,this.value0=null,this.y0=null}get y(){return p}get w(){return M/2}get h(){return X*3}get backgroundColor(){return"#ddd"}render(){super.render(),s.beginPath(),s.fillStyle="#ccc",s.roundRect(this.x,this.y+this.h,this.w,-this.h*this.value,P),s.fill(),this.renderLabel(this.name)}get value(){var t,e;return((e=(t=this.synth)==null?void 0:t.voices[0])==null?void 0:e.params[this.paramNum])??0}set value(t){this.synth.setParam(this.paramNum,t)}onPointerDown(t,e){this.value0=this.value,this.y0=e}onPointerMove(t,e){const n=e-this.pointer.y0;this.value=q(this.value0-n/this.h,0,1)}}const N=new class extends Z{get x(){return p}}(b,5,"vol 1"),St=new class extends Z{get x(){return N.x+N.w}}(u,5,"vol 2");class H extends v{constructor(t,e,n,o,r){super(t instanceof v?t:void 0),this.thingAboveOrGetX=t,this.options=e,this.getValue=n,this.setValue=o,this.valueToString=r,this.lineHeight=30,this.baselineAdjustment=10,this.fingerWidth=150,this.font="18px sans-serif",this.popUpWidth=0,this.popUpX=0,this.popUpY=0}get x(){return this.thingAboveOrGetX instanceof v?super.x:this.thingAboveOrGetX()}get y(){return this.thingAboveOrGetX instanceof v?super.y:p}onPointerDown(t,e){this.pointerPos={initial:{x:t,y:e},current:{x:t,y:e}},this.onPointerMove(t,e)}onPointerMove(t,e){this.pointerPos.current.x=t,this.pointerPos.current.y=e;const n=this.popUpY+2*this.lineHeight,o=Math.round((e-n)/this.lineHeight);if(o<0)return;const r=this.options[Math.min(o,this.options.length-1)];r!==this.getValue()&&this.setValue(r)}onPointerUp(t,e){this.pointerPos=void 0}render(){super.render(this.valueToString(this.getValue()))}renderOnTop(){if(!this.pointerPos)return;s.font=this.font;const t="";this.popUpWidth=1.125*this.fingerWidth+[t,...this.options.map(this.valueToString)].map(a=>s.measureText(a).width).reduce((a,l)=>Math.max(a,l));const e=this.pointerPos.initial.x<innerWidth/2,n=(this.options.length+1.5)*this.lineHeight;this.popUpX=e?this.pointerPos.initial.x-this.fingerWidth/2:this.pointerPos.initial.x-this.popUpWidth+this.fingerWidth/2,this.popUpY=this.pointerPos.initial.y-this.lineHeight,s.fillStyle="#efefef",s.beginPath(),s.roundRect(this.popUpX,this.popUpY,this.popUpWidth,n,P),s.fill();const o=this.popUpX+(e?this.fingerWidth:.125*this.fingerWidth);let r=this.popUpY+this.lineHeight;this.renderOption(t,!1,o,r);for(const a of this.options)r+=this.lineHeight,this.renderOption(this.valueToString(a),this.getValue()===a,o,r)}renderOption(t,e,n,o){e&&(s.beginPath(),s.fillStyle="#ddd",s.roundRect(this.popUpX,o-this.lineHeight+this.baselineAdjustment,this.popUpWidth,this.lineHeight,P),s.fill()),s.beginPath(),s.font=`${e?" bold":"normal"} ${this.font}`,s.fillStyle=e?"#333":"#555",s.fillText(t,n,o),s.fill()}}class _ extends v{constructor(t){super(),this.synth=t}get y(){return p}get w(){return M*1.5}get h(){return X*3}render(){super.render();const t=this.synth.getTimeDomainData();if(!t)return;const e=this.synth.getLowestNoteFreq(),n=V/e,o=Math.round(n*2);let r=0;for(let d=0;d<t.length-1;d++)if(t[d]<=128&&t[d+1]>128){r=d;break}s.lineWidth=1,s.strokeStyle=this.foregroundColor,s.beginPath();const a=Math.min(o,t.length-r),l=this.w/a;let x=this.x;for(let d=r;d<a;d++){if(x>this.x+this.w+10)debugger;const F=t[d]/128*this.h/2;d===r?s.moveTo(x,F):s.lineTo(x,F),x+=l}s.stroke()}}const z=b.patchSelector(()=>p+1.5*h),tt=b.modeSelector(z),qt=b.octaveSelector(tt),Tt=new class extends _{get x(){return z.x+z.w}}(b);class et extends v{constructor(t,e,n){super(n),this.paramNum=t,this.name=e,this.value0=null,this.x0=null}get backgroundColor(){return"#ddd"}render(){super.render(),s.beginPath(),s.fillStyle="#ccc",s.roundRect(this.x,this.y,this.w*this.value,this.h,P),s.fill(),this.renderLabel(this.name)}get value(){var t;return((t=m==null?void 0:m.voices[0])==null?void 0:t.params[this.paramNum])??0}set value(t){m.setParam(this.paramNum,t)}onPointerDown(t,e){this.value0=this.value,this.x0=t}onPointerMove(t,e){const n=t-this.pointer.x0;this.value=q(this.value0+n/this.w,0,1)}}const it=new class extends v{get x(){return p+h*5}get y(){return p}get w(){return M*2}render(){super.render(m===b?"\u2190 controlling synth 1":"controlling synth 2 \u2192")}onPointerDown(){m=m===b?u:b}},st=new et(3,"param A",it),Mt=new et(4,"param B",st),Y=u.patchSelector(()=>G.x-M),nt=u.modeSelector(Y),Wt=u.octaveSelector(nt),Ft=new class extends _{get x(){return Y.x-this.w}}(u);let E=120;const G=new class extends v{constructor(){super(...arguments),this.tempo0=null}get x(){return innerWidth-p-this.w}get y(){return p}render(){super.render(`tempo ${E}`)}onPointerDown(i,t){this.tempo0=E}onPointerMove(i,t){const e=t-this.pointer.y0;E=q(Math.round(this.tempo0-e/10),10,200),u.sendToWorklet({command:"set tempo",value:E})}};let w=[],k,C=0;const ot=new class extends v{render(){super.render(k==="playing"?`step ${C+1} / ${w.length}`:w.length===0?"record steps":`${w.length} steps`)}onPointerDown(){I(),w=[],k="recording"}onPointerUp(){u.sendToWorklet({command:"load steps",steps:w}),w.length>0?rt():I()}}(G),Dt=new class extends v{render(){super.render(k==="recording"?"add rest":k==="playing"?"stop":"play")}onPointerDown(){k==="recording"?w.push([]):k==="playing"?I():rt()}}(ot);function rt(){w.length!==0&&(u.setParam(0,0),k="playing",C=0,u.sendToWorklet({command:"start sequencer"}))}function I(){k="stopped",u.sendToWorklet({command:"stop sequencer"});for(const i of c)i.isBeingPlayedBySequencer=!1}const D=[N,St,z,tt,qt,Tt,it,st,Mt,Y,nt,Wt,Ft,G,ot,Dt];window.addEventListener("pointerdown",i=>{for(const t of D)t.contains(i.clientX,i.clientY)&&(t.onPointerDown(i.clientX,i.clientY),t.pointer={id:i.pointerId,x0:i.clientX,y0:i.clientY},i.preventDefault())}),window.addEventListener("pointermove",i=>{var t;for(const e of D)((t=e.pointer)==null?void 0:t.id)===i.pointerId&&(e.onPointerMove(i.clientX,i.clientY),i.preventDefault())}),window.addEventListener("pointerup",i=>{var t;for(const e of D)((t=e.pointer)==null?void 0:t.id)===i.pointerId&&(e.onPointerUp(i.clientX,i.clientY),e.pointer=null,i.preventDefault())});function at(){s.clearRect(0,0,innerWidth,innerHeight);for(const t of D)t.render();for(const t of c)t.render();for(const t of y.values())t.render();for(const t of D)t.renderOnTop();s.font="16px sans-serif";const{width:i}=s.measureText(A);s.beginPath(),s.fillStyle="#00ff",s.fillText(A,innerWidth-i-20,innerHeight-20),s.fill(),S.updateQuantizationOffsets(),requestAnimationFrame(at)}at();const O=new AudioContext({latencyHint:"balanced",sampleRate:V});let B="need initialization";function Bt(){return B==="ready"?!0:(B==="need initialization"&&Xt(),!1)}async function Xt(){B==="need initialization"&&(B="initializing",A="initializing audio...",O.resume(),A="loading worklet...",await O.audioWorklet.addModule(dt),b.init(),u.init(),u.sendToWorklet({command:"load steps",steps:w}),B="ready",A="ready!",await Et(2),A="")}function zt(i){switch(i.event){case"seq step":{i.action==="noteOn"&&(C=i.index);for(const t of w[i.index]||[])for(const e of c)e.note===t&&(e.isBeingPlayedBySequencer=i.action==="noteOn");break}case"log":{A=i.message;break}default:A="??? "+JSON.stringify(i);break}}window.addEventListener("pointerdown",()=>{(O.state==="suspended"||O.state==="interrupted")&&O.resume()}),window.addEventListener("pointerdown",async i=>{if(!Bt())return;const t=[...y.values()].some(e=>!!e.pad);for(const e of c)if(e.contains(i.clientX,i.clientY)){k==="recording"&&m===u&&(t||w.push([]),w.at(-1).push(e.note)),S.add(i.pointerId,i.clientX,i.clientY,lt(i));break}}),window.addEventListener("pointermove",i=>{const t=y.get(i.pointerId);t&&(t.move(i.clientX,i.clientY,lt(i)),i.preventDefault())}),window.addEventListener("pointerup",ht),window.addEventListener("pointercancel",ht);function ht(i){const t=y.get(i.pointerId);t&&(y.delete(i.pointerId),t.lift())}function lt(i){return i.pointerType==="pen"?i.pressure:i.pointerType==="touch"?Math.abs(Math.max(i.width,i.height)-20)/130:1}function Et(i){return new Promise(t=>setTimeout(t,i*1e3))}
