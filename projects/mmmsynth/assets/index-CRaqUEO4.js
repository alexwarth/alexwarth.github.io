(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))e(r);new MutationObserver(r=>{for(const s of r)if(s.type==="childList")for(const o of s.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&e(o)}).observe(document,{childList:!0,subtree:!0});function t(r){const s={};return r.integrity&&(s.integrity=r.integrity),r.referrerPolicy&&(s.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?s.credentials="include":r.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function e(r){if(r.ep)return;r.ep=!0;const s=t(r);fetch(r.href,s)}})();const At=""+new URL("msynth-worklet-BUixxbfX.js",import.meta.url).href;function Xt(n,t,e){return new Uint8Array([144|n&15,t&127,e&127])}function Ot(n,t,e){return new Uint8Array([128|n&15,t&127,e&127])}const rt=48e3,w=2*Math.PI;function Tt(n){return 440*Math.pow(2,(n-69)/12)}function q(n,t,e){return Math.max(t,Math.min(n,e))}class g{constructor(t,e,r){this.name=t,this.code=e,this.options=r}}const ot=[new g("ddd",`
      preDistGain = paramA scale(0.1, 5)
      postDistGain = paramB * 10
      directSignalGain = (slide - 0.5) abs * 3
      feedbackGain = paramC scale(0, 0.9)
      feedbackDelay = 0.1 * paramD

      in = noteFreq saw * adsr(0.03, 0, 1, 0.1)

      nonLinearDist = (in * preDistGain + feedback) >> softClip
      feedback = nonLinearDist * feedbackGain >> delay(feedbackDelay)
      dry = nonLinearDist * postDistGain + in * directSignalGain

      out = dry // + 0.5 * dry delay(0.4)
    `,{octave:0,mode:"mpe",paramA:.5,paramB:.5,paramC:.5,paramD:.5}),new g("rebel yell",`
      ampEnv = adsr(0.03, 0, 1, 0.1)
      mod = paramA lglide(0.05) norm abs scale(0.45, 0.55)
      freq = noteFreq * (1 + (noise * paramB scale(0, 0.2))) //eglide(0.001))
      dry = freq pulse(mod) lpf(6000, 0.2) * ampEnv
      out = dry + 0.5 * dry delay(0.4)
    `,{octave:1,mode:"mpe",paramA:0,paramB:.1}),new g("hello again",`
      sync = 0.6
      osc1 = (noteFreq / 4) pulse
      osc2 = sync * 500 * ad(0.2, 0.5) >> pulse(0.5, osc1)
      out = osc2 * adsr(0.05, 0, 1, 0.2) >> dcBlock
    `,{octave:-1}),new g("duran duran",`
      decay = 0.102 escale(0.1, 2)
      delayAmt = 0.547
      detuneAmt = 0.252
      portamento = paramA
      freq = (paramB abs - 0.5) ifPos(noteFreq * 2, noteFreq)
      f1 = freq eglide(portamento)
      f2 = f1 * detuneAmt escale(1.01, 1.05)
      oscs = (f1 pulse + f2 pulse) / 2
      dry = oscs lpf12(4000, 0.7) * adsr(0, 0, 1, decay)
      out = dry + delayAmt * dry delay(0.378)
    `,{mono:!0,mode:"piano"}),new g("stranger things",`
      release = paramA
      resonance = (paramB norm - 0.5) abs scale(0.15, 1)
      pwmRate = 0.218
      osc1 = noteFreq pulse(pwmRate sine norm scale(0.2, 0.8))
      osc2 = (2 * noteFreq * 1.005) pulse(pwmRate sine norm scale(0.4, 0.6))
      out = (osc1 + osc2) lpf(10000 * adsr(0.001, 0, 1, 0.5), resonance) * adsr(0, 0, 1, release) >> dcBlock
    `,{octave:-2,paramA:.8,paramB:.5}),new g("tom sawyer",`
      resonance = paramA
      w = 0.5 + (1/5) sine norm scale(0, 0.4)
      detune1 = 0.091 * 0.01
      detune2 = 0.836 * 0.01
      delayAmt = paramB
      oscs =
        (
          (noteFreq * (1 - detune1)) pulse(w) +
          (noteFreq * (1 + detune1)) pulse(w) +
          (noteFreq * (1 - 3 * detune2)) pulse(w) +
          (noteFreq * (1 + 3 * detune2)) pulse(w)
        ) / 4
      filterEnv = adsr(0.05, 0, 1, 6) escale(0, 1)
      ampEnv = adsr(0, 0, 1, 12)
      dry = oscs lpf12(10000 * filterEnv, resonance) * ampEnv
      out = dry + delayAmt * dry delay(0.15) >> dcBlock
    `,{mode:"piano",octave:-2,paramA:.755,paramB:.127}),new g("guitar",`
      cutoff = paramA
      feedback = paramB scale(0.9, 0.999)
      burst  = noise * gate(0.005) * noteVel
      filter = (burst + filter) delay(1 / noteFreq) lpf12(20000 * cutoff, 0) * feedback
      out = burst + filter * adsr(0, 0, 1, 0.1)
    `,{paramA:1,paramB:.99,octave:-1,mode:"strum"}),new g("dist guitar",`
      distQ = paramA
      distCutoff = 20000 * paramB // escale(100, 20000) // * 0.5 sine norm scale(0.4, 0.6)
      drive = paramC scale(1, 50)

      drive = paramD * 10
      distCutoff = paramB * 20000

      cutoff = 1
      feedback = 0.99 scale(0.9, 0.999)
      burst  = noise * gate(0.005)
      filter = (burst + filter) delay(1 / noteFreq) lpf12(20000 * cutoff, 0) * feedback
      guitar = burst + filter * adsr(0, 0, 1, 0.1)

      d1 = guitar dist(drive) lpf(distCutoff)
      d1f = d1 + out delay(0.01) * 0.5
      d2 = d1f dcBlock * 0.5 >> dist(drive)
      // d3 = d2 hpf(300) lpf(800, 1)
      // d4 = d3 lpf(5000)
      out = d2

      // out = (guitar + 0.1) lpf(distCutoff, distQ) dist(drive) lpf(5000, 0.5) dcBlock
    `,{paramA:.2,paramB:1,octave:-1,mode:"mpe"}),new g("12 string",`
      cutoff = paramA
      feedback = paramB scale(0.9, 0.999)
      burst  = noise * gate(0.005) * noteVel
      string1 = (burst + string1) delay(1 / noteFreq) lpf12(20000 * cutoff, 0) * feedback
      string2 = (burst + string2) delay(1 / (noteFreq * 2)) lpf12(20000 * cutoff, 0) * feedback
      out = burst + (string1 + string2) * adsr(0, 0, 1, 0.1)
    `,{paramA:1,paramB:.99,octave:-1,mode:"strum"}),new g("strum bass",`
      out = noteFreq sine * ad(0.01, 5) * adsr(0, 0, 1, 0.1)
    `,{paramA:.2,paramB:1,octave:-2,mode:"strum"}),new g("rick and morty",`
      sound1 = noise bpf(0.2 sine * 800 + 1200, 1)
      sound2 = noise bpf(-(0.25 sine) * 800 + 1200, 1)
      ring = (sound1 + sound1 delay(2) + sound2) * 5.5 pulse norm * 0.5
      out = ring * adsr(0.01, 0, 1, 2)
    `),new g("pwm",`
      out = noteFreq pulse(slide lglide(0.05) norm scale(0.2, 0.8)) * adsr(0.05, 0, 1, 0.4)
    `),new g("pwm pencil",`
      out = noteFreq pulse(slide lglide(0.05) norm scale(0.2, 0.8)) * adsr(0.05, 0, 1, 0.4) * pressure
    `),new g("sine",`
      out = noteFreq sine * adsr(0.01, 0, 1, 0.3)
    `)],Dt=document.getElementById("ui"),S=document.createElement("canvas"),i=S.getContext("2d");Dt.appendChild(S);const v=2,at="#ccc",M="#ddd",k="#888",Yt="#888",qt="#aab",_="#bbd",X="#dde",A="#88c",St="#88c";let c=0,m=0;const Mt="14px Inter",Ct="#bbb",Ft="#eee";let H=0,L=0;const Bt=18,Gt=`500 ${Bt}px Inter`,W="500 16px Inter",b=30,$=10,U=150,F=5,N=11;function ht(){S.style.width=innerWidth+"px",S.style.height=innerHeight+"px",S.width=innerWidth*devicePixelRatio,S.height=innerHeight*devicePixelRatio,i.scale(devicePixelRatio,devicePixelRatio),c=(innerWidth-2*v)/13,m=(innerHeight-2*v)/8,H=c*1.5,L=m/1.5}window.addEventListener("resize",ht),ht();const Vt=8,Lt=2e3;let B="",lt=0;function z(n){B=n,lt=Date.now()}z("tap one of the oscilloscopes");class Wt{constructor(t,e){this.synth=t,this.channel=e,this.params=new Float32Array(new SharedArrayBuffer(512)),this.note=-1}noteOn(t,e){this.isOn&&this.noteOff(this.note,127),this.note=t,this.synth.sendToWorklet({command:"process midi message",data:Xt(this.channel,t,e)})}noteOff(t,e){this.note=-1,this.synth.sendToWorklet({command:"process midi message",data:Ot(this.channel,t,e)})}get isOn(){return this.note!==-1}get freq(){return Tt(this.note)*Math.pow(2,this.params[0]/12)}set glide(t){this.params[0]=t}get glide(){return this.params[0]}set slide(t){this.params[1]=t}get slide(){return this.params[1]}set pressure(t){this.params[2]=t}get pressure(){return this.params[2]}set paramA(t){this.params[3]=t}get paramA(){return this.params[3]}set paramB(t){this.params[4]=t}get paramB(){return this.params[4]}set paramC(t){this.params[5]=t}get paramC(){return this.params[5]}set paramD(t){this.params[6]=t}get paramD(){return this.params[6]}set gain(t){this.params[7]=t}get gain(){return this.params[7]}}class dt{constructor(t="pwm"){if(this.mode="mpe",this.worklet=null,this.voices=[],this.octave=0,this.analyzer=null,this.timeDomainData=null,this.lnf=220,this.patch=ot.find(e=>e.name===t),!this.patch)throw new Error("unknown patch name! "+t);for(let e=0;e<Vt;e++)this.voices.push(new Wt(this,e))}init(){this.worklet=new AudioWorkletNode(D,"msynth"),this.sendToWorklet({command:"init",voiceParams:this.voices.map(e=>e.params.buffer)}),this.analyzer=D.createAnalyser(),this.analyzer.fftSize=32768;const t=this.analyzer.frequencyBinCount;this.timeDomainData=new Uint8Array(t),this.worklet.channelInterpretation="discrete",this.worklet.channelCount=2,this.worklet.channelCountMode="explicit",this.worklet.connect(this.analyzer).connect(D.destination),this.worklet.port.onmessage=e=>ee(e.data),this.loadPatch(this.patch)}getTimeDomainData(){return!this.analyzer||!this.timeDomainData?null:(this.analyzer.getByteTimeDomainData(this.timeDomainData),this.timeDomainData)}sendToWorklet(t){var e;(e=this.worklet)==null||e.port.postMessage(t)}loadPatch(t){var e,r,s,o,a,d,h;this.patch=t,this.sendToWorklet({command:"load patch",code:t.code,mono:((e=t.options)==null?void 0:e.mono)??!1}),this.setParam(3,((r=t.options)==null?void 0:r.paramA)??0),this.setParam(4,((s=t.options)==null?void 0:s.paramB)??0),this.setParam(5,((o=t.options)==null?void 0:o.paramC)??0),this.setParam(6,((a=t.options)==null?void 0:a.paramD)??0),this.setParam(7,.2),this.octave=((d=t.options)==null?void 0:d.octave)??0,this.mode=((h=t.options)==null?void 0:h.mode)??"mpe"}grabVoice(){var r;if((r=this.patch.options)!=null&&r.mono)return this.voices.find(s=>s.channel===0);const t=[...P.values()],e=this.voices.findLast(s=>!t.some(o=>o.voice===s))??this.voices.at(-1);return this.voices.splice(this.voices.indexOf(e),1),this.voices.unshift(e),e}setParam(t,e){for(const r of this.voices)r.params[t]=e}getLowestNoteFreq(){let t=1/0;for(const e of this.voices)e.isOn&&e.freq<t&&(t=e.freq);return Number.isFinite(t)&&(this.lnf=t),this.lnf}controls(t){const e=new et(t,"top","left",ot,()=>this.patch,h=>{this.loadPatch(h)},h=>h.name,()=>l===this),r=new et(t,"top","right",["mpe","string","piano","strum"],()=>this.mode,h=>{this.mode=h},h=>h,()=>l===this),s=new et(t,"bottom","right",[2,1,0,-1,-2],()=>this.octave,h=>{this.octave=h},h=>"octave "+(h>0?"+":"")+h,()=>l===this,!0),o=new ft(this,3,4,"(a,b)",()=>t.rightX),a=new ft(this,5,6,"(c,d)",o),d=new Qt(this,7,"vol",a);return[e,r,s,o,a,d]}}const Q=new dt("ddd"),p=new dt("stranger things");let l=Q;const Ut=47,Nt=5,O=5;class zt{constructor(t,e,r){this.col=t,this.row=e,this.noteName=r,this.isBeingPlayedBySequencer=!1}get note(){return Ut+12*l.octave+Nt*(7-this.row)+this.col}get x(){return v+this.col*c}get y(){return v+this.row*m}get rightX(){return this.x+c}get bottomY(){return this.y+m}get centerX(){return this.x+c/2}get centerY(){return this.y+m/2}contains(t,e){return this.x<=t&&t<=this.rightX&&this.y<=e&&e<=this.bottomY}render(){if(i.beginPath(),i.lineWidth=3,i.strokeStyle="#efefef",i.roundRect(this.x,this.y,c,m,O),i.stroke(),l.mode==="strum"&&this.col>=N){i.beginPath(),i.fillStyle=qt,i.roundRect(this.x,this.y,c,m,O),i.fill();return}i.beginPath(),i.fillStyle=this.noteName===""?_:X,i.roundRect(this.x,this.y,c,m,O),i.fill(),l===p&&this.isBeingPlayedBySequencer&&(i.beginPath(),i.fillStyle=this.noteName===""?Ft:Ct,i.roundRect(this.x+20,this.y+20,c-40,m-40,O),i.fill()),this.noteName!==""&&(i.globalAlpha=.5,i.beginPath(),i.font=Mt,i.fillStyle=A,i.fillText(this.noteName,this.x+4,this.y+16),i.fill(),i.globalAlpha=1)}}const ct=13,u=[],Et=["C","","D","","E","F","","G","","A","","B"];let pt=0;for(let n=2;n<=7;n++){for(let t=0;t<ct;t++)u.push(new zt(t,n,Et[(pt+t)%12]));pt+=7}const P=new Map;class Rt{constructor(){this.windowMs=150,this.history=[]}addPos(t){this.history.push({pos:t,t:performance.now()})}get speed(){const t=performance.now();if(this.history=this.history.filter(({t:s})=>t-s<=this.windowMs),this.history.length<2)return 0;let e=0;for(let s=1;s<this.history.length;s++)e+=Math.abs(this.history[s].pos-this.history[s-1].pos);const r=this.history[this.history.length-1].t-this.history[0].t;return e/r}}class C{constructor(t,e,r,s,o){this.id=t,this.x0=e,this.y0=r,this.pressure=s,this.synth=o,this.quantizationOffset=0,this.voice=null,this.pad=null,this.speedTracker=new Rt,this.lastT=0,this.x=e,this.y=r,P.set(t,this),this.move(e,r,s)}static add(t,e,r,s,o=l){switch(o.mode){case"piano":return new It(t,e,r,s,o);case"mpe":return new ut(t,e,r,s,o);case"string":return new J(t,e,r,s,o);case"strum":{const a=u.find(d=>d.contains(e,r));return a&&a.col>=N?new $t(t,e,r,s,o):new Z(t,e,r,s,o)}default:throw new Error("unknown mode! "+o.mode)}}static updateQuantizationOffsets(){for(const t of P.values())(t instanceof ut||t instanceof J)&&t.updateQuantizationOffset()}updateQuantizationOffset(){const t=u.find(o=>{var a;return o.row===((a=this.pad)==null?void 0:a.row)&&o.contains(this.x,this.y)});if(this.speedTracker.speed>.025||!this.pad||!t){this.lastT=performance.now();return}const e=performance.now(),r=.005*(e-this.lastT),s=(t.centerX-this.x)/c;this.quantizationOffset=r*s+(1-r)*this.quantizationOffset,this.updateGlide(),this.lastT=e}updateGlide(){this.voice.glide=(this.x-this.pad.centerX)/c+this.quantizationOffset}}class It extends C{move(t,e,r){const s=u.find(a=>a.contains(t,e))??this.pad,o=s!==this.pad;this.pad&&o&&(this.voice.noteOff(this.pad.note,127),this.voice=null),s&&o&&(this.voice=this.synth.grabVoice()),this.pad=s,this.pad&&(this.voice.glide=0,this.voice.slide=q((this.pad.centerY-e)/(m/2),-1,1),this.voice.pressure=r,o&&this.voice.noteOn(this.pad.note,127))}lift(){var t;(t=this.voice)==null||t.noteOff(this.pad.note,127)}render(){tt(this.pad,this.voice)}}class ut extends C{move(t,e,r){this.x=t,this.y=e,this.speedTracker.addPos(t);const s=u.find(a=>{var d;return a.row!==((d=this.pad)==null?void 0:d.row)&&a.contains(t,e)})??this.pad,o=s!==this.pad;this.pad&&o&&(this.voice.noteOff(this.pad.note,127),this.voice=null),s&&o&&(this.voice=this.synth.grabVoice(),this.quantizationOffset=(s.centerX-t)/c),this.pad=s,this.pad&&(this.updateGlide(),this.voice.slide=q((this.pad.centerY-e)/(m/2),-1,1),this.voice.pressure=r,o&&this.voice.noteOn(this.pad.note,127))}lift(){var t;(t=this.voice)==null||t.noteOff(this.pad.note,127)}render(){tt(this.pad,this.voice)}}class J extends C{constructor(){super(...arguments),this.pressure=0}move(t,e,r){this.x=t,this.y=e,this.pressure=r,this.speedTracker.addPos(t);const s=u.find(d=>{var h;return d.row!==((h=this.pad)==null?void 0:h.row)&&d.contains(t,e)}),o=s?E(s.row):this.pad,a=o!==this.pad;if(this.pad&&a){const d=this.pad.row;this.pad=null,this.updateRow(d),this.voice=null}o&&a&&(this.voice=this.synth.voices[o.row],this.quantizationOffset=(s.centerX-t)/c),this.pad=o,this.pad&&this.updateRow(this.pad.row)}updateRow(t){const e=this.synth.voices[t],r=E(t),s=this.getHighestFinger(t);s?(s.updateParams(),e.isOn||e.noteOn(r.note,127)):e.noteOff(r.note,127)}getHighestFinger(t){var r;let e=null;for(const s of P.values())!(s instanceof J)||((r=s.pad)==null?void 0:r.row)!==t||(!e||s.x>e.x)&&(e=s);return e}updateParams(){if(!this.pad||!this.voice)throw new Error("invariant violated!!!");this===this.getHighestFinger(this.pad.row)&&(this.updateGlide(),this.voice.slide=q((this.pad.centerY-this.y)/(m/2),-1,1),this.voice.pressure=this.pressure)}updateGlide(){this.pad&&this===this.getHighestFinger(this.pad.row)&&super.updateGlide()}lift(){this.pad&&this.updateRow(this.pad.row)}render(){tt(this.pad,this.voice)}}function E(n){return u.find(t=>t.row===n&&t.col===0)}const Ht=.5;class Z extends C{constructor(){super(...arguments),this.pressure=0}move(t,e,r){this.pad||(this.pad=u.find(s=>s.col<12&&s.contains(t,e))??null),this.x=t,this.y=e,this.pressure=r,this.updateGlide()}updateGlide(){var t;this.pad&&((t=this.getHighestFinger(this.pad.row))==null||t._updateGlide())}_updateGlide(){const{row:t}=this.pad,e=E(t),r=Math.abs(this.y-this.y0)/m*Ht,s=this.synth.voices[t],o=this.getNearestFret();s.glide=o.note+r-e.note}getHighestFinger(t){var r;let e=null;for(const s of P.values())!(s instanceof Z)||((r=s.pad)==null?void 0:r.row)!==t||(!e||s.x>e.x)&&(e=s);return e}getNearestFret(){let t=this.pad,e=Math.abs(t.centerX-this.x);for(const r of u){if(r.row!==this.pad.row||r.col>=N)continue;const s=Math.abs(r.centerX-this.x);s<e&&(t=r,e=s)}return t}lift(){if(this.updateGlide(),this.pad&&!this.getHighestFinger(this.pad.row)){const t=this.synth.voices[this.pad.row],e=E(this.pad.row);t.noteOff(e.note,127)}}render(){if(!this.pad)return;const t=this.getNearestFret(),e=t.centerX,r=this.y-this.y0+t.centerY,s="rgba(100, 100, 100, 0.5)";i.beginPath(),i.fillStyle=s,i.arc(e,r,c/3,0,Math.PI*2),i.fill();for(let o of u){if(o.col!==0||o.row===t.row)continue;const a=t.note-o.note;if(a<0||a>=N)continue;const d=o.centerX+a*c,h=r+o.y-t.y;i.beginPath(),i.strokeStyle=s,i.arc(d,h,c/3,0,Math.PI*2),i.stroke()}}}class $t extends C{constructor(){super(...arguments),this.velocity=1,this.maxVelocity=0}move(t,e,r){const s=performance.now(),o=ct-N;this.x=innerWidth-v-o*c/2,this.y=e,this.prev===void 0?(this.prev={t:performance.now(),y:e},this.velocity=this.maxVelocity=.5):this.velocity=Math.min(15*Math.abs(e-this.prev.y)/(s-this.prev.t)/m,1),this.maxVelocity=Math.max(this.velocity,this.maxVelocity),this.prev.t=s,this.prev.y=e;const a=this.pad;if(this.pad=u.find(V=>V.col===12&&V.contains(this.x,this.y))??null,this.pad===a||!this.pad)return;const{row:d,note:h}=E(this.pad.row),Y=l.voices[d],y=[...P.values()].find(V=>{var nt;return V instanceof Z&&((nt=V.pad)==null?void 0:nt.row)===d});y&&(y.updateGlide(),Y.noteOn(h,127*this.velocity))}lift(){}render(){const t="rgba(100, 100, 100, 0.5)";i.beginPath(),i.fillStyle=t,i.arc(this.x,this.y,c/3,0,Math.PI*2),i.fill()}}function tt(n,t){if(!(!n||!t))for(let e of u){if(e.col!==0)continue;const r=e.centerX+(n.note-e.note+t.glide)*c,s=e.centerY-t.slide*(m/2),o=`rgba(100, 100, 100, ${t.pressure})`;e.row===n.row&&(i.beginPath(),i.arc(r,s,c/4,0,Math.PI*2),i.fillStyle=o,i.fill());for(let a=0;a<4;a++){i.beginPath(),i.strokeStyle=o;const d=(performance.now()/2e3+a/4)*w;i.arc(r,s,c/3,d,d+w/8),i.stroke()}}}class f{constructor(t){this.thingAbove=t,this.pointer=null}get x(){if(this.thingAbove)return this.thingAbove.x;throw new Error("must override x if no thingAbove")}get centerX(){return this.x+this.w/2}get rightX(){return this.x+this.w}get y(){if(this.thingAbove)return this.thingAbove.bottomY;throw new Error("must override y if no thingAbove")}get centerY(){return this.y+this.h/2}get bottomY(){return this.y+this.h}get w(){var t;return((t=this.thingAbove)==null?void 0:t.w)??H}get h(){var t;return((t=this.thingAbove)==null?void 0:t.h)??L}contains(t,e){return this.x<=t&&t<=this.rightX&&this.y<=e&&e<=this.bottomY}get backgroundColor(){return this.pointer?"#ccc":"#ddd"}get foregroundColor(){return k}render(t){i.beginPath(),i.lineWidth=3,i.strokeStyle="#eee",i.roundRect(this.x,this.y,this.w,this.h,O),i.stroke(),i.beginPath(),i.fillStyle=this.backgroundColor,i.roundRect(this.x,this.y,this.w,this.h,O),i.fill(),t&&this.renderLabel(t)}renderOnTop(){}renderLabel(t){i.beginPath(),i.font=Gt,i.fillStyle=this.foregroundColor,i.fillText(t,this.x+(this.w-i.measureText(t).width)/2,this.y+this.h/2),i.fill()}onPointerDown(t,e){}onPointerMove(t,e){}onPointerUp(t,e){}}class ft extends f{constructor(t,e,r,s,o){super(o instanceof f?o:void 0),this.synth=t,this.xParamNum=e,this.yParamNum=r,this.name=s,this.thingAboveOrGetX=o,this.radius=8,this.pos0=null,this.value0=null}get x(){return this.thingAboveOrGetX instanceof f?super.x:this.thingAboveOrGetX()}get y(){return this.thingAboveOrGetX instanceof f?super.y:v}get w(){return H*2/3}get h(){return L}get foregroundColor(){return l===this.synth?A:k}get backgroundColor(){return l===this.synth?X:M}render(){super.render(),i.globalAlpha=.2,i.fillStyle=l===this.synth?_:at,i.beginPath(),i.arc(this.x+this.radius+this.xValue*(this.w-2*this.radius),this.bottomY-this.radius-this.yValue*(this.h-2*this.radius),this.radius,0,w),i.fill(),i.globalAlpha=1,i.beginPath(),i.arc(this.x+this.radius+this.xValue*(this.w-2*this.radius),this.bottomY-this.radius-this.yValue*(this.h-2*this.radius),this.radius/2,0,w),i.fill(),i.font=W,i.fillStyle=l===this.synth?A:k,i.beginPath(),i.fillText(this.name,this.centerX-i.measureText(this.name).width/2,this.centerY+b/2-$),i.fill()}get xValue(){var t,e;return((e=(t=this.synth)==null?void 0:t.voices[0])==null?void 0:e.params[this.xParamNum])??0}set xValue(t){this.synth.setParam(this.xParamNum,t)}get yValue(){var t,e;return((e=(t=this.synth)==null?void 0:t.voices[0])==null?void 0:e.params[this.yParamNum])??0}set yValue(t){this.synth.setParam(this.yParamNum,t)}onPointerDown(t,e){this.pos0={x:t,y:e},this.value0={x:this.xValue,y:this.yValue}}onPointerMove(t,e){const r=q(this.value0.x+(t-this.pos0.x)/(this.w-this.radius*2),0,1),s=q(this.value0.y-(e-this.pos0.y)/(this.h-this.radius*2),0,1);this.xValue=r,this.yValue=s,z(`${this.name} = (${r.toFixed(3)}, ${s.toFixed(3)})`)}}class Qt extends f{constructor(t,e,r,s){super(s instanceof f?s:void 0),this.synth=t,this.paramNum=e,this.name=r,this.thingAboveOrGetX=s,this.value0=null,this.prevAngle=null}get x(){return this.thingAboveOrGetX instanceof f?super.x:this.thingAboveOrGetX()}get y(){return this.thingAboveOrGetX instanceof f?super.y:v}get w(){return H*2/3}get h(){return L}get foregroundColor(){return l===this.synth?A:k}get backgroundColor(){return l===this.synth?X:M}render(){super.render();const t=.3*Math.min(this.w,this.h);i.globalAlpha=.2,i.beginPath(),i.fillStyle=l===this.synth?_:at,i.arc(this.centerX,this.centerY,t,0,w),i.lineTo(this.centerX,this.centerY),i.fill(),i.globalAlpha=1,i.beginPath(),i.arc(this.centerX,this.centerY,t,w/4,w*this.value+w/4),i.lineTo(this.centerX,this.centerY),i.fill(),i.beginPath(),i.fillStyle=l===this.synth?X:M,i.arc(this.centerX,this.centerY,t-5,0,w),i.lineTo(this.centerX,this.centerY),i.fill(),i.font=W,i.fillStyle=l===this.synth?A:k,i.beginPath(),i.fillText(this.name,this.centerX-i.measureText(this.name).width/2,this.centerY+b/2-$),i.fill()}get value(){var t,e;return((e=(t=this.synth)==null?void 0:t.voices[0])==null?void 0:e.params[this.paramNum])??0}set value(t){this.synth.setParam(this.paramNum,t)}onPointerDown(t,e){this.value0=this.value,this.prevAngle=Math.atan2(e-this.centerY,t-this.centerX)}onPointerMove(t,e){const r=Math.atan2(e-this.centerY,t-this.centerX),s=((r-this.prevAngle+Math.PI)%w+w)%w-Math.PI;this.value=q(this.value+s/w,0,1),this.prevAngle=r}}class jt extends f{constructor(t,e,r,s,o,a=!1){super(t instanceof f?t:void 0),this.thingAboveOrGetX=t,this.options=e,this.getValue=r,this.setValue=s,this.valueToString=o,this.placeCurrentValueAtY0=a,this.popUpWidth=0,this.popUpHeight=0,this.popUpX=0,this.popUpY=0,this.optionX=0,this.optionY0=0,this.maxLabelWidth=0,this.optionLabels=e.map(o),a||this.optionLabels.unshift("")}get x(){return this.thingAboveOrGetX instanceof f?super.x:this.thingAboveOrGetX()}get y(){return this.thingAboveOrGetX instanceof f?super.y:v}onPointerDown(t,e){this.pointerPos={initial:{x:t,y:e},current:{x:t,y:e}},i.font=W,this.maxLabelWidth=this.optionLabels.map(s=>i.measureText(s).width).reduce((s,o)=>Math.max(s,o)),this.popUpWidth=1.125*U+this.maxLabelWidth,this.popUpHeight=(this.optionLabels.length+.5)*b;const r=this.pointerPos.initial.x<innerWidth/2;this.popUpX=r?this.pointerPos.initial.x-U/2:this.pointerPos.initial.x-this.popUpWidth+U/2,this.popUpY=this.pointerPos.initial.y-b,this.placeCurrentValueAtY0&&(this.popUpY-=b*this.options.indexOf(this.getValue())),this.optionX=this.popUpX+(r?U:.125*U),this.optionY0=this.popUpY+(this.placeCurrentValueAtY0?0:b),this.onPointerMove(t,e)}onPointerMove(t,e){this.pointerPos.current.x=t,this.pointerPos.current.y=e;const r=this.popUpY+(this.placeCurrentValueAtY0?1:2)*b,s=Math.round((e-r)/b);if(s<0)return;const o=this.options[Math.min(s,this.options.length-1)];o!==this.getValue()&&this.setValue(o)}onPointerUp(t,e){this.pointerPos=void 0}render(){super.render(this.valueToString(this.getValue()))}renderOnTop(){if(!this.pointerPos)return;i.fillStyle="rgba(255, 255, 255, 0.5)",i.filter="drop-shadow(5px 5px 5px)",i.beginPath(),i.roundRect(this.popUpX,this.popUpY,this.popUpWidth,this.popUpHeight,O),i.fill(),i.filter="none",i.filter="blur(10px)",i.fillStyle="rgba(255, 255, 255, 0.8)",i.beginPath(),i.roundRect(this.popUpX,this.popUpY,this.popUpWidth,this.popUpHeight,O),i.fill(),i.filter="none";let t=this.optionY0;for(const e of this.options)t+=b,this.renderOption(this.valueToString(e),this.getValue()===e,this.optionX,t)}renderOption(t,e,r,s){i.font=W,e&&(i.filter="blur(10px)",i.beginPath(),i.fillStyle=X,i.roundRect(r-F,s-b+$,this.maxLabelWidth+2*F,b,O*2),i.fill(),i.filter="none"),i.beginPath(),i.fillStyle=e?"#333":"#999",i.fillText(t,r,s),i.fill()}}class et extends jt{constructor(t,e,r,s,o,a,d,h,Y=!1){super(()=>0,s,o,a,d,Y),this.parent=t,this.vPlacement=e,this.hPlacement=r,this.isActive=h}get x(){return this.hPlacement==="left"?this.parent.x+F:this.parent.rightX-this.w-F}get y(){return this.vPlacement==="top"?this.parent.y+F:this.parent.bottomY-this.h-F+$}get w(){return i.font=W,i.measureText(this.valueToPaddedString(this.getValue())).width}get h(){return b}render(){this.renderLabel(this.valueToPaddedString(this.getValue()))}valueToPaddedString(t){return this.hPlacement==="left"?this.valueToString(t)+"    ":"    "+this.valueToString(t)}get foregroundColor(){return this.isActive()?A:k}}const I=class I extends f{constructor(t){super(),this.synth=t}get y(){return v}get w(){return c*4}get h(){return L*3}onPointerDown(t,e){l=this.synth}render(){super.render();const t=this.synth.getTimeDomainData();if(!t)return;const e=this.synth.getLowestNoteFreq(),r=rt/e,s=Math.round(r*2);let o=0;for(let y=0;y<t.length-1;y++)if(t[y]<=128&&t[y+1]>128){o=y;break}i.beginPath();const a=Math.min(s,t.length-o),d=this.w/a;let h=this.x,Y=0;for(let y=o;y<a;y++)Y=t[y]/128*this.h/2,y===o?i.moveTo(h,Y):i.lineTo(h,Y),h+=d;i.lineWidth=1,i.strokeStyle=l===this.synth?St:Yt,i.stroke()}get foregroundColor(){return l===this.synth?A:k}get backgroundColor(){return l===this.synth?X:M}};I.gradient=i.createLinearGradient(0,0,0,S.height),I.gradient.addColorStop(0,"rgba(0, 255, 255, 0.8)"),I.gradient.addColorStop(1,"rgba(0, 0, 128, 0.2)");let j=I;const mt=new class extends j{get x(){return v}}(Q),gt=Q.controls(mt),yt=new class extends j{get x(){return gt.at(-1).rightX}}(p),Kt=p.controls(yt);let K=120;const wt=new class extends f{constructor(){super(...arguments),this.tempo0=null}get x(){return innerWidth-v-this.w}get y(){return v}get w(){return c*3}render(){super.render(`tempo ${K}`)}onPointerDown(n,t){this.tempo0=K}onPointerMove(n,t){const e=t-this.pointer.y0;K=q(Math.round(this.tempo0-e/10),10,200),p.sendToWorklet({command:"set tempo",value:K})}get foregroundColor(){return l===p?A:k}get backgroundColor(){return l===p?X:M}};let x=[],T,it=0;const vt=new class extends f{render(){super.render(T==="playing"?`step ${it+1} / ${x.length}`:x.length===0?"record steps":`${x.length} steps`)}onPointerDown(){st(),x=[],T="recording"}onPointerUp(){p.sendToWorklet({command:"load steps",steps:x}),x.length>0?bt():st()}get foregroundColor(){return l===p?A:k}get backgroundColor(){return l===p?X:M}}(wt),Jt=new class extends f{render(){super.render(T==="recording"?"add rest":T==="playing"?"stop":"play")}onPointerDown(){T==="recording"?x.push([]):T==="playing"?st():bt()}get foregroundColor(){return l===p?A:k}get backgroundColor(){return l===p?X:M}}(vt);function bt(){x.length!==0&&(p.setParam(0,0),T="playing",it=0,p.sendToWorklet({command:"start sequencer"}))}function st(){T="stopped",p.sendToWorklet({command:"stop sequencer"});for(const n of u)n.isBeingPlayedBySequencer=!1}const Zt=[wt,vt,Jt],G=[mt,...gt,yt,...Kt,...Zt];window.addEventListener("pointerdown",n=>{for(let t=G.length-1;t>=0;t--){const e=G[t];if(e.contains(n.clientX,n.clientY)){e.onPointerDown(n.clientX,n.clientY),e.pointer={id:n.pointerId,x0:n.clientX,y0:n.clientY},n.preventDefault();break}}}),window.addEventListener("pointermove",n=>{var t;for(const e of G)if(((t=e.pointer)==null?void 0:t.id)===n.pointerId){e.onPointerMove(n.clientX,n.clientY),n.preventDefault();break}}),window.addEventListener("pointerup",n=>{var t;for(const e of G)if(((t=e.pointer)==null?void 0:t.id)===n.pointerId){e.onPointerUp(n.clientX,n.clientY),e.pointer=null,n.preventDefault();break}});function xt(){i.clearRect(0,0,innerWidth,innerHeight);for(const n of G)n.render();for(const n of u)n.render();for(const n of P.values())n.render();for(const n of G)n.renderOnTop();if(B.length>0&&Date.now()-lt<Lt){i.font="16px Inter";const{width:n}=i.measureText(B);i.beginPath(),i.fillStyle="#00ff",i.fillText(B,innerWidth-n-20,innerHeight-20),i.fill()}C.updateQuantizationOffsets(),requestAnimationFrame(xt)}xt();const D=new AudioContext({latencyHint:"balanced",sampleRate:rt});let R="need initialization";function _t(){return R==="ready"?!0:(R==="need initialization"&&te(),!1)}async function te(){R==="need initialization"&&(R="initializing",B="initializing audio...",D.resume(),B="loading worklet...",await D.audioWorklet.addModule(At),Q.init(),p.init(),p.sendToWorklet({command:"load steps",steps:x}),R="ready",z("ready!"))}function ee(n){switch(n.event){case"seq step":{n.action==="noteOn"&&(it=n.index);for(const t of x[n.index]||[])for(const e of u)e.note===t&&(e.isBeingPlayedBySequencer=n.action==="noteOn");break}case"log":{z(n.message);break}default:z("??? "+JSON.stringify(n));break}}window.addEventListener("pointerdown",()=>{(D.state==="suspended"||D.state==="interrupted")&&D.resume()}),window.addEventListener("pointerdown",async n=>{if(!_t())return;const t=[...P.values()].some(e=>!!e.pad);for(const e of u)if(e.contains(n.clientX,n.clientY)){T==="recording"&&l===p&&(t||x.push([]),x.at(-1).push(e.note)),C.add(n.pointerId,n.clientX,n.clientY,kt(n));break}}),window.addEventListener("pointermove",n=>{const t=P.get(n.pointerId);t&&(t.move(n.clientX,n.clientY,kt(n)),n.preventDefault())}),window.addEventListener("pointerup",Pt),window.addEventListener("pointercancel",Pt);function Pt(n){const t=P.get(n.pointerId);t&&(P.delete(n.pointerId),t.lift())}function kt(n){return n.pointerType==="pen"?n.pressure:n.pointerType==="touch"?Math.abs(Math.max(n.width,n.height)-20)/130:1}
