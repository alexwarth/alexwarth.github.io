(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))t(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const r of o.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&t(r)}).observe(document,{childList:!0,subtree:!0});function e(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function t(i){if(i.ep)return;i.ep=!0;const o=e(i);fetch(i.href,o)}})();const re=""+new URL("msynth-worklet-CnkM3A_-.js",import.meta.url).href;function ae(n,e,t){return new Uint8Array([144|n&15,e&127,t&127])}function he(n,e,t){return new Uint8Array([128|n&15,e&127,t&127])}const C=96e3;function de(n){return 440*Math.pow(2,(n-69)/12)}function D(n,e,t){return Math.max(e,Math.min(n,t))}const le=document.getElementById("ui"),M=document.createElement("canvas"),s=M.getContext("2d");le.appendChild(M);const p=2;let h=0,m=0,B=0,F=0,ce="18px sans-serif";function I(){M.style.width=innerWidth+"px",M.style.height=innerHeight+"px",M.width=innerWidth*devicePixelRatio,M.height=innerHeight*devicePixelRatio,s.scale(devicePixelRatio,devicePixelRatio),h=(innerWidth-2*p)/13,m=(innerHeight-2*p)/8,B=h*1.5,F=m/1.5}window.addEventListener("resize",I),I();const pe=8;let k="tap here";class f{constructor(e,t,i){this.name=e,this.code=t,this.options=i}}const O=[new f("rebel yell",`
      ampEnv = adsr(0.03, 0, 1, 0.1)
      mod = param3 lglide(0.05) norm abs scale(0.45, 0.55)
      dry = noteFreq pwm(mod) lpf(6000, 0.2) * ampEnv
      out = dry + 0.5 * dry delay(0.4)
    `,{octave:1}),new f("hello again",`
      sync = 0.6
      osc1 = (noteFreq / 4) pwm
      osc2 = sync * 500 * ad(0.2, 0.5) >> pwm(0.5, osc1)
      out = osc2 * adsr(0.05, 0, 1, 0.2)
    `,{octave:-1}),new f("duran duran",`
      decay = 0.102
      delayAmt = 0.547
      detuneAmt = 0.252
      portamento = paramA
      freq = (paramB abs - 0.5) ifPos(noteFreq * 2, noteFreq)
      f1 = freq eglide(portamento)
      f2 = f1 * detuneAmt escale(1.01, 1.05)
      oscs = (f1 pwm + f2 pwm) / 2
      dry = oscs * adsr(0, 0, 1, decay escale(0.1, 2))
      out = dry + delayAmt * dry delay(0.378)
    `,{mono:!0,mode:"piano"}),new f("stranger things",`
      release = paramA
      resonance = (paramB norm - 0.5) abs scale(0.15, 1)
      pwmRate = 0.218
      osc1 = noteFreq pwm(pwmRate sine norm scale(0.2, 0.8))
      osc2 = (2 * noteFreq * 1.005) pwm(pwmRate sine norm scale(0.4, 0.6))
      out = (osc1 + osc2) lpf(10000 * adsr(0.001, 0, 1, 0.5), resonance) * adsr(0, 0, 1, release)
    `,{octave:-2,paramA:.8,paramB:.5}),new f("tom sawyer",`
      resonance = paramA
      w = 0.5 + (1/5) sine norm scale(0, 0.4)
      detune1 = 0.091 * 0.01
      detune2 = 0.836 * 0.01
      delayAmt = paramB
      oscs =
        (
          (noteFreq * (1 - detune1)) pwm(w) +
          (noteFreq * (1 + detune1)) pwm(w) +
          (noteFreq * (1 - 3 * detune2)) pwm(w) +
          (noteFreq * (1 + 3 * detune2)) pwm(w)
        ) / 4
      filterEnv = adsr(0.05, 0, 1, 6) escale(0, 1)
      ampEnv = adsr(0, 0, 1, 12)
      dry = oscs lpf12(10000 * filterEnv, resonance) * ampEnv
      out = dry + delayAmt * dry delay(0.15) >> dcBlock
    `,{mode:"piano",octave:-2,paramA:.755,paramB:.127}),new f("guitar",`
      cutoff = paramA
      feedback = paramB scale(0.9, 0.999)
      burst  = noise * gate(0.005)
      filter = (burst + filter) delay(1 / noteFreq) lpf12(20000 * cutoff, 0) * feedback
      out = burst + filter * adsr(0, 0, 1, 0.1)
    `,{paramA:1,paramB:.99,octave:-1,mode:"strum"}),new f("12 string",`
      cutoff = paramA
      feedback = paramB scale(0.9, 0.999)
      burst  = noise * gate(0.005)
      string1 = (burst + string1) delay(1 / noteFreq) lpf12(20000 * cutoff, 0) * feedback
      string2 = (burst + string2) delay(1 / (noteFreq * 2)) lpf12(20000 * cutoff, 0) * feedback
      out = burst + (string1 + string2) * adsr(0, 0, 1, 0.1)
    `,{paramA:1,paramB:.99,octave:-1,mode:"strum"}),new f("strum bass",`
      out = noteFreq sine * ad(0.01, 5) * adsr(0, 0, 1, 0.1)
    `,{paramA:.2,paramB:1,octave:-2,mode:"strum"}),new f("rick and morty",`
      sound1 = noise bpf(0.2 sine * 800 + 1200, 1)
      sound2 = noise bpf(-(0.25 sine) * 800 + 1200, 1)
      ring = (sound1 + sound1 delay(2) + sound2) * 5.5 pwm norm * 0.5
      out = ring * adsr(0.01, 0, 1, 2)
    `),new f("pwm",`
      out = noteFreq pwm(slide lglide(0.05) norm scale(0.2, 0.8)) * adsr(0.05, 0, 1, 0.4)
    `),new f("pwm pencil",`
      out = noteFreq pwm(slide lglide(0.05) norm scale(0.2, 0.8)) * adsr(0.05, 0, 1, 0.4) * pressure
    `),new f("sine",`
      out = noteFreq sine * adsr(0.01, 0, 1, 0.3)
    `)];class ue{constructor(e,t){this.synth=e,this.channel=t,this.params=new Float32Array(new SharedArrayBuffer(512)),this.note=-1}noteOn(e,t){this.isOn&&this.noteOff(this.note,127),this.note=e,this.synth.sendToWorklet({command:"process midi message",data:ae(this.channel,e,t)})}noteOff(e,t){this.note=-1,this.synth.sendToWorklet({command:"process midi message",data:he(this.channel,e,t)})}get isOn(){return this.note!==-1}get freq(){return de(this.note)*Math.pow(2,this.params[0]/12)}}class U{constructor(e="pwm"){if(this.mode="mpe",this.worklet=null,this.voices=[],this.octave=0,this.analyzer=null,this.timeDomainData=null,this.lnf=220,this.patch=O.find(t=>t.name===e),!this.patch)throw new Error("unknown patch name! "+e);for(let t=0;t<pe;t++)this.voices.push(new ue(this,t))}init(){this.worklet=new AudioWorkletNode(q,"msynth"),this.sendToWorklet({command:"init",voiceParams:this.voices.map(t=>t.params.buffer)}),this.analyzer=q.createAnalyser(),this.analyzer.fftSize=2048;const e=this.analyzer.frequencyBinCount;this.timeDomainData=new Uint8Array(e),this.worklet.channelInterpretation="discrete",this.worklet.channelCount=2,this.worklet.channelCountMode="explicit",this.worklet.connect(this.analyzer).connect(q.destination),this.worklet.port.onmessage=t=>Be(t.data),this.loadPatch(this.patch)}getTimeDomainData(){return!this.analyzer||!this.timeDomainData?null:(this.analyzer.getByteTimeDomainData(this.timeDomainData),this.timeDomainData)}toggleMode(){this.mode=this.mode==="mpe"?"piano":this.mode==="piano"?"strum":"mpe"}sendToWorklet(e){var t;(t=this.worklet)==null||t.port.postMessage(e)}loadPatch(e){var t,i,o,r,l;this.patch=e,this.sendToWorklet({command:"load patch",code:e.code,mono:((t=e.options)==null?void 0:t.mono)??!1}),this.setParam(3,((i=e.options)==null?void 0:i.paramA)??0),this.setParam(4,((o=e.options)==null?void 0:o.paramB)??0),this.setParam(5,.2),this.octave=((r=e.options)==null?void 0:r.octave)??0,this.mode=((l=e.options)==null?void 0:l.mode)??"mpe"}grabVoice(){var i;if((i=this.patch.options)!=null&&i.mono)return this.voices[0];const e=[...b.values()],t=this.voices.findLast(o=>!e.some(r=>r.voice===o))??this.voices.at(-1);return this.voices.splice(this.voices.indexOf(t),1),this.voices.unshift(t),t}setParam(e,t){for(const i of this.voices)i.params[e]=t}getLowestNoteFreq(){let e=1/0;for(const t of this.voices)t.isOn&&t.freq<e&&(e=t.freq);return Number.isFinite(e)&&(this.lnf=e),this.lnf}}const y=new U("guitar"),c=new U("stranger things");let d=y;const me=47,fe=5,A=4;class we{constructor(e,t,i){this.col=e,this.row=t,this.noteName=i,this.isBeingPlayedBySequencer=!1}get note(){return me+12*d.octave+fe*(7-this.row)+this.col}get posX(){return p+this.col*h}get posY(){return p+this.row*m}contains(e,t){return this.posX<=e&&e<=this.posX+h&&this.posY<=t&&t<=this.posY+m}render(){if(s.beginPath(),s.lineWidth=3,s.strokeStyle="#eee",s.roundRect(this.posX,this.posY,h,m,A),s.stroke(),d.mode==="strum"&&this.col===12){s.beginPath(),s.fillStyle="#aaa",s.roundRect(this.posX,this.posY,h,m,A),s.fill();return}s.beginPath(),s.fillStyle=this.noteName===""?"#ccc":"#ddd",s.roundRect(this.posX,this.posY,h,m,A),s.fill(),d===c&&this.isBeingPlayedBySequencer&&(s.beginPath(),s.fillStyle=this.noteName===""?"#eee":"#bbb",s.roundRect(this.posX+20,this.posY+20,h-40,m-40,A),s.fill()),this.noteName!==""&&(s.beginPath(),s.font="14px sans-serif",s.fillStyle="#bbb",s.fillText(this.noteName,this.posX+4,this.posY+16),s.fill())}}const v=[],ge=["C","","D","","E","F","","G","","A","","B"];let H=0;for(let n=2;n<=7;n++){for(let e=0;e<=12;e++)v.push(new we(e,n,ge[(H+e)%12]));H+=7}const b=new Map;class ye{constructor(e,t,i,o,r){this.id=e,this.voice=t,this.x=0,this.y=0,this.glide=0,this.slide=0,this.pressure=0,this.move(i,o,r)}move(e,t,i){if(d.mode==="strum"){this.strumMove(e,t,i);return}const o=this.pad;this.pad=v.find(l=>{var a;return(d.mode==="piano"||l.row!==((a=this.pad)==null?void 0:a.row))&&l.contains(e,t)})??this.pad;const r=this.pad!==o;this.x=e,this.y=t,r&&(o&&this.voice.noteOff(o.note,127),this.quantizationOffset=d.mode==="piano"?0:(this.pad.posX+h/2-this.x)/h),this.pad&&this.updateParams(i),r&&this.pad&&this.voice.noteOn(this.pad.note,127)}updateParams(e){const t=this.pad.posX+h/2,i=this.pad.posY+m/2;this.glide=d.mode==="piano"?0:(this.x-t)/h,this.slide=D((i-this.y)/(m/2),-1,1),this.pressure=e,this.voice.params[0]=this.glide+this.quantizationOffset,this.voice.params[1]=this.slide,this.voice.params[2]=e}strumMove(e,t,i){const o=this.pad;this.pad=v.find(l=>l.contains(e,t))??this.pad;const r=this.pad!==o;if(this.pad){if(r&&this.pad.col===12){const l=d.voices.find(u=>u.channel===this.pad.row),a=this.pad.note;[...b.values()].some(u=>u.pad&&u.pad!==this.pad&&u.pad.row===this.pad.row)?(this.updateGlide(this.pad.row),l.noteOn(a,127)):l.noteOff(a,127);return}this.pad.col<12&&(this.x=e,this.y=t,this.updateGlide(this.pad.row))}}updateGlide(e){const t=v.find(a=>a.row===e&&a.col===12);let i=null;for(const a of[this,...b.values()])!a.pad||a.pad.row!==e||a.pad.col===12||(!i||a.x>i.x)&&(i=a);if(!i)return;let o=i.pad,r=Math.abs(o.posX+h/2-i.x);for(const a of v){if(a.row!==e||a.col===12)continue;const u=Math.abs(a.posX+h/2-i.x);u<r&&(o=a,r=u)}const l=d.voices.find(a=>a.channel===this.pad.row);l.params[0]=o.note-t.note}lift(){d.mode!=="strum"?this.voice.noteOff(this.pad.note,127):this.updateGlide(this.pad.row)}render(){if(this.pad)for(let e of v){if(e.col!==0)continue;const t=e.posX+h/2+(this.pad.note+this.quantizationOffset+this.glide-e.note)*h,i=e.posY+m/2-this.slide*(m/2),o=`rgba(100, 100, 100, ${this.pressure})`,r=e.row===this.pad.row;s.beginPath(),r?s.fillStyle=o:s.strokeStyle=o,s.arc(t,i,h/3,0,Math.PI*2),r?s.fill():s.stroke()}}}class x{constructor(e=null){this.thingAbove=e,this.pointer=null}get x(){if(this.thingAbove)return this.thingAbove.x;throw new Error("must override x if no thingAbove")}get y(){if(this.thingAbove)return this.thingAbove.y+this.thingAbove.h;throw new Error("must override y if no thingAbove")}get w(){var e;return((e=this.thingAbove)==null?void 0:e.w)??B}get h(){var e;return((e=this.thingAbove)==null?void 0:e.h)??F}contains(e,t){return this.x<=e&&e<=this.x+this.w&&this.y<=t&&t<=this.y+this.h}get backgroundColor(){return this.pointer?"#ccc":"#ddd"}get foregroundColor(){return this.pointer?"#fff":"#888"}render(e){s.beginPath(),s.lineWidth=3,s.strokeStyle="#eee",s.roundRect(this.x,this.y,this.w,this.h,A),s.stroke(),s.beginPath(),s.fillStyle=this.backgroundColor,s.roundRect(this.x,this.y,this.w,this.h,A),s.fill(),e&&this.renderLabel(e)}renderLabel(e){s.beginPath(),s.font=ce,s.fillStyle="#888",s.fillText(e,this.x+(this.w-s.measureText(e).width)/2,this.y+this.h/2),s.fill()}onPointerDown(e,t){}onPointerMove(e,t){}onPointerUp(e,t){}}class $ extends x{constructor(e,t,i){super(),this.synth=e,this.paramNum=t,this.name=i,this.value0=null,this.y0=null}get y(){return p}get w(){return B/2}get h(){return F*3}get backgroundColor(){return"#ddd"}render(){super.render(),s.beginPath(),s.fillStyle="#ccc",s.roundRect(this.x,this.y+this.h,this.w,-this.h*this.value,A),s.fill(),this.renderLabel(this.name)}get value(){var e,t;return((t=(e=this.synth)==null?void 0:e.voices[0])==null?void 0:t.params[this.paramNum])??0}set value(e){this.synth.setParam(this.paramNum,e)}onPointerDown(e,t){this.value0=this.value,this.y0=t}onPointerMove(e,t){const i=t-this.pointer.y0;this.value=D(this.value0-i/this.h,0,1)}}const W=new class extends ${get x(){return p}}(y,5,"vol 1"),ve=new class extends ${get x(){return W.x+W.w}}(c,5,"vol 2");class G extends x{constructor(e){super(),this.synth=e}render(){super.render(this.synth.patch.name)}onPointerDown(){const e=(O.indexOf(this.synth.patch)+1)%O.length;this.synth.loadPatch(O[e])}}class V extends x{constructor(e,t){super(t),this.synth=e}render(){super.render(this.synth.mode)}onPointerDown(){this.synth.toggleMode()}}class j extends x{constructor(e,t){super(t),this.synth=e,this.octave0=null}render(){super.render(`octave ${this.synth.octave}`)}onPointerDown(e,t){this.octave0=this.synth.octave}onPointerMove(e,t){const i=t-this.pointer.y0;this.synth.octave=D(Math.round(this.octave0-i/25),-3,3)}}class J extends x{constructor(e){super(),this.synth=e}get y(){return p}get w(){return B*1.5}get h(){return F*3}render(){super.render();const e=this.synth.getTimeDomainData();if(!e)return;const t=this.synth.getLowestNoteFreq(),i=C/t,o=Math.round(i*2);let r=0;for(let g=0;g<e.length-1;g++)if(e[g]<=128&&e[g+1]>128){r=g;break}s.lineWidth=1,s.strokeStyle=this.foregroundColor,s.beginPath();const l=Math.min(o,e.length-r),a=this.w/l;let u=this.x;for(let g=r;g<l;g++){if(u>this.x+this.w+10)debugger;const z=e[g]/128*this.h/2;g===r?s.moveTo(u,z):s.lineTo(u,z),u+=a}s.stroke()}}const S=new class extends G{get x(){return p+1.5*h}get y(){return p}}(y),K=new V(y,S),xe=new j(y,K),be=new class extends J{get x(){return S.x+S.w}}(y);class _ extends x{constructor(e,t,i){super(i),this.paramNum=e,this.name=t,this.value0=null,this.x0=null}get backgroundColor(){return"#ddd"}render(){super.render(),s.beginPath(),s.fillStyle="#ccc",s.roundRect(this.x,this.y,this.w*this.value,this.h,A),s.fill(),this.renderLabel(this.name)}get value(){var e;return((e=d==null?void 0:d.voices[0])==null?void 0:e.params[this.paramNum])??0}set value(e){d.setParam(this.paramNum,e)}onPointerDown(e,t){this.value0=this.value,this.x0=e}onPointerMove(e,t){const i=e-this.pointer.x0;this.value=D(this.value0+i/this.w,0,1)}}const Q=new class extends x{get x(){return p+h*5}get y(){return p}get w(){return B*2}render(){super.render(d===y?"\u2190 controlling synth 1":"controlling synth 2 \u2192")}onPointerDown(){d=d===y?c:y}},Z=new _(3,"param A",Q),Pe=new _(4,"param B",Z),X=new class extends G{get x(){return N.x-this.w}get y(){return p}}(c),ee=new V(c,X),ke=new j(c,ee),Ae=new class extends J{get x(){return X.x-this.w}}(c);let E=120;const N=new class extends x{constructor(){super(...arguments),this.tempo0=null}get x(){return innerWidth-p-this.w}get y(){return p}render(){super.render(`tempo ${E}`)}onPointerDown(n,e){this.tempo0=E}onPointerMove(n,e){const t=e-this.pointer.y0;E=D(Math.round(this.tempo0-t/10),10,200),c.sendToWorklet({command:"set tempo",value:E})}};let w=[],P,R=0;const te=new class extends x{render(){super.render(P==="playing"?`step ${R+1} / ${w.length}`:w.length===0?"record steps":`${w.length} steps`)}onPointerDown(){Y(),w=[],P="recording"}onPointerUp(){c.sendToWorklet({command:"load steps",steps:w}),w.length>0?ne():Y()}}(N),qe=new class extends x{render(){super.render(P==="recording"?"add rest":P==="playing"?"stop":"play")}onPointerDown(){P==="recording"?w.push([]):P==="playing"?Y():ne()}}(te);function ne(){w.length!==0&&(c.setParam(0,0),P="playing",R=0,c.sendToWorklet({command:"start sequencer"}))}function Y(){P="stopped",c.sendToWorklet({command:"stop sequencer"});for(const n of v)n.isBeingPlayedBySequencer=!1}const L=[W,ve,S,K,xe,be,Q,Z,Pe,X,ee,ke,Ae,N,te,qe];window.addEventListener("pointerdown",n=>{for(const e of L)e.contains(n.clientX,n.clientY)&&(e.onPointerDown(n.clientX,n.clientY),e.pointer={id:n.pointerId,x0:n.clientX,y0:n.clientY})}),window.addEventListener("pointermove",n=>{var e;for(const t of L)((e=t.pointer)==null?void 0:e.id)===n.pointerId&&t.onPointerMove(n.clientX,n.clientY)}),window.addEventListener("pointerup",n=>{var e;for(const t of L)((e=t.pointer)==null?void 0:e.id)===n.pointerId&&(t.onPointerUp(n.clientX,n.clientY),t.pointer=null)});function se(){s.clearRect(0,0,innerWidth,innerHeight);for(const e of L)e.render();for(const e of v)e.render();for(const e of b.values())e.render();s.font="16px sans-serif";const{width:n}=s.measureText(k);s.beginPath(),s.fillStyle="#00ff",s.fillText(k,innerWidth-n-20,innerHeight-20),s.fill(),requestAnimationFrame(se)}se();const q=new AudioContext({latencyHint:"balanced",sampleRate:C});let T="need initialization";function Me(){return T==="ready"?!0:(T==="need initialization"&&De(),!1)}async function De(){T==="need initialization"&&(T="initializing",k="initializing audio...",q.resume(),k="loading worklet...",await q.audioWorklet.addModule(re),y.init(),c.init(),c.sendToWorklet({command:"load steps",steps:w}),T="ready",k="ready!",await Te(2),k="")}function Be(n){switch(n.event){case"seq step":{n.action==="noteOn"&&(R=n.index);for(const e of w[n.index]||[])for(const t of v)t.note===e&&(t.isBeingPlayedBySequencer=n.action==="noteOn");break}case"log":{k=n.message;break}default:k="??? "+JSON.stringify(n);break}}window.addEventListener("pointerdown",()=>{(q.state==="suspended"||q.state==="interrupted")&&q.resume()}),window.addEventListener("pointerdown",async n=>{if(!Me())return;const e=[...b.values()].some(t=>!!t.pad);for(const t of v)if(t.contains(n.clientX,n.clientY)){P==="recording"&&d===c&&(e||w.push([]),w.at(-1).push(t.note)),b.set(n.pointerId,new ye(n.pointerId,d.grabVoice(),n.clientX,n.clientY,oe(n)));break}}),window.addEventListener("pointermove",n=>{const e=b.get(n.pointerId);e&&e.move(n.clientX,n.clientY,oe(n))}),window.addEventListener("pointerup",ie),window.addEventListener("pointercancel",ie);function ie(n){const e=b.get(n.pointerId);e&&(b.delete(n.pointerId),e.lift())}function oe(n){return n.pointerType==="pen"?n.pressure:n.pointerType==="touch"?Math.abs(Math.max(n.width,n.height)-20)/130:1}function Te(n){return new Promise(e=>setTimeout(e,n*1e3))}
